 \section{Introduction}

We  define a notion of entity-relationship (ER) model which in the tradition of Chen\cite{Chen1976} is sufficiently generic to encompass relational, hierarchical and purely logical  notions of data.
The system that we describe involves definition of types of particulars in terms of their relationships with other types, of which there are two kinds, those, such as represent numbers, character strings, booleans and so on, all of whose instances, we say, are universals and the remaining types, the definienda, those types all of whose instances are particulars. Binary many-one relationships which are functional in character are presented as the edges of a directed graph whose nodes comprise both the types of particulars and the types of universals. \footnote{There are pure conceptual structures and there are data structures. In the latter, relationships between entitites are represented by universal
referential values.}

If $u$ is a type all of whose instances are universals then we will refer to each binary many-one functional relationship $f: x \morph u$ as an \term{attribute} of $x$. In relational data modelling such functional relationships are presented as columns of tables. Similarly types all of whose instances are universals  are said to be \textit{attribute types} in entity relational modelling  (though called \textit{attributes} in Johnstone et al. \cite{Johnson2002ERA}); in the initial work by Chen such types were called \textit{value sets}; they are said to be \textit{domains} in relational data modelling theory. Types of particulars are said to be types of entities or \textit{entity types} in modern entity relationship modelling\footnote{In  his paper  introducing the entity-relationship model Chen explains that his model adopts the view that the real world consists of entities and relationships. He also introduces the  terms \textit{entity set} and \textit{relationship set} for the types of respective entity and relationship particulars. Later authors kept the terms entity and relationship, and the Chen philosophy, but changed the way that the terms were used. In this paper we use the later, post-Chen, terminology.} or sometimes, confusingly, just \textit{entities}  and are modelled as \textit{relational tables} in relational data modelling. For the purposes of the theory presented in this paper there is no loss if we assume a single set $\Veee$ of universals.  We will represent data specifications as directed graphs with some additional information; the nodes of the graph being types, and having a distinguished node $\veee$ representing the type of universals; from a mathematical point of view it is impossible to progress the theory too far without forming an opinion that a data specification is a presentation (i.e a sketch) of a category with some additional structure (as in Johnson and Roseburgh \cite{johnson2002REL}) or, meta-mathematically, that it is an axiomatisation of a theory of some kind. This is so but it must be emphasised that the presentation (i.e. the sketch) is vitally important to the goodness of the data specification for it is the primitives in the presentation that determine the units of storage or communication; removing redundancy from the presentation (or sketch) reduces redundancy in the data and this is one half of relational data theory's  normal form notion of goodness of a data schema (the other half being that the theory be optimally tightened to best fit the facts). 

Entity relationship modelling, and, for that matter, relational modelling too, are predicated on the assumption that the particulars described by data correspond uniquely to real world entities and that the data alone is sufficient to establish a 1-1 correspondence. There is thus an implicit assumption that the logical principle of identity of indiscernibles holds of the real world entities and, more specifically, that each type of real world entity has identifying relationships and attributes that distinguish it from  others of the type. In relational data modelling this set of identifying features is represented as a set of columns of the table and is called the primary key. In entity relationship modelling in the style of Barker an identifying feature may be either a relationship or an attribute.   

\subsection{New material}
\begin{lemma}
\llabel{intransitivefdsfactorthroughsingletonintransitivefds}
If a model $gmodel$ is well-formulated and \fd{\xn}{z} is an intransitive functional dependency then there exists a path $y$
such that \fd{\xn}{y} and \fd{y}{\xn} are functional dependencies and \fd{y}{z} is an intransitive functional dependency.
\end{lemma}

\begin{oldtt}
\begin{lemma}
\llabel{wellformulatedimpliessingletonmonosourceshaveinverses}
In a well-formulated model singleton mono-sources have inverses.
\commentary{not so}
\end{lemma}

\begin{lemma}
In a well-formulated model singleton intransitive fds are witnessed by paths.
\commentary{not so}
\end{lemma}
\end{oldtt}


\subsection{Directed Graphs}
Regarding directed graphs and reflecting a category theory mindset we will use terminology as follows:
\begin{itemize}
\item
 If $f: a \morph b$ in an edge of a directed graph $G$ then we will say that $a$ is the \term{domain} of $f$ and $b$ is the \term{codomain} of $f$.
\item
If $a$ and $b$ are nodes of a directed graph $G$ then a \term{path} through $G$ with domain $a$ and 
codomain $b$ of length $n$, where $n \geq 0$, we define to be  an n-tuple of  $n$ edges: $p_i: x_i \morph x_{i+1} $ in $G$ where $x_0=a$ and $x_n=b$. We shall write this n-tuple as $p_1 \circ p_2... \circ p_n$. 
We will use the same notation if any of the $p_i$ are edges rather than paths as we will not need distinguish  an edge from a singleton path along that edge. 
\item
If $a$ is a node of a directed graph $G$ then by a \term{source} at $a$ in $G$ we mean a non-empty set of paths in $G$ each with domain $a$.
\end{itemize}
\begin{figure}
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}ccp{2cm}c}
             & &         & \Rnode{b1}{b_1} \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} \\ [0.2cm]
\Rnode{a}{a} & &         &                 \\ [-0.2cm]						
             & &         &    \vdots       \\ [0.2cm]
             & &         & \Rnode{bn}{b_n} \\ 
\end{array}
$
\simplepatha{$p_1$}{a}{b1}
\simplepatha{$p_2$}{a}{b2}
\simplepathb{$p_n$}{a}{bn}
\end{center}
\caption{A source in a directed graph consists of any set of paths with a common domain. This figure illustrates a source $\set{\pn}$ at a node $a$.}
\label{sourceillustration}
\end{figure}

\subsection{Partial Functions}
If $A$ is a set and if $J= \setsuchthat{f_i}{ 1\leq i \leq n}$ is a finite set of partial functions, $f_i: A \rightarrow B_i$   for some sets $B_{i, 1 \leq i \leq n}$,  then the set of functions 
$J$ is said to be \term{jointly injective} iff for all $x,y \in A$ it is the case that  if  for each 
$f \in J$, $f(x)=f(y)$ then $x=y$. 
This  is equivalent to saying that  the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ be injective. Note that this also implies that the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ is invertible in the sense that there is a unique partial function $\tuple{f_1,...f_n}^{-1} : s_1 \times ... \times s_n \rightarrow s$ satisfying
\begin{enumerate} [(i)]
\item for all $x \in s$, $\tuple{f_1,...f_n}^{-1}(\tuple{f_1(x),...f_2(x) } ) = x$ and 
\item  if $y \in s_1 \times ... \times s_n $ and
$y \notin img(\tuple{f_1,...f_n})$ then $\tuple{f_1,...f_n}^{-1}(y)$ is undefined. 
\end{enumerate}

If $f: a \morph b$ is a partial function then we shall define the partial function $\bar{f}: a \morph a$ to be the identity function on the set $a$
restricted to the subset of all $x \in a$ such that $f(x)$ is defined\footnote{
This notation is introduced an a more general category theory setting by Cockett and Lack \cite{COCKETT2002}}. It follows that if $f: a \morph b$ and $g: a \morph c$ are partial functions
then $\bar{f} \circ \bar{g} = \bar{g} \circ \bar{f}$ and we also write this partial function as $\bar{f} \wedge \bar{g}$ since it represents the intersection
of the domains of definition of $f$ and $g$. Likewise if $f_i:a \morph b_i$ are partial functions for $1 \leq i \leq n$, for some $n$, then we write $\bigwedge\limits_{1 \leq i \leq n}{\bar{f_i}}$ for the intersection of the domains of definition of the $f_i$ i.e. for the composition
$\bar{f_1}\circ \bar{f_2} .../ \circ \bar{f_n}$.

We will have need of the following:
\begin{lemma}
\llabel{restrictionleftid}
If $f: a \morph b$ is a partial function then $\bar{f} \circ f = f$.
\end{lemma}

\begin{lemma}
\llabel{inequalityiffrestriction}
If $f: a \morph b$ and  $g: a \morph b$ are partial functions then $f \leq g$ iff $\bar{f}\circ g= f$.
\end{lemma}

\begin{lemma}
\llabel{tuplerestriction}
If $f_i: a \morph b_i$ are partial functions, for $1 \leq i \leq n$, for some $n$, then $\overline{\tuple{f_1,...f_n}}=\bigwedge\limits_{1 \leq i \leq n}{\bar{f_i}}$.
\end{lemma}

\begin{lemma}
\llabel{tupleprojection}
If $f_i: a \morph b_i$ are partial functions, for $1 \leq i \leq n$, for some $n$, and if 
$\proji{i} : \prod\limits_{1 \leq i \leq n}{b_i} \morph b_i$ is the i'th projection function 
then  $\tuple{f_1,...f_n} \circ \proji{i} = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq j \leq n}{ j \neq i}}{\bar{f_j}}\circ f_i$, and,
in particular, $\tuple{f_1,...f_n} \circ \proji{i}\leq f_i$ .
\end{lemma}


\section{Definition of ER model}

\begin{definition}
An \term{ER-schema} $S$ is a directed graph having the following additional structure:
\begin{enumerate} [(i)]
\item{a distinguished node $\veee$ for which there are no outgoing edges and which represents the type of universals, 
 the nodes of $\gmodel_S$ other than $\veee$ we say are entity types.} 

\item{a distinguished acyclic subset $I$ of edges, called the identifying edges, such that
for every node $a$ other than $\veee$ there is a non-empty set  of identifying edges with domain $a$.
 We denote by $I_a$ the non-empty set of identifying edges leaving an entity type $a$.}
\end{enumerate}
\end{definition}

If $\gmodel$ is an ER-model then the set $\attr{a}$ of attributes of an entity type $a$ is defined as the set of edges of $\gmodel_S$ that have 
domain $a$  and  codomain $\veee$.

\begin{definition}
\llabel{ERschemamapping}
If $\gmodel$ and  $\gmodel'$ are ER schemas then an \term{ER schema mapping} 
$\varphi : \gmodel \morph \gmodel'$ consists of a mapping $\varphi_N$ (abbreviated $\varphi$)from nodes of
$\gmodel$ to nodes of $\gmodel'$ 
that maps entity types to entity types and the node $\veee$ of $\gmodel$ to the distingished node
$\veee$ od $\gmodel'$ i.e. such that
\begin{itemize}
\item $\varphi(\veee)=\veee$ and for any $a$ if $\varphi(a)=(\veee)$ then
$a = \veee$
\end{itemize}

and a mapping $\varphi_P$ (also abbreviated $\varphi$) from 
paths of $\gmodel$ to paths of $\gmodel'$ such that
\begin{itemize}
\item $\varphi(\veee)=\veee$ and for any $a$, if $\varphi(a)=(\veee)$ then
$a = \veee$,
\item  if $p:a \morph b$ is a path in $\gmodel$ then $\varphi(p):\varphi(a) \morph \varphi(b)$ in $\gmodel'$,
\item the empty path at any node $a$ in $\gmodel$ is mapped to the empty path
on $\varphi(a)$ in $\gmodel'$,
\item if $p: a \morph b$ and $p': b \morph c$ are paths in $\gmodel$
then $\varphi(a \circ b) = \varphi(a) \circ \varphi(b)$ in $\gmodel'$.
\end{itemize}
\end{definition}

It follows from this definition that a schema mapping is determined by 
a mapping of entity types of $\gmodel$ to entity types of $\gmodel'$ and a mapping of edges of $\gmodel$ to paths of $\gmodel'$ subject to the constraint
that if $e:a \morph b$ is an edge in $\gmodel$ then the path $\varphi(e)$ in $\gmodel'$ has source $\varphi(a)$ and codomain $\varphi(b)$.
 
\begin{definition}
\noindent A \term{database instance}  of an ER schema $S$ is
a set of entities $E_x$ for each node $x$ of $S$ and 
a partial function $E_r : E_x \rightarrow E_y$ for each edge of the graph $r:x \rightarrow y$ 
such that $E_\veee=\Veee$
and such that 
for each node $x$ other than \veee, for each $e \in I_x$ the function $E_e$ is total and
the set of functions $\setsuchthat{E_e}{e \in I_x}$, is jointly injective.
\end{definition}

\noindent For any database instance $E$ we can  extend  the definition of
$E_f$, for edges $f$,  so that to every path $p$, $p: a \rightarrow b$,  we have defined a function $E_p: E_a \rightarrow E_b$. From the initial definition of $E_f$ that applies to 
edges the definition proceeds recursively as follows: 
\begin{enumerate} [(i)]
\item{
For each node $a$, $E_{\tuple{}}: E_a \rightarrow E_a$ is defined to be the identity function.
}
\item for and path $p_1 \circ p_2... \circ p_n: a \morph b$ in $\gmodel$ where $p_i: x_i \morph x_{i+1}$ are edges,
define $E_{p_1 \circ p_2... \circ p_n}$ to be the functional composition $E_{p_1} \circ E_{p_2}... \circ E_{p_n}$.
\end{enumerate}

We can extend this notation further and define $E$ on sources so that if 
$\tuple{p_1,...p_n}$ is a source at entity type $a$ in $\gmodel$ as depicted in figure \lref{sourceillustration} then in an instance E
define the function  $E_{\tuple{p_1,...p_n}}$  to be the function mapping each element $e$ 
of $E_a$ to the n-tuple
$\tuple{E_{p_1}(e),...E_{p_n}(e)} \in E_{b_1} \times E_{b_2} \times ... E_{b_n}$.

\begin{definition}
\noindent An \term{ER model} $\gmodel$ is an ER schema $\gmodel_S$ and a set of database instances of the schema $\gmodel_D$ called the set of
\term{defining instances} of the model. \\
\end{definition}

\subsection{Primary Key Paths}
\llabel{primarykeypath}
\begin{definition}
If $a$ is an entity type in an entity model $\gmodel$ then a \term{primary key path}
of $a$ is any path $p:a \morph v$ consisting entirely of identifying edges. 
\end{definition}

Denote the set of all primary key paths leaving an entity type $a$ in a model $\gmodel$ by 
$\pk{a}$.

\subsection{Path equivalence}
\llabel{equivalencedefinition}

\noindent If $r$ and $s$ are paths of a model $\gmodel$ both having domain $a$ and codomain $b$ then we will say $r \leq s$ iff in all defining instances E, for all entities $e \in E_a$, if $E_r(e)$ is defined then $E_s(e)$ is defined and $E_r(e)=E_s(e)$. \\

\noindent If $r$ and $s$ are paths both having source $a$ and destination $b$ then we will say $r \simeq s$ iff $r \leq s$ and $s \leq r$. \\

\noindent With these definitions,  the (meta-relationship) $\leq$ is a partial order on the classes of equivalent paths of a model $\gmodel$. \\

\noindent For paths $r$ and $s$ we define $r < s$ to be equivalent to $r \leq s$ and not $r \simeq s$. \\

\subsection{Equivalence of sets of paths}
\begin{definition}
If $\gmodel$ is a model and if $P$ and $P'$ are sets of paths in $\gmodel$ then say that
$P \simeq P'$ in $\gmodel$ iff
\begin{enumerate}
\item for all $p \in P$ there exists $p' \in P'$ such that $p \simeq p'$ in $\gmodel$,
\item for all $p' \in P'$ there exists $p \in P$ such that $p \simeq p'$ in $\gmodel$.
\end{enumerate} 
\end{definition}

If $P$ is a set of paths of an ER model $\gmodel$ and $\varphi : \gmodel \morph \gmodel'$ is an ER model mapping then we denote by $\varphi(P)$ the set of paths
$\setsuchthat{\varphi(p)}{p \in P}$.

\subsection{ER Model Mappping}

\begin{definition}
\llabel{ERmodelmapping}
If $\gmodel$ and  $\gmodel'$ are ER models then an \term{ER model mapping}
$\varphi : \gmodel \morph \gmodel'$ consists of an ER schema mapping $\varphi$ from $\gmodel$ and  $\gmodel'$ that satisfies
\begin{itemize}
\item for every entity type $a$ in $\gmodel$, $\varphi(\pk{a}) \simeq \pk[\gmodel']{\varphi(a)}$
in $\gmodel'$,
\item  for each defining instance $E'$  of $\gmodel'$ there is a defining instance $E$ of $\gmodel$ such that
\begin{enumerate}
\item for each entity type $a$ of $\gmodel$, $E_a = E'_{\phi(a)}$,
\item for each edge $e:a \morph b$ of $\gmodel$, $E_e = E'_{\varphi(e)}$.
\end{enumerate} 
\end{itemize}
\end{definition}

\begin{lemma}
\llabel{mappingrespectsequivalence}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if $p$ and $q$ are paths of $\gmodel$ such that $p \simeq q$ in $\gmodel$ then $\varphi(p) \simeq \varphi(q)$ in $\gmodel'$. If $P$ and $Q$ are sets of paths and $P \simeq Q$ then $\varphi(P) \simeq \varphi(Q)$.
\end{lemma}
\begin{proof}
To show that $\varphi(p) \simeq \varphi(q)$ in $\gmodel'$ we need show that for every model $E'$ of $\gmodel'$, $E'_p=E'_q$. But for each such $E'$ there exists a model $E$ of $\gmodel$ such that $E'_p=E_p$ and $E'_q=E_q$ and so the result follows since because since $p\simeq q$ in $\gmodel$, $E_p=E_q$.
It follows on from the definition of equivalence for sets of paths $P$ and $Q$ that $\varphi(P) \simeq \varphi(Q)$ if $P \simeq Q$.
\end{proof}

\subsection{ER Model Isomorphism}

\begin{definition}
A ER model mapping $\varphi: \gmodel \morph \gmodel'$ is said to be an isomorphism
and the models $\gmodel$ and $\gmodel'$ are said to be isomorphic iff there is a ER model mapping $\psi: \gmodel' \morph \gmodel$ such that
\begin{enumerate}[(i)]
\item for each entity type $a$ of $\gmodel$, $\psi(\varphi(a))=a$,
\item for each entity type $a'$ of $\gmodel'$, $\varphi(\psi(a'))=a'$,
\item for each path $p: a \morph b$ of $\gmodel$, $\psi(\varphi(p)) \simeq p$,
\item for each path $p':a' \morph b'$ of $\gmodel'$, $\varphi(\psi(p')) \simeq p'$.
\end{enumerate}
\end{definition}

\begin{lemma}
\llabel{isoinverseiso}
If $\varphi: \gmodel \morph \gmodel'$ is an isomorphism of ER models then
$\varphi^{-1}: \gmodel' \morph \gmodel$ is an isomorphism of ER models also and
for each entity type $a$ of $\gmodel$, $\varphi^{-1}(\pk[\gmodel']{\varphi(a)}\simeq\pk{a}$.
\end{lemma}
\begin{proof}
tbd
\end{proof}

\begin{lemma}
\llabel{notusedkeyreflectionuptoeqivalence} 
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi$ is an ER model isomorphism $\varphi: \gmodel \morph \gmodel'$ then if $p:a \morph \veee$ in $\gmodel$ and $\varphi(p) :\varphi(a) \morph \veee$ is a primary key path in $\gmodel'$ then $p$ is equivalent to a primary key path in $\gmodel$.
\end{lemma}

In section \lref{definitionofrelational} we characterise those ER models which correspond to relational schemas and elsewhere\footnote{in the future} those that correspond to hierarchical schemas. 
We can paraphrase and say that an ER model is relational or hierarchical, in a certain way,  providing it has a sufficiency of referential attributes (foreign keys) for the implementation  of non-compositional relationships. It follows from the definitions that we give that an ER model which doesn't have sufficient 
referential attributes can be extended to one that does by repeated use of the construction indicated in the following definition.
\begin{definition}
If $\gmodel$ is an ER model and if $p:a \morph b$ is a path in $\gmodel$ then define the ER model $\gmodel + \qq{p}$ to be the model whose schema is the schema of $\gmodel$ extended by a single edge with domain $a$ and codomain $b$, denoted $\qq{p}$, and with defining instances corresponding to the defining instances of $\gmodel$ extended to the schema of $\gmodel + \qq{p}$ by defining for each such defining instance $E$, $E_{\qq{p}}=E_p$.
\end{definition} 


The following lemma is straightforward:
\begin{lemma}
If $\gmodel$ is an ER model and if $p:a \morph b$ is a path in $\gmodel$ then
there is an inclusion  $\mathcal{I}$ of the schema of $\gmodel$ in $\gmodel + \qq{p}$. This inclusion is an ER model mapping and is an isomorphism. 
\end{lemma}
\begin{proof}
The inverse mapping $\mathcal{R}$ simply replaces any instances of the edge $\qq{p}$ by the path $p$. The result follows easily and uses the observation that in $\gmodel + \qq{p}$, $p \simeq e$.
\end{proof}


\subsection{Jointly Injective Sets of Functions}
\begin{lemma}
\llabel{jointlyinjectivecomposition}
If $A$ is a set and if $I$  is a jointly injective set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective.
\end{lemma}
\begin{proof}

\end{proof}

\begin{lemma}
\llabel{jointlyinjectivefactorisation}
If $A$ is a set and if $I$  a set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then if the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective then the
set $I$ is jointly injective.
\end{lemma}
\begin{proof}
Suppose $x_1,x_2 \in A$ and that for all $f \in I$, $f(x_1)=f(x_2)$. We need show that $x_1=x_2$.
Because $(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective
it suffices to show that 
\begin{enumerate}[(i)]
\item
for all $f \in I \backslash \set{F}$, $f(x_1)=f(x_2)$, 
\item that for all $f \in \setsuchthat{F \circ G}{G \in J}$, $f(x_1)=f(x_2)$
\end{enumerate}
(i) follows directly from the initial assumption. 
(ii) follows because for such an $f$, 
\begin{align*}
f(x_1)&=G(F(x_1)) & & \\
      &=G(F(x_2)) & & \mbox{from the initial assumption since }F \in I \\
			&=f(x_2). & &
\end{align*}
\end{proof}

\subsection{Mono Sources}

The following definition generalises that of super key in the relational model:
\begin{definition}
A source $P$  at an entity type $a$ within a model $\gmodel$ is said to be a \term{mono-source} at entity type $a$ iff each path $p \in P$ has domain $a$ and  in all defining instances E, 
(i) the function $E_p$ is total, for each $p \in P$, and (ii) the set of functions
$\setsuchthat{E_p}{p\in P}$ is jointly injective.
\end{definition}



From the definition of ER model it follows that the set of outgoing edges of an entity type 
$a$ in a model $\gmodel$ is a mono-source. Note also that it follows from this definition that for each entity type $a$ the set containing just
the empty path $\tuple{}$ considered as a path $\tuple{}_a$, leaving $a$, is a mono-source.  
\begin{definition}
A mono source $P$ is said to be a \term{leaf mono-source} iff for path $p \in P$, $p$ has destination $\veee$.
\end{definition}




\subsubsection{Composing mono-sources}

In any directed graph a source $i$ at $a$ that includes a path $f:a \morph b$ can be composed with a source $j$ at $b$ by taking the union of paths in $i$ other than $f$, which we shall denote $i\backslash \set{f}$, and the set $\setsuchthat{f \circ g}{g \in j}$ as illustrated here :

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{1.5cm}ccp{1.5cm}ccp{1.25cm}c}
             & &         & \dotnode[dotsize=1pt]{b1} & &        &                              && \pnode{bracehigh}  \\ [0.3cm]
						 & &         & \dotnode[dotsize=1pt]{b2} & &        &                                \\ [0.3cm]
\Rnode{a}{a} & & \vdots  &                           & &        &                                \\ [0.02cm]
						 & &         &                           & &        & \dotnode[dotsize=1pt]{x1}      \\ [0.1cm]
             & &         & \Rnode{b}{b}              & & \vdots &                                \\ [0.1cm]
             & &         &                           & &        & \dotnode[dotsize=1pt]{xn}   && \pnode{bracelow}   \\ [0.5cm]
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){i}	
	&  &         & 
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){j} & & \\
\end{array}
$
\psbrace[rot=0, nodesepA=10pt, braceWidth=1pt, braceWidthInner=3pt, ,ref=lC](bracelow)(bracehigh)
{$(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$}
\simplepatha{}{b}{x1}
\simplepatha{}{b}{xn}
\simplepatha{}{a}{b1}
\simplepatha{}{a}{b2}
%\simplepatha{}{a}{bn}
\simplepathb{$f$}{a}{b}
\end{center}
.

In the next lemma we show that if $j$ is a mono-source then the above composition of $i$ with $j$ through $f$ is a mono-source iff $i$ is a mono-source.

\begin{lemma}
\llabel{identifyingsetdeduction}

In a model $\gmodel$, if $i$ is a source with domain $a$,
if $f \in i$, $f: a \morph b$, and if $j$ is a mono-source with domain $b$ then 
$i$ is a mono-source iff $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source.
\end{lemma}
\begin{proof}
First note that from the definition of database instance it follows that 
\begin{equation}
\label{eequivalentsets}
\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}
= \setsuchthat{E_e}{e \in i} \backslash \set{E_f} \cup \setsuchthat{E_f \circ E_g}{g \in j}
\end{equation}

We can show that if $i$ is a mono-source 
then $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source
by showing that for any instance $E$ of $\gmodel$ the family of functions 
$\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}$
is jointly injective. Because of (\ref{eequivalentsets}) this follows by applying lemma \lref{jointlyinjectivecomposition} with $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$.

\textit{Vice-versa}, we can show that if $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source then $i$ is a mono-source by applying lemma \lref{jointlyinjectivefactorisation} 
with, as above, $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$.
\end{proof}



\subsubsection{Primary Key Paths }

From the definition of ER model we have specified in the schema of each ER model $\gmodel$, for each entity type $a$ of $\gmodel$ a set of outgoing edges denoted $I_a$ specified as a mono-source in $\gmodel$. From lemma \lref{identifyingsetdeduction} it follows that any source arrived at by repeated composition of these given mono-sources, those of the form $I_a$, for $a$ an entity type of $\gmodel$, is itself a mono-source in $\gmodel$. 
Denote by $\bar{I}$ the set  of all such mono-sources and denote by $\bar{I}_a$ the subset of $\bar{I}$ comprising all mono-sources in $\bar{I}$ with domain $a$.\commentary{\newt{Consider that $\set{\tuple{}_a}$ might} \newt{ be a member of $\bar{I}_a$}}

From this definition it follows that $\pk{a} \in \bar{I_a}$ and from this we get the following corollary.

primarykeycorallary
\begin{corollary}
\llabel{primarykeycorallary}
If $\gmodel$ is an entity model then the set $\pk{a}$of all primary key paths 
with domain entity type $a$ is a mono-source.
\end{corollary}

factoringprimarykeypath
\begin{observation}
\llabel{factoringprimarykeypath}
If $Q \in \bar{I_a}$ and if $p$ is a primary key path at $a$ then for some node $b$ there exists $q \in Q$, $q: a \morph b$, and there exists 
a primary key path $q'$, $q': b \morph \veee$,  such that $q \circ q' = p$. 
Note that it may be that $p \in Q$ in which case $q$ will simply be the empty path $\tuple{}:a \morph a$.
\end{observation}

\subsubsection{Primary Mono Sources and Minimality Condition}
\llabel{minimalitycondition}

\begin{definition}
If $P$ and $Q$ are sets of paths of model $\gmodel$ then say that the set of paths $P$ 
\term{is representative of} $Q$ 
iff $P \simeq Q$ and no proper subset of $P$ is equivalent to $Q$. 
\end{definition}

We can give another equivalent definition. First define
a set of paths $P$ to be \term{representative} iff for all $p,p' \in P$,
$p \simeq p'$ implies $p=p'$. It is easy to see that the following is an equivalent definition of one set of paths representing another:

\begin{definition}
If $P$ and $Q$ are sets of paths of a model $\gmodel$ then 
say that the set of paths $P$ \term{is representative of} $Q$ iff $P \simeq Q$ and $P$ is representative. 
\end{definition}

\begin{definition}
If $Q \in \bar{I}_a$ and $Q'$ is representative of $Q$ then $Q'$ is said to be
a \term{primary mono source} at $a$. If in addition $Q'$ is leaf i.e. if the codomain of each $q \in Q'$ is $\veee$ then say that $Q'$ is a 
\term{leaf primary mono-source}.
\end{definition}

\begin{lemma}
\llabel{leafprimarymonosourcerepresentativeofpka}
If $\gmodel$ is an ER model and if $Q$ is a leaf primary mono-source with domain $a$, for some entity type $a$, then $Q$ is representative of $\pk{a}$.
\end{lemma}
\begin{proof}
By definition, since $Q$ is a leaf primary mono-source with domain $a$ then it is representative of some $Q' \in \bar{I}_a$. Because
$Q$ is leaf then $Q'$ is leaf also. But the only leaf monos-ource in $\bar{I}_a$ is $\pk{a}$. Therefore $Q'=\pk{a}$ and $Q$, therefore.
is representative of  $\pk{a}$.
\end{proof}


\begin{lemma}
\llabel{primarykeypathfactorsthroughprimarymonosource}
If for some $m \geq 1$, $\qmtuple$ is a primary mono-source at $b$ such that for each $j$, $1 \leq j \leq m$, $q_j : b \morph b_j$,
and if  $p$ is a primary key path such that $p: b \morph \veee$   
then there exists $j$, $1 \leq j \leq m$ and there exists $p'$, $p': b_j \morph \veee$ such that $p \simeq q_j \circ p'$.
Note that it may be that for some $j$, $1 \leq j \leq m$, $b_j = \veee$ and $p \simeq q_j$.
Note further that if $\set{\qm}$ is a leaf primary mono-source then for some $j$, $1 \leq j \leq m$, $p \simeq q_j$.
\end{lemma}
\begin{proof}
Follows from observation \lref{factoringprimarykeypath}.
\end{proof}

\begin{definition}
A model $\gmodel$ satisfies \term{the minimality condition} iff for every entity type $a$,
\begin{enumerate}
\item the set $I_a$ is a minimum mono-source i.e. there is no proper subset which is a mono-source,
\item whenever a set of paths $P$ is a leaf primary mono-source of $\gmodel$ then no proper subset of $P$ is a mono-source.
\end{enumerate}
\end{definition}

\begin{conjecture}
A model $\gmodel$ satisfies \term{the minimality condition} iff 
for every entity type $a$ of $\gmodel$ and for every (mono-)source $Q \in \bar{I_a}$, if $Q'$ is representative
of  $Q$, then no proper subset of $Q'$ is a mono-source. \commentary{I may have been here before and found it to be false.}
\end{conjecture}

\subsubsection{Mapping, Isomorphisms and Mono Sources}

\begin{lemma}
\llabel{monosourceequivalence}
If  $P$ and $Q$ are sources at some object $a$ in an ER model $\gmodel$ and if $P \simeq Q$  then   $P$ is a mono-source in $\gmodel$ iff $Q$ is a mono-source in $\gmodel$.  Further $P$ is a leaf mono-source iff $Q$ is a leaf mono-source. Further, if $P$ and $Q$ are both representative then $P$ is a primary mono-source iff $Q$ is a primary mono-source.
\end{lemma}
\begin{proof}
It follows from the definition of set equivalence that if $P$ and $Q$ are sets of paths in a model $\gmodel$ and if $P \simeq Q$ in $\gmodel$ then in each defining instance $E$ of $\gmodel$, the set of functions $\setsuchthat{E_p}{p \in P}$ is equal to the set of functions $\setsuchthat{E_q}{q \in Q}$ since for
paths $p$ and $q$ such that $p \simeq q$, $E_p=E_q$. Therefore if $P$ and $Q$ are sources and $P \simeq Q$ then $P$ is a mono-source iff $Q$ is a mono-source.


That $P$ is leaf  iff $Q$ is a leaf 
follows because $p \simeq q$ implies that the codomain of $p$ is equal to the codomain of $q$.

It follows that if $P$ and $Q$ are representative then $P$ is a primary mono-source iff $Q$ is  primary mono-source  because  $\simeq$ is an equivalence relation and therefore $P \simeq \pk{a}$ iff $Q \simeq \pk{a}$.
\end{proof}

\begin{lemma}
\llabel{mappingspreservemonosources}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if $P$ is a mono-source in $\gmodel$ then  
$\varphi(P)$ i.e. the set $\setsuchthat{\phip}{p\in P}$, is a mono-source in $\gmodel'$. 
Further if $P$ a leaf mono-source in $\gmodel$ then $\varphi(P)$,  is a leaf mono source in $\gmodel'$ .
\end{lemma}
\begin{proof}
To show that $\varphi(P)$ is a mono-source in $\gmodel'$ given that $P$ is a mono-source in $\gmodel$ we need show that for every model $E'$ of $\gmodel'$, 
each function $E'_{\phip}$,  where $p \in P$, is total and that the set
$\setsuchthat{E'_{\phip}}{p \in P}$ is jointly injective. But for each such $E'$ there exists a model $E$ of $\gmodel$ such that $E'_{\phip}=E_{p}$  and so the result follows  since $P$ is a mono-source in $\gmodel$ and therefore for each $p \in P$, $E_p$ is total and the set $\setsuchthat{E_p}{p\in P}$ is jointly injective.

That $P$ is leaf implies $\varphi(P)$ is leaf follows because for each $p \in P$, if the codomain of $p$ is 
$\veee$ in $\gmodel$ then it follows from the definition of $\varphi$ being a mapping that the codomin of $\phip$ is  $\veee$ in $\gmodel'$. 
\end{proof}

\begin{lemma}
\llabel{isospreserverepresentativesets}
If $\varphi: \gmodel \morph \gmodel'$ is a isomorphism of ER models and
if $P$ is a  set of paths in $\gmodel$ that is representative then the set of paths $\varphi(P)$ in $\gmodel'$ is representative. 
\end{lemma}
\begin{proof}
Assume such an isomorphism. To show that if $P$ is representative then $\varphi(P)$ is suppose $P$ is representative and that for some $p,p' \in P$,  $\varphi(p) \simeq \varphi(p')$ is $\gmodel'$.  Since $\varphi$ is an isomorphism
it follows that $\varphi^{-1}(\varphi(p)) \simeq \varphi^{-1}(\varphi(p'))$ in $\gmodel$ and therefore $p \simeq p'$ in
$\gmodel$. Now since $P$ is representative we can conclude that $p=p'$ and therefore that $\varphi(p)=\varphi(p')$.
\end{proof}

\begin{definition}
If $\varphi: \gmodel \morph \gmodel'$ is a isomorphism of ER models then define $\varphi$ to be injective iff
it is injective as a mapping of paths i.e. iff  for all paths $p,p'$ of $\gmodel$, $\varphi(p)=\varphi(p')$ implies $p=p'$.
\end{definition}


\begin{lemma}
\llabel{injectiveisosreflectrepresentativesets}
If $\varphi: \gmodel \morph \gmodel'$ is an injective isomorphism of ER models and
if $P$ is a  set of paths in $\gmodel$ then if the set of paths $\varphi(P)$ of $\gmodel'$ is representative 
 then the set of paths $P$ of $\gmodel$ is representative. 
\end{lemma}
\begin{proof}
Assume such an injective isomorphism $\varphi$. Suppose such a set $P$ in $\gmodel$ and suppose that $\varphi(P)$ is representative in $\gmodel'$.  Suppose that  for some $p,p' \in P$, $p \simeq p'$. Since $\varphi$ is an isomorphism it follows that $\varphi(p) \simeq \varphi(p')$ in $\gmodel'$ and then since $\varphi(P)$ is assumed to be representative 
that $\varphi(p) = \varphi(p')$ in $\gmodel'$
 from which we can deduce that $p=p'$ in $\gmodel$ since $\varphi$ is assumed to be injective. 
\end{proof}

\begin{lemma}
\llabel{isospreserveandreflectmonosources}
If $\varphi: \gmodel \morph \gmodel'$ is a isomorphism of ER models and
if $P$ is a source in $\gmodel$ then 
\begin{enumerate}[(i)]
\item
$P$ is a mono-source in $\gmodel$ iff  $\varphi(P)$ is a mono-source in $\gmodel'$. 
\item
Further  $P$ is a leaf mono-source in $\gmodel$ iff $\varphi(P)$ is a leaf mono source in $\gmodel'$ and 
\item
$P$ is a leaf primary mono-source in $\gmodel$ implies  $\varphi(P)$ is a leaf primary mono source in $\gmodel'$,
\item
If $\varphi$ is injective then
if $\varphi(P)$ is a leaf primary mono source in $\gmodel'$ then $P$ is a leaf primary mono-source in $\gmodel$
\end{enumerate}
\end{lemma}
\begin{proof}

\begin{enumerate} [(i)]
\item
That $P$ is a mono-source implies $\varphi(P)$ was proved
in lemma \lref{mappingspreservemonosources}. For the reverse implication use 
lemma \lref{mappingspreservemonosources} applied to the inverse mapping $\varphi^{-1}$
and then use lemma \lref{monosourceequivalence} since $\varphi^{-1}(P) \simeq P$.
\item
trivial
\item
get this from lemma \lref{isospreserverepresentativesets} 
\item
follows from lemma \lref{injectiveisosreflectrepresentativesets}
\end{enumerate}

\end{proof}

\begin{lemma}
\llabel{representativecontainmentlemma}
In any ER model $\gmodel$ if $Q$ is a representative sets of paths and if $P \subseteq Q$ and $P \simeq Q$ then $P=Q$.
\end{lemma}
\begin{proof}
Follows immediately from the definition of representative.
\end{proof}


\begin{lemma}
\llabel{isospreserveandreflectminimality}
If $\varphi: \gmodel \morph \gmodel'$ is an injective isomorphism of ER models then $\gmodel$ satisfies the minimality condition iff $\gmodel'$ does.
\end{lemma}
\begin{proof}
Suppose such an injective isomorphism $\varphi$. \\

First suppose that $\gmodel$ satisifes the minimality condition that no leaf primary mono-sources have proper subsets which are mono-sources. 
To show that $\gmodel'$ has the minimality condition let $Q$ be a leaf-primary mono-source in $\gmodel'$. We need show that if $Q' \subseteq Q$ and $Q'$ is a mono-source then $Q'=Q$. Assume such a $Q$ and $Q'$. It follows that $\varphi^{-1}(Q') \subseteq \varphi^{-1} (Q)$ and, by lemma \lref{isospreserveandreflectmonosources}, that $\varphi^{-1}(Q)$
is a leaf primary mono-source and that $\varphi^{-1}(Q')$ is a mono-source. Since $\gmodel'$ is assumed to have the minimality condition then we have that
$\varphi^{-1}(Q') = \varphi^{-1} (Q)$. From this it follows that  $Q' \simeq \varphi(\varphi^{-1}(Q')) = \varphi(\varphi^{-1}(Q)) \simeq Q$ and so we have that both $Q' \subset Q$ and $Q' \simeq Q$ and, since $Q$ is representative, this implies, by lemma \lref{representativecontainmentlemma}, that $Q'=Q$ as required. \\

For the reverse implication consider that $\gmodel'$ satisfies the minimality condition. We are required to show that $\gmodel$ has the minimality condition for which we are required to show that if  $P$ is a leaf primary mono-source in $\gmodel$ and if $P' \subseteq P$ and 
 $P'$ is a mono-source in $\gmodel$ then $P'=P$.  Suppose then such a $P$ and $P'$. Since $P' \subseteq P$ then $\varphi(P') \subseteq \varphi(P)$. 
By lemma \lref{isospreserveandreflectmonosources} $\varphi(P)$ is a leaf primary mono-source and, by the same lemma,  $\varphi(P')$ is a mono-source.
Since $\gmodel'$ satisfies the minimality condition it now follows that $\varphi(P') = \varphi(P)$ from which  it follows since $\varphi$ is assumed to be injective
that $P'=P$, as required.\\
\end{proof}

\begin{definition}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models then
say that $\varphi$ \term{reflects primary mono-sources} 
iff for all sources $P$ of  $\gmodel$ if
$\varphi(P)$ is a primary mono-source in $\gmodel'$ then $P$ is a primary mono-source in $\gmodel$.
\end{definition}

\begin{lemma}
\commentary{Unused} %\llabel{anisoreflectsprimariesthenitsinversepreservesthem} 
If $\varphi: \gmodel \morph \gmodel'$ is an isomorphism of ER models  then
$\varphi$ reflects primary mono-sources iff $\varphi^{-1}$ preserves primary mono-sources.
\end{lemma}
\begin{proof}
Suppose $\varphi$ reflects primary mono-sources. To show that $\varphi^{-1}$ preserves primary mono-sources suppose
 $P'$ is a primary mono-source in $\gmodel'$. By definition, then,  $P'$ is representable  and therefore $\varphi^{-1}(\varphi(P))$ is representatable 
by lemma \lref{isospreserverepresentativesets}.  Now it follows that  $\varphi(\varphi^{-1}(P'))$ will be a primary mono-source by lemma \lref{monosourceequivalence} since $\varphi(\varphi^{-1}(P')) \simeq P'$ in $\gmodel'$ as $\varphi$ is an isomorphism. 
\end{proof}

\begin{lemma}
\commentary{Unused} %\llabel{anisoreflectsprimariesthenitsinversepreservesthem} 
If $\varphi: \gmodel \morph \gmodel'$ is an injective isomorphism of ER models  then
if $\varphi^{-1}$ preserves primary mono-sources
then $\varphi$ reflects primary mono-sources.
\end{lemma}
\begin{proof}
Suppose $\varphi^{-1}$ preserves primary mono-sources then $\varphi$ reflects primary mono-sources because
if $P$ is a source in $\gmodel$ and if $\varphi(P)$ is a primary mono-source in $\gmodel'$ then
by definition $\varphi(P)$ is representative in $\gmodel'$ and therefore by lemma \lref{injectiveisosreflectrepresentativesets} 
$P$ is representative in $\gmodel$ and by lemma \lref{isospreserverepresentativesets} $\varphi^{-1}(\varphi(P))$ is representative in $\gmodel$.
Now by lemma \lref{monosourceequivalence} it follows that $P$ will be primary mono-source in $\gmodel$ because, from the definition of
isomorphism,  $P \simeq \varphi^{-1}(\varphi(P))$ and $\varphi^{-1}(\varphi(P))$ is a primary mono-source since we have assumed
that  $\varphi^{-1}$ preserves primary mono-sources. 
\end{proof}


\subsubsection{Primarily Keyed Models}

One of the characteristics of a relational model is that each of the identifying features of a table is a column
and this translates into our unified framework as each identifying edge of each entity type being an attribute i.e. 
an edge with codomain $\veee$. This leads to this definition: 
\begin{definition}
Say that a model is \term{primarily keyed} iff all identifying edges 
have codomain $\veee$.
\end{definition}
To reach the goal of showing that to certain ER models there correspond isomorphic relational model we require the following:
\begin{lemma}
If $\gmodel$ is an ER model then it can be extended to a model $P(\gmodel)$
which is primarily keyed. If $\gmodel$ satisfies the minimality condition then the
extended model $P(\gmodel)$ satisfies the  condition that each set $I_a$ has no proper subsets which are mono-sources. 
\end{lemma}
\begin{proof}
For each entity type $a$ we extend $\gmodel$ by edges $\qq{p}$, where each edge \commentary{Can we improve this description?}
$\qq{p}$ corresponds to a distinct primary key path $p$ from $a$ to $\veee$
and in the extended model $\gmodel'$ by corollary \lref{primarykeycorallary} 
we can define the identifying set $I'_a$ at $a$ by choosing a set $P_a$ which is representative of the set of all primary key paths from $a$ to $\veee$.
\end{proof}

\subsection{Referential Inclusion Dependencies}
\llabel{referentialinclusiondependency}

\begin{definition}
If $\gmodel$ is an entity model, 
if $a$ and $b$ are entity types of  $\gmodel$ and  if $\set{q_1,...q_n}$
is a mono-source,
if \fntuple is a tuple of outgoing paths from entity type $a$  
so that we have the following diagram of paths in $\gmodel$
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}ccp{2cm}c}
             & &         & \Rnode{b1}{b_1} &&               \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} &&               \\ [0.2cm]
\Rnode{a}{a} & &         &                 &&  \Rnode{b}{b} \\ [-0.2cm]						
             & &         &    \vdots       &&               \\ [0.2cm]
             & &         & \Rnode{bn}{b_n} &&               \\ 
\end{array}
$
\simplepatha{$f_1$}{a}{b1}
\simplepatha{$f_2$}{a}{b2}
\simplepathb{$f_n$}{a}{bn}
\simplepathb{$q_1$}{b}{b1}
\simplepathb{$q_2$}{b}{b2}
\simplepatha{$q_n$}{b}{bn}
\end{center}
then say that $a$ represented by $\fntuple$ 
has a \term{referential inclusion dependency} with $b$ represented by $\qntuple$, and for which we shall summarily write:
$$
\incd{a}{f_1,...f_n}{b}{q_1,...q_n},
$$
iff in all instances $E$ of $\gmodel$,
$img(E_{\fntuple}) \subseteq img(E_{\qntuple})$. 
\end{definition}

Note that it follows from this definition that for any entity type $a$ there is a trivial referential inclusion dependency $
\incd{a}{\tuple{}_a}{a}{\tuple{}_a}$

\begin{definition}
Define a \term{primary referential inclusion dependency} to be a
referential inclusion dependency $\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$
such that $\set{q_1,...q_n}$ is a primary mono-source.
\end{definition}

\begin{definition} 
A referential inclusion dependency $\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$ is said to be a \term{leaf
referential inclusion dependency} iff $\set{q_1,...q_n}$ is a leaf mono source.
\end{definition}

\begin{lemma}
\llabel{mappingspreservereferentialincds}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if 
\begin{equation}
\label{sourcerefincd}
\incd{a}{\fn}{b}{\qn}
\end{equation}
is a referential inclusion dependency in $\gmodel$ then  
\begin{equation}
\label{targetrefincd}
\incd{\phia}{\phifn}{\phib}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$. 

%Further if (\ref{sourcerefincd}) is a leaf primary mono source then (\ref{targetrefincd}) is a leaf primary mono-source.
\end{lemma}
\begin{proof}
To show that (\ref{targetrefincd}) is a referential inclusion dependency
 in $\gmodel'$ we need show that $\set{\phiqm}$ is a mono-source, which follows from lemma \lref{mappingspreservemonosources}, and that for every model $E'$ of $\gmodel'$, 
$img(E'_{\fntuple}) \subseteq img(E'_{\qntuple})$. 
This follows because for each such $E'$ there exists a model $E$ of $\gmodel$ such that 
$E'_{\fntuple}=E_{\fntuple}$ and $E'_{\qntuple}=E_{\qntuple}$ and because
(\ref{sourcerefincd}) is a referential inclusion dependency in $\gmodel$.

%That if  (\ref{sourcerefincd}) is a leaf primary mono source then (\ref{targetrefincd}) is a leaf primary mono-source also follows from lemma \lref{mappingspreservemonosources}.\commentary{CHECK THIS}
\end{proof}

\begin{lemma}
\llabel{incdequivalence}
If $\gmodel$ is an entity model, 
if $a$ and $b$ are entity types of  $\gmodel$,  if $\set{q_1,...q_n}$
and $\set{q'_1,...q'_n}$ are sources at $b$ , for some $n \geq 1$,
and such that for each $i$, $1 \leq i \leq n$, $q_i \simeq q'_i$  
and if $\set{f_1,...f_n}$ and $\set{f'_1,...f'_n}$ are sources at $a$
such that for each $i$, $1 \leq i \leq n$, $f_i \simeq f'_i$
then. in $\gmodel$, 
\begin{equation}
\label{incdequivalence1}
\incd{a}{f_1,...f_n}{b}{q_1,...q_n}
\end{equation}
is a referential inclusion depdendency iff
\begin{equation}
\label{incdequivalence2}
\incd{a}{f'_1,...f'_n}{b}{q'_1,...q'_n}
\end{equation}
is a referential inclusion dependency.

\end{lemma}
\begin{proof}
First of all it follows from lemma \lref{monosourceequivalence} that $\set{\qn}$ is a mono-source iff
$\set{\qnprime}$ is a mono-source.
Next, it follows from the definition of referential inclusion dependency
 since for each $i$, $1 \leq i \leq n$, $q_i \simeq q'_i$  implies $E_{\qntuple} =
E_{\qnprimetuple}$ and,
similarly, for each $i$, $1 \leq i \leq n$, $f_i \simeq f'_i$  implies $E_{\fntuple} =
E_{\fnprimetuple}$
\end{proof}

\begin{lemma}
\llabel{isospreserveandreflectreferentialincds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  
if $\xn$ and $\qn$ are paths in 
$\gmodel$
then 
\begin{equation}
\label{sourceincd}
\incd{a}{\xn}{b}{\qn}
\end{equation}
is a referential inclusion dependency in $\gmodel$ 
iff 
\begin{equation}
\label{targetincd}
\incd{a}{\phixn}{b}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$. 

Further, if (\ref{targetincd}) is a leaf primary referential inclusion dependency  then (\ref{sourceincd}) is a leaf primary referential inclusion dependency
and if $\varphi$ is injective then if (\ref{sourceincd}) is a leaf primary referential inclusion dependency
then (\ref{targetincd}) is a leaf primary referential inclusion dependency.
\end{lemma}
\begin{proof}
That (\ref{sourceincd}) is an inclusion dependency in $\gmodel$ implies 
(\ref{targetincd}) is an inclusion dependency in $\gmodel'$ is established in lemma
\lref{mappingspreservereferentialincds}whereas lemma \ref{isospreserveandreflectmonosources}
establishes that if (\ref{sourceincd}) is a leaf primary referential inclusion dependency
then so to is (\ref{targetincd}). To establish the reverse implication use lemma
\lref{mappingspreservereferentialincds} applied to the inverse mapping $\varphi^{-1}$
to show that
\begin{equation}
\incd{a}{\phiminusonephixn}{b}{\phiminusonephiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel$.
Now we can use lemma
\lref{incdequivalence} to complete the proof since for each  $i$ $ 1 \leq i \leq n$, $\varphi^{-1}(\varphi(x_i)) \simeq x_i$ and $\varphi^{-1}(\varphi(q_i))\simeq q_i$ in $\gmodel$. 

That if $\varphi$ is injective then (\ref{targetincd}) is a leaf primary referential inclusion dependency
if (\ref{sourceincd}) is follows from point (iv) of lemma \lref{isospreserveandreflectmonosources}.
\end{proof}

If $\qntuple$ is a mono-source at $a$ then define $E_{\qntuple}^{-1}$ to be the right inverse of
$E_{\qntuple}$ i.e. the unique partial function such that:
$E_{\qntuple} \circ E_{\qntuple}^{-1} = id_{E_a}$

\begin{definition}
We say that a path $p:a \morph b$ \term{represents} a referential inclusion dependency
$\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$  in an ER model $\gmodel$ iff
  in all instances $E$ of $\gmodel$, $E_{\fntuple} \circ E_{\qntuple}^{-1}=E_p$.
\end{definition}
We say that a referential inclusion dependency in model $\gmodel$ is represented in model $\gmodel$ provided that there exists a path which represents it. 

\begin{lemma}
\llabel{incdrepresentationequivalence}
In the situation of lemma \lref{incdequivalence}, if $p,p':a \morph b$
are paths in $\gmodel$ and $p \simeq p'$ then $p$ represents (\ref{incdequivalence1})
iff $p'$ represents (\ref{incdequivalence2}). 
\end{lemma}
\begin{proof}
tbd
\end{proof}
\iffalse
\begin{categoricalaside}
If an ER schema is represented as a category with finite products (\textit{a la} Johnstone \textit{et al}) then
a referential inclusion dependency is a diagram
\begin{center}
$
\begin{array}{cp{0.75cm}c}
   \Rnode{a}{a}     & & \Rnode{x}{x}  \\[1.2cm]     
	                  & & \Rnode{b}{b}  
\end{array}
$
\ncarr{a}{x} 
\alabel{f}[0.33]
\ncarr{b}{x}
\blabel{m}[0.3]
\idcomp
\end{center}
\noindent
in \cat{C} such that in all instance functors $F$, 
$F(f)$ factors through $F(m)$.

Such a referential inclusion dependency is explicitly represented iff
 $f$ factors through $m$ i.e. there is an $f_0: a \morph b$ in \cat{C} such that 
$f_0 \circ m =f$. Note that because $m$ is monic then such an $f_0$ is the unique such morphism and if in some instance $F$,
$e: F(a) \morph F(b)$ is a function such that $e \circ F(m) = F(f)$ then $F(f_0)=e$. 
\end{categoricalaside}
\fi


\begin{definition}
Say that a referential inclusion dependency $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$ is \textit{simple}
iff each $q_i$ is a singleton path, i.e. is simply an edge. 
\end{definition}

\begin{lemma}
\llabel{simplerepresentationlemma}
If  $\gmodel$ is an ER model in which all simple primary referential inclusion dependencies
have representations then all primary referential inclusion dependencies have representations. 
\end{lemma}
\begin{proof}
Proof by induction TBD. Start by drawing a diagram of the inductive step.
\end{proof}


\begin{lemma}
\llabel{isospreserveandreflectrepresentationsofincds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  
if $\xn$ and $\qn$ are paths in 
$\gmodel$
and there is a referential  inclusion dependency
\begin{equation}
\label{isosourceincd}
\incd{a}{\xn}{b}{\qn}
\end{equation}
 in $\gmodel$ 
so that also 
\begin{equation}
\label{isotargetincd}
\incd{a}{\phixn}{b}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$
then (\ref{isosourceincd}) is represented in $\gmodel$ by a path $p$
iff (\ref{isotargetincd}) is represented in $\gmodel'$ by the path $\varphi(p)$.
\end{lemma}
\begin{proof}
TBD
\end{proof}

\begin{lemma}
\label{incdrepresentationshortcut}
If $\gmodel$ is an ER model, if $a$ and $b$ are entity types, if $\set{\qntuple}$ is the set
of primary key paths of $\gmodel$ sourced at $b$, if $r:a \morph b$ is a relationship, 
if $J \subset \set{1,...n}$ and for each $j \in J$ there is an $s_j:a \morph \veee$ in $\gmodel$ such that $r \circ q_j < s_j$ \commentary{and no $s'_j$ etc????} and if $\incd{a}{\pntuple}{b}{\qntuple}$
where for each $i$, $1 \leq i \leq n$, 
$$
p_i =
\begin{cases} 
    s_i         & \mbox{if $i \in J$} \\
    r \circ q_i & \mbox{if $i \notin J$.}
\end{cases} 
$$
then relationship $r$ represents the inclusion dependency  $\incd{a}{\pntuple}{b}{\qntuple}$.
\end{lemma}
\begin{proof}
TBD
\end{proof}


\subsection{Functional Dependencies}

\begin{definition} %functional dependency
In an entity model $\gmodel$  
if for some $n \geq 1$, $a$, $b_{i}, 1 \leq i \leq n$,  and $c$ are nodes and 
if  $x_{i, 1 \leq i \leq n}$, and $y$ are paths such
that for each $i$, $x_i : a \rightarrow b_i$, and such that $y: a \rightarrow c$ 
as shown here:
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}cc}
             & &         & \Rnode{b1}{b_1} \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} \\ [0.6cm]
						 & & \vdots  &                 \\ [0.2cm]
\Rnode{a}{a} & &         & \Rnode{bn}{b_n} \\ [1.0cm]
             & &         & \Rnode{c}{c}   \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\end{center}


\noindent 
then path $y$ is said to be \term{functionally dependent} on the set of paths $\{x_1,...x_n\}$ in model $\gmodel$, 
for which  we write  \sfd{x_1,...x_n}{y},
iff
 in each defining instance $E$ of $\gmodel$ there exists a  partial 
function $f_E: E_{b_1} \times E_{b_n} \rightarrow E_c$ 
\noindent such that 
domain of $f_E \subseteq img(E_{\tuple{x_1,... x_n }})$ 
and  
$E_{\xntuple} \circ f_E = E_y$ 
\begin{center}
$
\begin{array}{cp{2cm}ccp{0.5cm}cc}
						    & &         & \Rnode{Eb1}{E_{b_1}}& &                            &        \\ [0.6cm]
						    & &         & \Rnode{Eb2}{E_{b_2}}& &                            &        \\ [0.6cm]
						    & &\vdots  &                      & &                            &        \\ [0.2cm]												
\Rnode{Ea}{E_a} & &         & \Rnode{Ebn}{E_{b_n}}& & \Rnode{Jnctn}{}&  \\ [1.0cm]
						    & &         & \Rnode{Ec}{{E_c}}   & &                            &        \\
\end{array}
$
\simplepatha{$E_{x_1}$}{Ea}{Eb1}
\simplepatha{$E_{x_2}$}{Ea}{Eb2}
\simplepatha{$E_{x_n}$}{Ea}{Ebn}
\simplepathb{$E_y$}{Ea}{Ec}
\nchmarr[15][45]{Eb1}{Ebn}{Jnctn}{Ec}
\naput[npos=-0.1]{$f_E$}
\ncarc[arcangle=15]{Eb2}{Jnctn}
\end{center}
\end{definition}

\begin{remark}
In the above definition, if within an instance $E$ there does exist such a partial function $f_E$ then $f_E$ will be the unique such partial function. For if partial function $f'_E$ is another such then given a $\tuple{E_{x_1}(e),...E_{x_n}(e)} \in img(E_{\tuple{x_1,...x_n}})$
we have that $f_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})=E_y(e)=f'_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})$.
\end{remark}

\begin{definition}
A functional dependency \sfd{x_1,...x_n}{y} is said to be \term{trivial} iff $y\simeq x_i$, for some $i$, $1 \leq i \leq n$.
\end{definition}

\begin{lemma}
\llabel{mappingspreservefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model mapping from $\gmodel$  to $\gmodel'$,  if $\xn$ and $y$ are paths in $\gmodel$
and there is a  functional dependency
\begin{equation}
\label{carrythrusourcefd}
\fd{\xn}{y}
\end{equation} 
in $\gmodel$ then there is a functional dependency
\begin{equation}
\label{carrythrutargetfd}
\fd{\phixn}{\phiy}
\end{equation}
in $\gmodel'$.
Further if (\ref{carrythrusourcefd}) is trivial then (\ref{carrythrutargetfd}) is trivial.
\end{lemma}
\begin{proof}
Assume a functional dependency (\ref{carrythrusourcefd})  in $\gmodel$. To show that (\ref{carrythrutargetfd}) is a functional dependency in $\gmodel'$
we need show that in every model $E'$ 
of $\gmodel'$ there is a partial function $f_{E'}$ such that
\begin{equation}
\label{fdcarrythrucond1}
\mbox{domain of }f_{E'} \subseteq img(E'_{\tuple{\phixn}})
\end{equation}
and
\begin{equation}
\label{fdcarrythrucond2}
E'_{\tuple{\phixn}} \circ f_{E'} = E'_{\phiy}
\end{equation}
Assume then a model $E'$ of $\gmodel'$. 
Since $\varphi$ is an ER model mapping then there exists a model $E$ of $\gmodel$ such that 
$E_{\tuple{\xn}} = E'_{\tuple{\phixn}}$ and $E_y = E'_{\phiy}$. From the assumption that (\ref{carrythrusourcefd})
is a functional dependency in $\gmodel$ it follows that there exists a  partial function $f_E$ such that
$\mbox{domain of }f_{E} \subseteq img(E_{\tuple{\xn}})$
and
$E_{\tuple{\xn}} \circ f_{E} = E_y$ 
i.e. such that 
$\mbox{domain of }f_{E} \subseteq img(E_{\tuple{\phixn}})$
and
$E_{\tuple{\phixn}} \circ f_{E} = E_{\phiy}$.  The partial function $f_E$ therefore 
meets the conditions (\ref{fdcarrythrucond1}) and (\ref{fdcarrythrucond2}) that
we require of $f_{E'}$ and so we can choose the required partial function
$f_{E'}$ to be the partial function $f_E$. 
The further point regarding triviality follows from lemma \lref{mappingrespectsequivalence}.
\end{proof}




\begin{definition}
A functional dependency \sfd{x_1,...x_n}{y} is said to be a \term{leaf functional dependency} iff
 the codomain of each $x_i$, $1 \leq i \leq n$, is $\veee$ \oldt{and the codomain of $y$ is $\veee$}.\commentary{I inserted this oh so wrongly!}
\end{definition}

\begin{definition}
In an entity model $\gmodel$, if
$a$ is an entity type and $\set{x_1,...x_n}$ and $\set{y_1,...y_m}$ are sets of paths with source $a$
then we say the set $\set{y_1,...y_m}$ \textit{is functionally dependent on the set} $\set{x_1,...x_n}$ and write
\fd{x_1,...x_n}{y_1,...y_m} 
iff  each $y_j$, $1 \leq j \leq m$, is functionally dependent on $\set{x_1,...x_n}$.
\end{definition}
\begin{definition} %transitive
In an entity model $\gmodel$, a functional dependency $\set{x_1,...x_n} \morph z$
is said to be \term{transitive} if there exists a set of paths $\{y_1,...y_{m}\}$ such that
$\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ and there is a non-trivial functional
dependency $\set{y_1,...y_{m}} \morph z$ but there is no functional dependency 
$\{y_1,...y_{m}\} \morph \{x_1,...x_n\}$.
\end{definition}
\begin{definition} %intransitive
In an entity model $\gmodel$, a functional dependency $\set{x_1,...x_n} \morph y$
is said to be \term{intransitive} if it is not transitive.
\end{definition} 

\begin{lemma}
\llabel{fdequivalence}
If for some $n \geq 1$, $\xn$ and $\wanton{x'}$,  are paths in an ER model $\gmodel$
such that for each $i$, $1 \leq i \leq n$, $x_i \simeq x'_i$,
if $y$ and $y'$ are also paths in $\gmodel$ and are 
such that $y \simeq y'$ in $\gmodel$ then $\fd{\xn}{y}$ is a functional dependency in $\gmodel$ iff 
$\fd{\wanton{x'}}{y'}$ is a functional dependency in $\gmodel$.
\end{lemma}
\begin{proof}
Follows immediately from the definitions of path equivalence and of functional dependency.
\end{proof}

\begin{lemma}
\label{isospreserveandreflectfds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $y$ are paths in $\gmodel$
then there is a  functional dependency
\begin{equation}
\label{sourcefd}
\fd{\xn}{y}
\end{equation} 
in $\gmodel$ iff there is a functional dependency
\begin{equation}
\label{targetfd}
\fd{\phixn}{\phiy}
\end{equation}
in $\gmodel'$.
Further(\ref{sourcefd}) is  leaf  iff (\ref{targetfd}) is a leaf.

\end{lemma}
\begin{proof}
\vspace{0.5cm}
That (\ref{sourcefd}) is a functional dependency implies
(\ref{targetfd}) is a functional dependency has been shown in lemma \lref{mappingspreservefds}. That (\ref{targetfd}) is a functional dependency implies
(\ref{sourcefd}) is a functional dependency follows by using lemma 
 \lref{mappingspreservefds}
on the inverse mapping $\varphi^{-1}$ and by using lemma  \lref{fdequivalence}.

(\ref{sourcefd}) is  leaf  iff (\ref{targetfd}) is a leaf 
because for any node $a$ of $\gmodel$, $a= \veee$ in $\gmodel$ iff $\varphi(a)=\veee$ in $\gmodel'$.
\end{proof}

isospreserveandreflectmultiplefds:
\begin{corollary}
\llabel{isospreserveandreflectmultiplefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $\ym$ are paths 
in $\gmodel$
then there is a  functional dependency
\begin{equation}
\label{multiplesourcefd}
\fd{\xn}{\ym}
\end{equation} 
in $\gmodel$ iff there is a functional dependency
\begin{equation}
\label{multipletargetfd}
\fd{\phixn}{\phiym}
\end{equation}
in $\gmodel'$.
Further (\ref{multiplesourcefd}) is reversible iff (\ref{multipletargetfd}) is reversible.
\end{corollary}

\begin{lemma}
\llabel{isospreserveandreflecttransitivefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $z$ are paths in $\gmodel$
and there is a  functional dependency
\begin{equation}
\label{transitivesourcefd}
\fd{\xn}{z}
\end{equation} 
in $\gmodel$
so that
\begin{equation}
\label{transitivetargetfd}
\fd{\phixn}{\phiz}
\end{equation}
is a functional dependency in $\gmodel'$then:
\begin{enumerate}
\item (\ref{transitivesourcefd}) is  transitive iff (\ref{transitivetargetfd}) is transitive, 
\item (\ref{transitivesourcefd}) is  intransitive iff (\ref{transitivetargetfd}) is intransitive,

\end{enumerate}
\end{lemma}
\begin{proof}
\vspace{0.5cm}
(\ref{transitivesourcefd}) is transitive implies (\ref{transitivetargetfd}) 
is transitive because if (\ref{transitivesourcefd}) is transitive is transitive then
there exists $\ym$ such that
\fd{\xn}{\ym} is an irreversible functional dependency
and such that \fd{\ym}{z} is a non-trivial functional dependency.
From lemma \lref{isospreserveandreflectmultiplefds} this implies that in $\gmodel'$ there is an 
\fd{\phixn}{\phiym} irreversible functional dependency \fd{\phixn}{\phiym}
and by lemma \lref{isospreserveandreflectfds} there is a non-trivial functional dependency \fd{\phiym}{\phiz}. Hence it follows
the function dependency (\ref{transitivetargetfd}) is transitive.

That (\ref{transitivesourcefd}) is  intransitive iff (\ref{transitivetargetfd}) follows on directly because an instransitive functional depdency is a functional depdency that is not transitive.

Finally, a path $p$ represents (\ref{sourcefd}) in $\gmodel$ iff $\varphi(p)$ represents (\ref{targetfd}) in $\gmodel'$
because

\end{proof}

\begin{lemma}
\llabel{transitiveinjectivelemma}
In an entity model $\gmodel$ if $\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ is a functional dependency then if in an instance $E$ the function $E_{\tuple{y_1,...y_{m}}}$ is injective \newt{and total} then the function $E_{\tuple{x_1,...x_n}}$  is injective \newt{and total}.
\end{lemma}
\begin{proof}
Follows from the definition of functional dependency that for each $j$, $1 \leq j \leq m$  there is a function ${f_j}$,  such that
$E_{y_j}=E_{\tuple{x_1,...x_n}}\circ f_j$. Therefore there is a function $f=\tuple{f_1,...f_m}$ such that
$E_{\tuple{y_1,...y_m}}= E_{\tuple{x_1,...x_n}}\circ f $. Therefore since  the function $E_{\tuple{y_1,...y_{m}}}$ is 
injective \newt{and total} then the function $E_{\tuple{x_1,...x_n}}$  is injective \newt{and total}.
\end{proof}

\begin{newtt}
\begin{lemma}
\llabel{fdrightmonosourceimpliesfdleftmonosource}
In an entity model $\gmodel$ if $\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ is a functional dependency then if 
$\set{y_1,...y_{m}}$  is a mono-source in $\gmodel$ then $\set{x_1,...x_n}$ is a mono-source in $\gmodel$.
\end{lemma}
\begin{proof}
Follows directly from lemma \lref{transitiveinjectivelemma}.
\end{proof}
\end{newtt}

\begin{definition}
\noindent In an entity model $\gmodel$  
if for some $n \geq 1$, $a$, $b_{i, 1 \leq i \leq n}$,  and $c$ are nodes and 
if  $x_{i}, 1 \leq i \leq n$, and $y$ are paths such
that there is a intransitive functional dependency $\{x_1,...x_n\} \morph y$
 then the functional dependency $\{x_1,...x_n\} \morph y$ is said to be \term{represented} in the ER model $\gmodel$ iff  there exists an entity type $d$ and a primary mono-source \commentary{in case of a unary fd \fd{x}{y}, where $x:a \morph b$, need admit $\set{\tuple{}_b}$ as a possible primary mono-source.}
$\qntuple$  such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$, and a (possibly empty)
path $w:d\rightarrow c$ as here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{b1}{b_1} & &               \\ [0.7cm]
						 &  & \Rnode{b2}{b_2} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{bn}{b_n} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\simplepathb{$q_1$}{d}{b1}
\simplepathb{$q_2$}{d}{b2}
\simplepathb{$q_n$}{d}{bn}
\simplepatha{$w$}{d}{c}
\end{center}

and such that in all defining instances $E$, 
$\tuple{ E_{x_1},...E_{x_n}} \circ E^{-1}_{\tuple{q_1,...q_n}}\circ E_w = E_y$
\end{definition}

Note that  if $x$ is a path, $x:a \morph b$, and $y$ is a path, $y: a \morph c$, and if $w$ is a
relationship $w: b \morph c$ so that there is a functional dependency $\sfd{x}{y}$ in $\gmodel$
given in any instance $E$ by the function $E_w$. This functional dependency is represented in the model, according to the above definition, because the mono-source in the definition, i.e the $\set{q_1,...q_n}$,
can be taken to be the singleton consisting of the empty path $\tuple{}_b$. \\

\begin{lemma}
\llabel{isospreserveandreflectrepresentationsoffds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $z$ are paths in $\gmodel$
and there is an  intransitive functional dependency
\begin{equation}
\label{representationsourcefd}
\fd{\xn}{z}
\end{equation} 
in $\gmodel$
so that
\begin{equation}
\label{representationtargetfd}
\fd{\phixn}{\phiz}
\end{equation}
is an intransitive  functional dependency in $\gmodel'$then
(\ref{representationsourcefd}) is represented in $\gmodel$ iff
(\ref{representationtargetfd}) is represented in $\gmodel'$.
\end{lemma}
\begin{proof}
TBD
\end{proof}

\subsection{\oldt{Relationship-Like and} Identifying-Like Paths}

\begin{definition}
In an ER model $\gmodel$, a non-empty path $t: a \morph b$, where $a$ and $b$ are entity types, is said to be \term{identifying-like} iff  for all primary key paths $q:b \morph \veee$ in $\gmodel$ there exists a primary key path $q':a \morph \veee$ in $\gmodel'$ such that $t \circ q \simeq q'$.
\end{definition}

\begin{lemma}
\llabel{identifyinglikeequivalence}
In an ER model $\gmodel$ , if $t$ and $t'$ are paths, $t:a \morph b$ and $t':a \morph b$, where $a$ and $b$ are entity types
then if $t \simeq t'$ in $\gmodel$ then $t$ is identifying-like iff $t'$ is identifying-like.
\end{lemma}

keypreservationuptoequivalence
\begin{observation}
\llabel{keypreservationuptoequivalence}
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi$ is an ER model mapping $\varphi: \gmodel \morph \gmodel'$ then whenever 
$p:a \morph \veee$ is a primary key path in $\gmodel$ then there exists a primary key path 
$p':\varphi(a) \morph \veee$ in $\gmodel$ such that $\varphi(p) \simeq p'$ in $\gmodel'$.
\end{observation}

keysurjectionuptoequivalence
\begin{observation}
\llabel{keysurjectionuptoequivalence}
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi$ is an ER model mapping $\varphi: \gmodel \morph \gmodel'$ then whenever $p':\varphi(a) \morph \veee$ is a primary key path in $\gmodel'$ then there exists a primary key path $p:a \morph \veee$ in $\gmodel$ such that $\varphi(p) \simeq p'$ in $\gmodel'$.
\end{observation}
 
\begin{lemma}
\llabel{mappingspreserveidentifyinglike} 
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is a ER model mapping, $\varphi: \gmodel \morph \gmodel'$ then if $t:a \morph b$ is an identifying-like  path in $\gmodel$ then $\varphi(t)$ is an identfying-like in $\gmodel'$.
\end{lemma}

\begin{proof}
Assume such an isomorphism and assume a path $t: a \morph b$ in $\gmodel$. 
First show that if $t$ is identifying-like then $\varphi(t)$ is. Assume $t: b \morph \veee$ is identifying like in $\gmodel$. To show that $\varphi(t)$
is identifying-like in $\gmodel'$ let $q : \varphi(b) \morph \veee$ be a primary key path in $\gmodel'$. By observation \lref{keysurjectionuptoequivalence} there exists a primary key path $p : b \morph \veee$ in $\gmodel$ such that $\varphi(p) \simeq q$. Because $t$ is assumed to be identifying-like then there exists a primary key path $p': a  \morph  \veee$ in $\gmodel$ such that $t \circ p \simeq p'$. By observation\lref{keypreservationuptoequivalence} there exists a primary key path $q' : \varphi(a)  \morph  \veee$ in $\gmodel'$
such that $\varphi(p') \simeq q'$. $q'$ is the required primary key path such that $\varphi(t) \circ q \simeq q'$ since
\begin{align*}
\varphi(t) \circ q  & \simeq \varphi(t) \circ \varphi(p)       && \mbox{ since $q \simeq \varphi(p)$}    \\
                    & =      \varphi(t \circ  p)                && \mbox{ since $\varphi$ is a mapping} \\
                    & \simeq \varphi(p')                        && \mbox{ since $t \circ p \simeq p'$}           \\
                    & \simeq q'                                 && \mbox{ from choice of $q'$}   
\end{align*}
\end{proof}

\begin{lemma}
\llabel{isospreserveandreflectidentifyinglike}
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi:\gmodel \morph \gmodel'$ is an isomorphism then $t: a  \morph  b$ is an identifying-like path in $\gmodel$ iff $\varphi(t)$ is an identifying-like in $\gmodel'$.
\end{lemma}
\begin{proof}
Use lemmas \lref{identifyinglikeequivalence} and \lref{mappingspreserveidentifyinglike}.
\end{proof}

\begin{lemma}
\llabel{isossurjectiveonrelationshipsaresurjectiveonidentifyinglike}
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi:\gmodel \morph \gmodel'$ is an isomorphism then if $\varphi$ is 
surjective on relationships, i.e. if every relationship of $\gmodel'$ is the mapping of a relationship of $\gmodel$ by  $\varphi$,
then $\varphi$ is surjective on identifying-like paths i.e. for every identifying-like path $t': \varphi(a) \morph \varphi(b)$
in $\gmodel'$ there exists an identifying-like path $t: a \morph b$ in $\gmodel$ such that $\varphi(t)=t'$. 
\end{lemma}
\begin{proof}
If an isomorphism is surjective on relationships then it is surjective on paths between entity types.
Therefore if $t':\varphi(a) \morph \varphi(b)$ is a path in $\gmodel'$ then it is equal to $\varphi(t)$ for some
$t: a \morph b$ in $\gmodel$. For any $t':\varphi(a) \morph \varphi(b)$ that is identifying there is a $t$ such that 
$\varphi(t)=t'$ and this $t$ is identifying-like by lemma \lref{isospreserveandreflectidentifyinglike}.  
\end{proof}
\subsection{Relationship-Like Paths}
\begin{definition}
In an ER model $\gmodel$, a non-empty path $p: a \morph b$, where $a$ and $b$ are entity types, which consists
of a relationship $R$ followed by a  path $t :a' \morph b$ is said to be \term{relationship-like} iff
either  $t$ is the empty path (so that the path $p$ is exactly a relationship $R$) or $t$
is identifying-like.\commentary{A relationship-like path, as a relationship i.e. a path of length 1,  can be navigated in SQL without use of intermediate tables (only true in a first-cut model!!) . Paths which have length greater than one and are not relationship-like need be navigated in SQL using intermediate tables.}
\end{definition}

\begin{lemma}
\llabel{relationshippreservingmappingspreserverelationshiplike}\commentary{not sure that this is required}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is ER model mapping, $\varphi: \gmodel \morph \gmodel'$  which preserves relationships  i.e. if relationships of $\gmodel$ are mapped to relationships of $\gmodel'$ by  $\varphi$, then relationship-like paths are preserved by $\varphi$.
\end{lemma}
\begin{proof}
Assume such a mapping $\varphi$, and assume that a path $p$ of $\gmodel$ is relationship-like.
From the definition of relationship-like, either $p$ is exactly a relationship in which case it is preserved by $\varphi$ by initial assumption or $p$ consists of path $R \circ t$ where $t$ is an identifying-like path.
In the latter case, from the definition of mapping, $\varphi(p)$ consists of $\varphi(R)$, which is a relationship in $\gmodel'$, from the initial assumption, followed by a path $\varphi(t)$ which is identifying-like since $t$ is, by lemma \lref{mappingspreserveidentifyinglike}. Therefore $\varphi(p)$ is relationship-like in $\gmodel'$.
\end{proof}

\begin{lemma}
\llabel{isossurjectiveonrelationshipsaresurjectiveonrelationshiplike}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an isomormorphism, $\varphi: \gmodel \morph \gmodel'$, that is surjective on relationships    
then $\varphi$ is surjective on relationship-like paths of $\gmodel'$. 
\end{lemma}
\begin{proof}
If $r':\varphi(a) \morph \varphi(b)$ in $\gmodel'$ is relationship-like then it consists of a relationship $R': \varphi(a) \morph \varphi(a')$, for some $a'$,
and a path $t':\varphi(a') \morph \varphi(b)$. Since $\varphi$ is assumed surjective on relationships there exists a relationship 
$R:a \morph b$ in $\gmodel$ such that $\varphi(R)=R'$. 
By lemma \lref{isossurjectiveonrelationshipsaresurjectiveonidentifyinglike} there also exists an identifying-like path $t:a' \morph b$ such that $\varphi(t)=t'$.
The path $r=R \circ t$ is a relationship-like path such that $\varphi(r)=r'$ as required.
\end{proof}

 

\subsection{ER model Goodness Conditions}\
\begin{definition}
\noindent An ER model $\gmodel$ is \term{well-formulated} 
 iff 
\begin{enumerate} [(i)]
\item{
it satisfies the minimality condition (see section \lref{minimalitycondition}),
}
\item{ 
each\commentary{This is the first place we zero-in on primaries.} primary\commentary{What about secondary referential inclusion dependencies?} referential inclusion dependency of $\gmodel$ is represented in $\gmodel$ by some path $p$ \footnote{Equivalently, by lemma
\lref{simplerepresentationlemma}, sufficient that all simple primary referential inclusion dependencies of $\gmodel$ be represented.},
}
\item{ 
each leaf primary referential inclusion dependency of $\gmodel$ is represented in $\gmodel$ by some relationship-like path $p$, 
}
\item{
for each leaf intransitive functional dependency $\set{x_1,...x_n} \morph y$ in model $\gmodel$
either $\set{x_1,...x_n}$ is a mono-source i.e. in every defining instance $E$, $E_{\xntuple}$ is injective and total
or else the functional dependency is represented in the model.
}
\end{enumerate}
\end{definition}

\begin{lemma}
\llabel{certainisomorphismspreservewellformulatedness}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an isomorphism between $\gmodel$  and $\gmodel'$ that preserves relationships\footnote{meaning that it maps relationships to relationships} and reflects primary mono-sources then if $\gmodel$ is well-formulated then $\gmodel'$ is well-formulated.
\end{lemma}
\begin{proof}
Assume such a $\varphi$ and that $\gmodel$ is well-formulated. Then
\begin{enumerate} [(i)]
\item{
That $\gmodel'$ satisfies the minimality condition follows corollary \lref{isospreserveandreflectmonosources}.
}
\item{ 
To show that each primary referential inclusion dependency of $\gmodel'$ is represented in $\gmodel'$ by some path $p$ we use the fact that each primary referential inclusion dependencies is reflected
by the isomorphism $\varphi$ because $\varphi$ is assumed to reflect primary mono-sources (lemma \lref{isospreserveandreflectreferentialincds}) and then that representation of a referential inclusion dependencies by a path is  preserved by isomorphisms (lemma \lref{isospreserveandreflectrepresentationsofincds})
and then use lemma \lref{incdrepresentationequivalence}.
\commentary{SPELL THIS OUT.}
}
\item{ 
That each leaf primary referential inclusion dependency of $\gmodel'$ is represented in $\gmodel'$ by some relationship-like path $p$
follows because such leaf primary referential inclusion dependencies are reflected by isomorphisms
(lemma \lref{isospreserveandreflectreferentialincds})
 and because  representation by a path is preserved (lemma \lref{isospreserveandreflectrepresentationsofincds}) and relationship-like paths are preserved
(lemma \lref{relationshippreservingmappingspreserverelationshiplike}) 
by $\varphi$  because $\varphi$ is assumed to reflect primary mono-sources and preserve relationships.

}
\item{
That for each leaf intransitive functional dependency $\set{x_1,...x_n} \morph y$ in model $\gmodel'$
either $\set{x_1,...x_n}$ is a mono-source 
or else the functional dependency is represented in $\gmodel'$ 
follows by lemmas \lref{isospreserveandreflectmultiplefds}, \lref{isospreserveandreflecttransitivefds},
\lref{isospreserveandreflectrepresentationsoffds} and the fact that mono-sources are preserved (lemma \lref{mappingspreservemonosources}).
\commentary{SPELL THIS OUT.}
}
\end{enumerate}
\end{proof}
\begin{definition}
An ER model $\gmodel$ is \term{restriction free} iff for all  nodes $a$, $b$ of $\gmodel$ and for all edges $y: a \morph b$, if there exist non-empty paths $x_1,...x_n$   with domain $a$ in $\gmodel$,  and for some $j$, $1 \leq j \leq n$, $x_j \not\simeq \tuple{}$ and in every defining instance $E$,  
$$E_y = \bigwedge_{1 \leq i \leq n}{\overline{E_{x_i}}} \circ E_{x_j}$$
then $y \simeq x_j$. \commentary{Qualification that $a$ and $b$ be distinct removed on Mon 4th May 2020.} 
\end{definition}

\begin{newtt}
\begin{definition}
An ER model $\gmodel$ is \term{leaf-restriction free} iff \newt{....}
\end{definition}
\end{newtt}

Since if $y < x$ in an ER model $\gmodel$ then in each instance $E$, $E_y = \bar{E_y} \circ E_x$
then we can deduce the following:
\begin{observation}
If $\gmodel$ is a restriction free  ER model with an edge $y:a \morph b$, where  $a$ and $b$ are distinct nodes of $\gmodel$ then there does not exist a path  $x$ for which $y < x$.
\end{observation}

\begin{lemma}
\llabel{intransitivelemma}
In a well-formulated model $\gmodel$  if $\set{x_1,...x_n} \morph y$  is a non-trivial intransitive \reinstatet{leaf}
functional dependency sourced at some entity type $a$ then either $\set{\xn}$ is a mono-source
or else for some entity type $d$ there is a non-empty relationship-like path $p:a \rightarrow d$ such that $\{x_1,...x_n\} \morph p$ is a functional dependency in $\gmodel$
and a  path $w:d \morph c$  such that $y \simeq p \circ w$. If $c$ is $\veee$ then
the path $w$ is non-empty and if $y$ is an edge and $\gmodel$ is leaf\commentary{notice that only need leaf-restriction free} restriction free then $w$ is not equivalent to a primary key path.
\end{lemma}
\begin{proof}
Since $\gmodel$ is well-formulated  and there is an intransitive functional dependency $\set{x_1,...x_n} \morph y$ then either $\set{\xn}$ is a mono-source and we are done or else the functional dependency
$\set{x_1,...x_n} \morph y$   is represented 
by  an entity type $d$ and 
a primary mono-source $\qntuple$ with respect to
$d$, such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$ and a 
path $w:d\rightarrow c$ as shown here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{v1}{\veee} & &               \\ [0.7cm]
						 &  & \Rnode{v2}{\veee} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{vm}{\veee} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$x_1$}{a}{v1}
\simplepatha{$x_2$}{a}{v2}
\simplepatha{$x_n$}{a}{vm}
\simplepathb{$y$}{a}{c}
\simplepathb{$q_1$}{d}{v1}
\simplepathb{$q_2$}{d}{v2}
\simplepathb{$q_n$}{d}{vm}
\simplepatha{$w$}{d}{c}
\end{center}
such that
\begin{equation}
\label{fundependency}
E_y = E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_w
\end{equation}

Because $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$,  and from
clause (iii) of the definition of well-formulated since $\gmodel$ is well-formulated, it follows that
there  is a relationship-like path $p:a \rightarrow d$ such
that 
%\foreachi, $p \circ q_i \simeq x_i$ and therefore
in all defining instances $E$,

\begin{equation}
\label{incdependency}
E_{\xntuple} \circ E^{-1}_{\qntuple} = E_p
\end{equation}
Now we have  that in all defining instances $E$ that 
\begin{align*}
E_y &= E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_w  && \text{ (\ref{fundependency}), above,}\\
    &= E_p \circ E_w                                   && \text{by (\ref{incdependency}),}\\
		&= E_{p \circ w}                                   && \text{from defn. of $E$ being an instance.}\\
\end{align*} 
\vspace{-0.3cm}
From which, by definition of $\simeq$, $y\simeq p \circ w$, as required. \\

Now suppose that $c$ is the type representing universals, $\veee$. The path $w$ must be non-empty because its source $d$ being an entity type must be distinct from its destination $\veee$ which is not an entity type. 
We wish to show that $w$ is not equivalent in $\gmodel$ to
a primary key path. Assume the contrary that $w$ is equivalent to a primary key path. From lemma 
\lref{primarykeypathfactorsthroughprimarymonosource} it follows that $w \simeq q_i$, for some
$i$, $1 \leq i \leq n$.  
Therefore
\begin{align*}
E_y &= E_p \circ E_w                                        && \text{}\\
		&= E_p \circ E_{q_i}                                    && \text{}\\
		&= E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_{q_i}   && \text{}\\
		&= E_{\xntuple} \circ \proji{i}                         && \text{} \\
		&= \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq j \leq n}{ j \neq i}}{\overline{E_{x_j}}}\circ E_{x_i}  
		                                                        && \text{By lemma \lref{tupleprojection}}
\end{align*} 

Hence because $\gmodel$ is leaf-restriction free we deduce that $y \simeq x_i$ 
 and this contradicts the assumption that the functional dependency
is non-trivial. Thus $w$ is not equivalent to a primary key path.
\end{proof}


 
\begin{definition}
\noindent An ER model $\gmodel$ has the \term{\fdfactoring} property iff to every functional dependency $\set{x_1,...x_n} \morph z$ where $x1, x_2, ... x_n$ and $z$ are \oldt{\attributelike} \commentary{\newt{strikeout or not??}}paths either $\set{x_1,...x_n}$ is
a mono-source or else there is an intransitive functional dependency $\set{y_1,...y_m} \morph z$ which it factors through i.e. such that $\set{x_1,...x_n} \morph \set{y_1,...y_m}$. \commentary{what is the thinking behind the exception that $\set{\xn}$ being a mono-source?}
\end{definition}

\begin{lemma}
\llabel{fdfactoringcarrythroughlemma}
If $\gmodel$ and $\gmodel'$ are ER models and if $\varphi:\gmodel \morph \gmodel'$ is an isomorphism
then if $\gmodel$ has the fd factoring property then so to does $\gmodel'$.
\end{lemma}
\begin{proof}
%Use lemma \lref{isospreserveandreflectfds} and also lemma \lref{isospreserveandreflecttransitivefds}.
To show that $\gmodel'$ has the fd factoring property if $\gmodel$ does assume $\gmodel$ has the fd factoring property and assume $\fd{\xnprime}{z'}$ in $\gmodel'$. 
By lemma \lref{isospreserveandreflectfds} it follows since $\varphi^{-1}$ is an isomorphism that $\fd{\varphi^{-1}(x'_1),...\varphi^{-1}(x'_n)}{\varphi^{-1}(z')}$ is a functional depdendency
in $\gmodel$. Since $\gmodel$ is assumed to have the fd factoring property either $\set{\varphi^{-1}(x'_1),...\varphi^{-1}(x'_n)}$ is a mono-source in $\gmodel$ in which case $\set{\xnprime}$ is a mono-source in 
$\gmodel'$ since $\varphi^{-1}$ is an isomorphism  and isomorphisms reflect mono-sources (lemma \lref{isospreserveandreflectmonosources}) or else there exists paths $\yn$ in $\gmodel$ such that
$\fd{\varphi^{-1}(x'_1),...\varphi^{-1}(x'_n)}{\yn}$ is a functional depdency in $\gmodel$ and 
 $\fd{\yn}{\varphi^{-1}(z')}$ is an intransitive functional dependency in $\gmodel$.  

In the latter case it then follows by lemma
\lref{isospreserveandreflectfds} that
 $\fd{\varphi(\varphi^{-1}(x'_1)),...\varphi(\varphi^{-1}(x'_n))} {\varphi(y_1),...\varphi(y_n)}$
is a functional dependency in $\gmodel'$
and then by lemma \lref{fdequivalence}  that $\fd{\xnprime}{\varphi(y_1),...\varphi(y_n)}$ in $\gmodel'$
because for each $i$, $1 \leq i \leq n$, $\varphi(\varphi^{-1}(x_i)) \simeq x_i$.
Similarly, we can use lemmas \lref{isospreserveandreflecttransitivefds} and \lref{fdequivalence} to show that $\fd{\varphi(y_1),...\varphi(y_n)}{z'}$ is an intransitive functional dependency in $\gmodel'$. 

From the assumption that $\gmodel$ has the fd factoring property we have shown that for each functional dependency $\fd{\xnprime}{z'}$ in $\gmodel'$ either $\set{\xnprime}$ is a mono-source  or
that the functional dependency  $\fd{\xnprime}{z'}$ factors through an intransitive functional dependency and  therefore that $\gmodel'$ has the fd factoring property.
\end{proof}


\begin{lemma}
\llabel{mainlemma}
In a well-formulated model $\gmodel$ that has the \fdfactoring\ property if $\set{x_1,...x_n} \morph z$ is a non-trivial \reinstatet{leaf} functional dependency sourced
at some entity type $a$ then either $\set{x_1,...x_n}$ is a mono-source in $\gmodel$
or else there is an entity type $d$ and there is a relationship-like path $p:a \rightarrow d$ such that $\{x_1,...x_n\} \morph p$
and a  path $w:d \morph c$  such that $y \simeq p \circ w$. If \newt{\oldt{each $x_i$ has codomain $\veee$ and }codomain of $y$,} $c$, is $\veee$ then
the path $w$ is non-empty and if $y$ is an edge and $\gmodel$ is leaf-restriction free then $w$ is not equivalent to a primary key path.
\end{lemma}
\begin{proof}
Since the model $\gmodel$  has the \fdfactoring\ property, the functional dependency $\set{x_1,...x_n} \morph z$ can be factored through an intransitive functional
dependency $\set{y_1,...y_m} \morph z$. Therefore by lemma \lref{intransitivelemma} either there exists $d$, $p$ and $w$ as required
or else  $\set{\ym}$ is a mono-source in which case, by lemma \lref{transitiveinjectivelemma}, $\set{\xn}$ is a mono-source as required.
\end{proof}

\begin{newtt}
\begin{definition}
In a model $\gmodel$ an edge $e$ is \term{design redundant} if $e$ is not an identifing edge and if for some path $p$
which does not include $e$, $e \simeq p$.
\end{definition}

\begin{definition}
A model $\gmodel$ is said to be \term{free of design redundancy} iff there are no design redundant edges in $\gmodel$.
\end{definition}

\begin{lemma}
\llabel{freeofdesignredundancyimpliesfdlhsismonosource} \commentary{\newt{NOT PROVEN}}
In a well-formulated model $\gmodel$ that has the \fdfactoring\ property and which is free of design redundancy if $y$ is an attribute and if $\fd{\xn}{y}$
is a functional dependency sourced at an entity type $a$ then $\set{\xn}$ is a mono-source.
\end{lemma}
\begin{proof}
By lemma \lref{mainlemma} \commentary{\newt{need leaf fd}\newt{to use this lemma}}either $\set{\xn}$ is a mono-source or else there exist paths $p$ and $w$ such that $y \simeq p \circ w$. 
\oldt{but this is not so since} . Since $y$ is an edge and $\gmodel$ is assumed to be free of design redundancy then we must conclude
that $y$ apears in the path $p \circ w$. Since the codomain of $y$ is $\veee$ the only possibility is that the path $w$ 
is a path $w' \circ y$. Consider the path $p' = p \circ w'$. From $y \simeq p \circ w$ it folows that $y \simeq p' \circ y$.
Therefore there is a functional dependency $\fd{p'}{y}$ in $\gmodel$. 

But also $y \simeq p' \circ p' \circ y$ and a functional dependencies $\fd{p'}{p' \circ p'}$ and $\fd{p' \circ p'}{y}$.
\commentary{Could we stipulate in defn of well-formulated that representation of fd should not include thing represented?}
\end{proof}
\end{newtt}


\subsection{Ranking Relationships in an ER Model}
For every ER model $\gmodel$ and for each natural number $n$, $n \geq 0$, we define which relationships of
$\gmodel$ are of rank $n$. We do this  in such a way that each relationship of $\gmodel$ either has a rank $n$, for some $n \geq 0$, or if it is not of rank 
$n$ for any $n$, is said to be unranked or of null rank. Denote by $\gmodel_n$ the ER model which is the ER model 
$\gmodel$ less the relationships which are not of rank less than or equal to n. The definition proceeds by induction as follows:
\begin{definition}
The relationship $R: a \morph b$ in an entity model $\gmodel$ is said to be of rank $1$\commentary{was rank 0  -- check} iff whenever 
$\qntuple$ is a \commentary{leaf?} ??? primary mono-source at $b$ in $\gmodel$, where $q_i:b \morph \veee$, for each $i$, $1 \leq i \leq n$  then there exists attributes $x_i:a \morph \veee$ in $\gmodel$ such that $\incd{a}{\xntuple}{b}{\qntuple}$ is an inclusion dependency and this inclusion dependency is represented by the relationship $R$. 
The relationship $R: a \morph b$ in an entity model $\gmodel$ is said to be of rank $n+1$ iff whenever 
$\qntuple$ is a primary mono-source at $b$ in $\gmodel$, there exists paths $p_i:a \morph \veee$ in $\gmodel_n$ such that $\incd{a}{\pntuple}{b}{\qntuple}$ is an inclusion dependency and this inclusion dependency  is represented by the relationship $R$. 
\end{definition}

\section{Relational Models}
\llabel{definitionofrelational}
Generally a relational schema is defined to consist of a finite set of relations each consisting of a
finite set of attributes along with a set of semantic constraints. The latter may include functional dependencies or keys and key attributes and inclusion dependencies.  We restrict our attention, for the time being, to those schemas in which for each relation there is a subset of its attributes that comprise a primary key and between these relations there are defined  a set of inclusion dependencies of the 
form $\incd{R}{X}{S}{K}$ where $S$ is a relation and $K$ is the primary key of $S$.
Any inclusion dependency of the form $\incd{R}{X}{S}{K}$ where $S$ is a relation and $K$ is a key for that relation is called a \term{keyed inclusion dependency} (see Levene and Vincent) or a \term{referential constraint} (SQL ISO standard).
If $K$ is the primary key we shall say that such an inclusion dependency is a \term{primary referential constraint}. If $R$ is a relation having primary key consisting
of $X_1,X_2,...X_n$ and attributes $Y_1,...Y_m$ in addition to the primary key 
 then we shall write the relation as $R(\underline{X_1},...,\underline{X_n},Y_1,...Y_m)$.

It is usually the case that attributes are annotated with specific domains of values but for our purpose we can assume that each attribute is $v$-valued where $v$ is our type of universals for domains play no role in the theory with which we concern ourselves here.
\subsection{Definition of Primary Relational ER Model}
The terms \term{primary referential inclusion dependency} and 
\term{simple referential inclusion dependency} were given in 
section \lref{referentialinclusiondependency}. These are used in the following definition:
\begin{definition}
\noindent 
A \term{primary relational ER model} is an  ER model that also satisfies:
\begin{enumerate}[(i)]
\item
it is primarily keyed i.e. all identifying edges are attributes, 
\item
all relationships are ranked i.e. there are no relationships of null rank,
\item 
for each primary referential inclusion dependency there is a unique relationship which represents it.
\end{enumerate} 
\end{definition}

Such a primary relational ER model $\gmodel$ gives rise to relational schema:
\begin{itemize}
\item relations (tables) of the relational schema correspond to entity types of $\gmodel$,
\item attributes (columns) of a relation $a$ correspond to attributes of $a$ in $\gmodel$, 
\item an attribute is part of the primary key iff the corresponding edge of $\gmodel$ is identifying,
\item a keyed referential constraint is defined to correspond to every simple primary referential inclusion dependency of $\gmodel$ i.e. to correspond to every relationship of $\gmodel$. 
\end{itemize}

The characteristic instances of such an ER model gives rise to a set of database instances of the corresponding relational schema.

Likewise every relational schema that consists of relations with primary keys and primary referential constraints and has a set of characteristic database instances gives rise to an isomorphic\commentary{check} primary relational ER model. 

For the time being we restrict attention to primary relational ER models which stand-in for us for a large class of relational schemas. 

\subsection{Attribute Redundancy}
\begin{definition}
In a relational ER model $\gmodel$ an attribute $x: a \morph \veee$ is said to be \term{relationally redundant} if
there exists a path $p$ in model $\gmodel - x$ such that $p \simeq x$ and such that $\gmodel - x$ is 
a relational ER model.  
\end{definition}
\begin{definition}
Say that a relational ER model $\gmodel$ is \term{free of relational redundancy} iff none of its attributes are relationally redundant.
\end{definition}


\subsection{Normal Forms}

\noindent One measure of the goodness of a relational model is whether it satisfies the condition called Boyce Codd Normal Form (BCNF). In some modelling situations this condition cannot be 
met and in these situations a lesser goodness criteria that can be achieved is that of Third Normal Form (3NF). 

\begin{definition} % 3NF
A (relational) ER model $\gmodel$ is in  Third Normal Form (3NF)  iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  \sfd{x_1,...x_n}{y} is a non-trivial functional dependency, 
either $\set{\xn}$ is a mono-source or else $y$ is a key attribute.
\end{definition}


We shall show that the relational model $\chigmodel$ generated from a well-formulated 
ER model $\gmodel$ satisfies a strong form of 3NF in which $y$ will be a primary key attribue i.e. will be identifying.
We can define as follows:

\begin{definition} % S3NF
A (relational) ER model $\gmodel$ is in Strong Third Normal Form (S3NF)  iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  \sfd{x_1,...x_n}{y} is a non-trivial functional dependency, 
either $\set{\xn}$ is a mono-source or else $y$ is identifying.
\end{definition}

We shall also show that with a single additional condition on $\gmodel$, which it may or not be possible to achieve in a given modelling situation,
the generated model $\chigmodel$ satisfies the BCNF condition.
Written in the terminology we are using here BCNF can be defined as follows:
\begin{definition} % BCNF
A relational ER model is in Boyce Codd Normal Form (BCNF) \commentary{See Zaniolo definition 2.} iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  \sfd{x_1,...x_n}{y} is a non-trivial functional dependency, 
$\set{\xn}$ is a mono-source.  
\end{definition}

\noindent The next lemma simplifies the requirement for showing BCNF to consideration of non-trivial
intransitive functional dependencies:

\begin{lemma}
\llabel{BCNFsublemma}
If a model $\gmodel$ has the \fdfactoring\ property then it is in BCNF iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which \sfd{x_1,...x_n}{y} is a non trivial  intransitive functional dependency,
$\set{\xn}$ is a mono-source. 
\end{lemma}
\begin{proof}Use lemma \lref{transitiveinjectivelemma}.
\end{proof}

\begin{lemma}
\llabel{S3NFsublemma}
If a model $\gmodel$ has the \fdfactoring\ property then it is in S3NF iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which \sfd{x_1,...x_n}{y} is a non trivial intransitive functional dependency,
$\set{\xn}$ is a mono-source or $y$ is a primary key. 
\end{lemma}
\subsection{Other Conditions for Relational ER models}
\begin{definition} 
An ER model is \term{reduced} iff for all attributes $x:a \morph \veee$ \commentary{move earlier?}
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$, as here,
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\ncarr{a}{v} 
\alabel{x}
\simplepatha{$r$}{a}{b}
%\ncarr{a}{b} 
%\blabel{r}
\simplepatha{$p$}{b}{v}
%\ncarr{b}{v} 
%\blabel{p}
\end{center}

then it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path $q:b \morph \veee$ such that $p \simeq q$, or
\item the path $r$ is a mono-source, or
\item the attribute $x$ is identifying.
\end{enumerate}
\end{definition}

In a relational ER model $\gmodel$ if there are no identifying attributes $x$ such that $x \simeq r \circ p$ where $r$ is relationship-like, $r:a \morph a'$, and $p$ is a not a primary key path, $p:a' \morph \veee$ then the model is said to be \term{without caveats}.

Thus we get:
\begin{definition} 
An ER model $\gmodel$ is \term{reduced without caveat} iff for all attributes $x:a \morph \veee$
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$ it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path \commentary{an identifying attribute} $q:b \morph \veee$ such that $p \simeq q$, or
\item the path $r$ is a mono-source.
\end{enumerate}
\end{definition}

\subsection{Main Theorem}
\noindent Now for the main theorem:
maintheorem
\begin{theorem}
\llabel{maintheorem}
\noindent If a (relational) ER model $\gmodel$ is well-formulated and leaf-restriction free, has the \fdfactoring\ property and is reduced then it is in Strong Third Normal Form. 
If  $\gmodel$ is reduced without caveats then is in Boyce-Codd Normal form.
\end{theorem}
\begin{proof}
To prove S3NF it suffices, by lemma \lref{S3NFsublemma},  to show that if 
$\sfd{x_1,...x_n}{y}$ is a non-trivial intransitive functional dependency of model $\gmodel$
where $x_1,...x_n$, $y$ are attributes 
then  $\set{\xn}$ is a mono-source or that $y$ is identifying. \\
Assume then such a functional dependency.
From the assumption that the model $\gmodel$ is well-formulated and leaf-restriction free
then by lemma \lref{mainlemma} 
either $\set{\xn}$ is a mono-source and we are done
or else there is a non-empty relationship-like path $r$ in $\gmodel$
and a path $w$ of $\gmodel$ that is not  equivalent to a primary key path such that
\begin{equation}
\label{simpleRepresentation}
 r \circ w \simeq y
\end{equation}
and such that $\sfd{x_1,...x_n}{r}$.
If the model $\gmodel$ is assumed to be reduced without caveat then $r$ is a mono-source since $w$ is not equivalent to some primary key of $d$.
Since $r$ is a mono-source then $x_1,...x_n$ is a mono source, 
since $\sfd{x_1,...x_n}{r}$ \newt{by lemma \ref{fdrightmonosourceimpliesleftmonosource}}, as required and we have established BCNF.
With the weaker assumption that the model $\gmodel$ is reduced, there is the additional possibility that $y$ is identifying i.e. is a primary key attribute and we have proved S3NF.
\end{proof}

\subsection{Simple Relational Models}
It is unusual in practice for reduced relational models not to meet the stronger condition that we get if we drop condition (ii) from the definition of a model being reduced. We shall say such models are \term{simple} and so these are defined as follows:
\begin{definition} 
An  ER model is \term{simple} iff for all attributes $x:a \morph \veee$
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$ it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path  $q:b \morph \veee$ such that $p \simeq q$, or
\item the attribute $x$ is identifying.
\end{enumerate}
\end{definition}

In the next sections we define a transformation that from an \commentary{what adjectives ought I to insert here?}ER model generates a simple relational ER model.

\section{Chi Transform - a Revised Chen Transformation}
In this section we define a relational  entity model $\chigmodel$ that corresponds
to suitable ER models $\gmodel$. The $\chit$ transformation that we so describe is a refinement
of a transformation which we denote $\firstcut$ that was first described by Chen and subsequently prescribed in a range of software design methodologies and accordingly implemented in associated CASE tools. The transformation $\firstcut$ is sometimes said to produce a first-cut relational design because generally the model produced requires normalisation
to achieve an appropriate database normal form such as 3NF or BCNF. 
In contrast we shall show that the transformation $\chit$ defined here produces relational models $\chigmodel$ that are in 3NF and, if appropriate, BCNF and are free of attribute redundancy.

From an ER model $\gmodel$ a first-cut relational design $\firstcut(\gmodel)$ is achieved by extending each
entity type $a$, by attributes,  one for each path in $\gmodel$ of the 
form $\tuple{r_0,r_1,...r_n}$ where each of $r_1,...r_n$ are identifying. 

The transformation $\firstcut$ can be improved to by taking note of equivalent attribute-like paths and
either dropping duplicates or, equally, thinking of the added attributes as corresponding to equivalence classes of 
equivalent attribute-like paths wrt the equivalence relation $\simeq$ defined earlier (section \lref{xxx}). This improved transformation we can denote as $\firstcutimproved$.

This consideration leads  to this definition:
\begin{definition}
A path $r=r_0/r_1/r)2.../r_n$, for some $n$, $n \geq 0$, in an ER model $\gmodel$ is 
said to be \term{attribute-like} iff $r: a \morph \veee$, for some entity type $a$,
and either $n=0$ or $\tuple{r_1,...r_n}$ is a primary key path i.e. each $r_i$ is identifying.
\end{definition}
\begin{noteforfuture}
In most general case this will become not $s_1$ uses $s_2$ ... uses $s_m$.
\end{noteforfuture}
If $\gmodel$ is an ER model then the model $\firstcutimproved(\gmodel)$ is defined to be the ER model whose schema extends the schema of $\gmodel$
by extending the set of attributes of each entity type $a$ by the set 
$\set{\qq{r_0/r_1/...r_n}  | \ r_0/r_1/...r_n: a \morph \veee \mbox{ is an attribute-like path}}$ and for which the defining instances are the defining  instances $E$ of $\gmodel$ extended to the schema of $\firstcutimproved(\gmodel)$ by defining for each attribute $\qq{r_0/r_1/...r_n}$, $E_{\qq{r_0/r_1/...r_n}} = E_{r_0} \circ E_{r_1}... \circ E_{r_n}$.

We define the model $\chigmodel$ to be a further improvement to the first-cut transformation obtained by excluding  from  the transformed model $\firstcutimproved(\gmodel)$ those attributes $\qq{r \circ q}$ for which there exists a \sout{unique}  path $s$ such that  either  $r \circ q < s$ or for which $s$ is non attribute-like and $r \circ q \simeq s$. 

\begin{definition}
If for some relationship $r$ and primary key path $q$ of $\gmodel$ there exists a  path $s_1/...s_n$ such that either   $r \circ q < s_1/...s_n$ or $s_1/...s_n$ is non attribute-like and $r \circ q \simeq s_1/...s_n$ or $r \circ q < s_1/...s_n$ then say that relationship $r$ \term{directly depends} on relationship $s_i$,
for each $i$. Define one relationship to depend on another if it depends on it it directly or indirectly i.e. define dependency between relationships to be the transitive closure of direct dependency.
\end{definition}

For $\chigmodel$ to be a relational model, the implied dependency between relationships of $\gmodel$ will need be non-circular
and in addition one further property is required as we now descibe.


\begin{definition}
In an  ER model $\gmodel$, if $a$ and $b$ are entity types and if $\set{\qntuple}$ is the set of primary key paths sourced at $b$, if $r: a \morph b$ is a relationship then $r$ is said to be \term{\oldt{a pseudo-restriction}}\term{\newt{boolean-worth}} \commentary{the boolean in question is the fact of whether the relationship is or is not defined at a particular entity.}
iff for each $i$, $1 \leq i \leq n$, there exists a path $s_i: a \morph \veee$ such that $r \circ q_i < s_i$,
and there doesn't exist $s'_i$ such that $r \circ q_i < s'_i <s_i$ and  either
$\incd{a}{\sntuple}{b}{\qntuple}$ and this inclusion dependency is not represented by
$r$ or else $\nincd{a}{\sntuple}{b}{\qntuple}$.
\end{definition}

We exclude models $\gmodel$ 0that have boolean-worth relationships from the $\gmodel$ for which $\chi$ is defined but not because a relational impelmentation cannot be given but because there is a choice of representations: 
\begin{lemma}
In the context of the above definition if relationship $r$ is boolean-worth
then $incd{a}{r \circ q_1,s_2,...s_n}{b}{\qn}$ is an inclusion dependency that represents $r$. \commentary{ Or choose any $q_i$ for that matter.}
\end{lemma}
\begin{proof}
TBD
\end{proof}
We could easily include boolean-worth representations to entity types havinga single primary key attribute because then no choice is required.
This leads to examples where the boolean-worth $r: a \morph b$ is replaced by the boolean-worth $\bar{r}: a \morph a$ in the case where $b$ has multiple primary keys but $a$ has just one.  

\begin{lemma}
If an edge is a restriction then it is \newt{boolean-worth} \oldt{a pseudo-restriction}.
\end{lemma}
\begin{proof}
TBD
\end{proof}

If these conditions are met: that attribute-like paths have at most one equivalent non attribute-like path, that implied dependencies are non-circular and there are no \oldt{pseudo-restriction} \newt{boolean-worth} relationships, then we say that $\gmodel$ is \term{$\chit$-suitable} and in these instances we can show that 
the model $\chigmodel$ is a simple relational model. 

We will define conditions for a well-formulated $\gmodel$  that if met ensure 
 that the isomorphic relational model $\chigmodel$ is a well-formulated, simple, restriction free relational ER model with the fd factoring property 
ensuring that it is therefore in S3NF.  Further we will show that if $\gmodel$ is without caveats then $\chigmodel$ is also without caveats and is therefore in BCNF. 

\begin{lemma}
\llabel{chimodelisrelational}
If $\gmodel$ is $\chit$-suitable then $\chigmodel$ is a relational model.
\end{lemma}
\begin{proof}
The relationships $r: a \morph b$ of $\chigmodel$ are exactly those of $\gmodel$. If such a relationship does not directly depend on any path $s$ of $\gmodel$ then define its rank to be $1$.
If instead a relationship $r$ directly depends onone or more paths of $\gmodel$ then define its rank to be 1 greater than the maximum rank of the relationships it depends on. 
This definition is sound because dependency is non-circular.
The relationship $r$ represents the inclusion dependency $\incd{a}{r \circ q_1,...r \circ q_n}{b}{q_1,...q_n}$ in $\gmodel$ therefore it represents
the inclusion dependency $\incd{a}{p_1,...p_n}{b}{q_1,...q_n}$ where 
$$
p_i =
\begin{cases} 
    s_i         & \mbox{if $s_i$ is a path which dominates path $r \circ q_i$ in $\gmodel$} \\
    s_i         & \mbox{if $s_i$ is a non-attribute-like path and is equivalent to  $r \circ q_i$ in $\gmodel$ }  \\
    r \circ q_i & \mbox{if there is no such $s_i$.}
\end{cases} 
$$
which we prove by using lemma \lref{incdrepresentationshortcut} (which is applicable because we have assumed 
that there are no \oldt{pseudo-restriction} \newt{boolean-worth} relationships in $\gmodel$), and lemma \lref{incdrepresentationequivalence}.
It follows from lemmas yyyyyyyyyyy  and zxzzzzzz that in $\chigmodel$ the relationship $r$ is represented by inclusion dependency $\incd{a}{p'_1,...p'_n}{b}{q_1,...q_n}$ where
$$
p'_i =
\begin{cases}
   \varphi(s_i)     & \mbox{if $s_i$ is a path  either dominates path $r \circ q_i$ in $\gmodel$} \\
   \varphi(s_i)     & \mbox{if $s_i$ is a non-attribute-like path and is equivalent to  $r \circ q_i$ in $\gmodel$ }  \\
   \qq{r \circ q_i}  & \mbox{if there is no such $s_i$.}
\end{cases} 
$$
Therefore each relationship $r: a \morph b$ $\chigmodel$ is represented by an referential inclusion dependency $\incd{a}{p'_1,...p'_n}{b}{q_1,...q_n}$
where the paths $p'_i$ are of lower rank than $r$. This completes the proof that $\chigmodel$ is relational.
\end{proof}


From the definition of $\chit$, it follows that for any $\chit$-suitable ER model $\gmodel$ there is an injection from the schema of $\gmodel$ to the schema of $\chigmodel$; for each path $p$ in $\gmodel$, therefore, there corresponds a path 
in $\chigmodel$; denote this path by  $I_\gmodel(p)$. Also from the definition, it follows that
if $p:b \morph \veee$ is a path in $\chigmodel$ then there exists a path $\retract(p):b \morph \veee$ in $\gmodel$ such that $I_\gmodel(\retract(p)) \simeq p$ in $\chigmodel$. Finally note that if $\retract(p)$ is a primary key path in $\gmodel$ then there is an attribute $k$ which is a primary key path
in $\chigmodel$ such that $I_\gmodel(p) \simeq k$. 


From this follows the following observation:

\begin{observation}
\llabel{pathinjectionobservation}
For any $\chit$-suitable ER model $\gmodel$ if $p:b \morph \veee$ is a path in $\chigmodel$ and  path $\retract(p):b \morph \veee$ is a primary key path in $\gmodel$  then there is an primary key attribute $k$ in $\chigmodel$ such that $I_\gmodel(p) \simeq k$. 
\end{observation}

\begin{lemma}
\llabel{chiisacertaintypeofisomorphism}
If $\gmodel$ is $\chit$-suitable  then  there is a 
relationship preserving  and reflecting isomorphism $I_\gmodel: \gmodel \morph \chigmodel$ that reflects primary mono-sources.
\end{lemma}
\begin{proof}
TBD \commentary{work on this}
\end{proof}


\begin{lemma}
\llabel{simplecarrythroughlemma}
If $\gmodel$ is $\chit$-suitable and simple then $\chigmodel$ is simple.
\end{lemma}
\begin{proof}
Suppose that in the model $\chigmodel$ there is an attribute $x:a \morph \veee$, a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that$x \simeq r \circ p$ we need show that either 
\begin{enumerate} [(i)]
\item there exists an identifying attribute $q:b \morph \veee$ in $\chigmodel$ such that $p \simeq q$, or
\item the attribute $x$ is identifying in $\chigmodel$.
\end{enumerate}
Assume such $x$, $r$ and $p$ in $\chigmodel$. Then we have 


\begin{center}
\begin{tabular}{c c c c c}
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\simplepatha{$\retract(x)$}{a}{v}
\simplepatha{$r$}{a}{b}
\simplepatha{$\retract(p)$}{b}{v} in $\gmodel$
&&
$ \overset{I}{\mapsto}$
&&
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\ncarr{a}{v} 
\alabel{x}
\simplepatha{$r$}{a}{b}
\simplepatha{$p$}{b}{v} in $\chigmodel$
\end{tabular}
\end{center}


Either $x$ is an existing attribute of $\gmodel$ or it is an attribute $\qq{r' \circ q}$ for some relationship $r'$ and primary key path $q$ of $\gmodel$. \\

In the first case it follows that there is a relationship-like path $r$ in $\gmodel$ 
(lemma \lref{isossurjectiveonrelationshipsaresurjectiveonrelationshiplike}) and a path $\retract(p)$ in $\gmodel$ \commentary{check this} such
that $x \simeq r \circ \retract(p)$ in $\gmodel$ \commentary{Because I is an injection   ... or is it?}. \\

From this because $\gmodel$ is simple it follows that either  $\retract(p)$ is a primary key path in $\gmodel$ and by observation \lref{pathinjectionobservation} that $p$ is a primary key path in $\chigmodel$ \\

\noindent or that $x$ is identifying in $\gmodel$ and therefore that $x$ is identifying\commentary{problem here maybe} in $\chigmodel$, as required.\\

Otherwise, if $x$ is an attribute $\qq{\retract(s) \circ q}$ for some relationship $s$ and primary key path $q$ of $\gmodel$. If $\retract(p)$ is equivalent to a primary key path in $\gmodel$
then we are done for then by observation \lref{pathinjectionobservation} it is equivalent to a primary key path in $\chigmodel$. \\


\noindent If $\retract(p)$ is not equivalent to a primary key path in $\gmodel$ then $\retract(r) \circ \retract(p)$ 
is not attribute-like \commentary{check this} and therefore, contradicting our earlier assumption,  $\qq{\retract(r) \circ q}$ is not an attribute of $\chigmodel$
as $\retract(r) \circ q$ is equivalent to a non attribute-like path.
\end{proof}

\begin{lemma}
\llabel{wocaveatcarrythroughlemma}
If $\gmodel$ is $\chit$-suitable and simple without caveats then $\chigmodel$ is simple without caveats.
\end{lemma}
\begin{proof}
TBD
\vspace{0.5cm}
tbd
\end{proof}


\begin{lemma}
\llabel{inclusiondependencyrestrictionlemma}
If $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$ is a referential inclusion dependency in an ER model $\gmodel$ 
represented by a path $p:a \morph b$ then for each $j$, $1 \leq j \leq n$, $p \circ q_j \leq x_j$
and in each defining instance $E$,
$$E_p \circ E_{q_j} = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j}$$
\end{lemma}
\begin{proof}
For each defining instance $E$
\begin{align*}
E_p \circ E_{q_j} &=  E_{\xntuple} \circ E ^{-1}_{\qntuple} \circ E_{q_j}  && \mbox{since $p$ represents $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$} \\
                  &= E_{\xntuple} \circ p_i                              && \mbox{not obvious -- need justify this} \\                                                                 \\
									&= \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j} && \mbox{by lemma \lref{tupleprojection}.}
\end{align*}
\end{proof}

\begin{definition} 
An  ER model is \term{free of referential attributes} iff 
there does not exist an attribute $x:a \morph \veee$
such that there is a non-empty  path $p:a \morph b$ and a path $q:b \morph \veee$ such that
$x \simeq p \circ q$.
\end{definition}

\begin{definition} 
An  ER model is \term{free of non-identifying referential attributes} iff 
for all attributes $x:a \morph \veee$
such that there is a non-empty  path $p:a \morph b$ and a path $q:b \morph \veee$ such that
$x \simeq p \circ q$ it follows that the attribute $x$ is identifying.
\end{definition}

\begin{lemma}
\llabel{wellformulatedandfreeofdesignredundancyimpliesleafrestrictionfree}
If $\gmodel$ is an ER model which is well-formulated, has the fd factoring property and is free of \newt{design redundancy} \oldt{non-identifying referential attributes}
then it is leaf-restriction free.
\end{lemma}
\begin{proof}
Assume such a model $\gmodel$. To show that it is leaf-restriction free we show that if we assume that there is an
entity type $a$ and an attribute $y$ with domain $a$ and there 
are paths $x_1,...x_n$   with domain
$a$ in $\gmodel$ and codomain $\veee$,  and for some $j$, $1 \leq j \leq n$, in every defining instance $E$, 
\begin{equation}
\label {restriction} 
E_y = \bigwedge_{1 \leq i \leq n}{\overline{E_{x_i}}} \circ E_{x_j}
\end{equation}
then we can deduce that $y \simeq x_j$. Assume then such an attribute $y$ and paths $x_1,...x_n$.  

It follows from lemma \lref{freeofdesignredundancyimpliesfdlhsismonosource} that $\set{\xn}$ is a mono-source
and so in every defining instance $E$ each $E_{x_i}$ is total
and so from (\ref{restriction}) it follows that $E_y = E_{x_j}$ in each defining instance. So, if $\set{\xn}$ is a mono-source
then $y \simeq x_j$, as required.

\iffalse
\begin{oldtt}
Now, from (\ref{restriction}) it follows that
$\set{x_1,...x_n} \morph y$ is a leaf functional dependency in $\gmodel$. Since $\gmodel$ has the fd factoring propery then 
either $\set{\xn}$ is a mono-source 
and we are done or else these exists  paths $x'_1,...x'_{n'}$ such that 
\begin{equation}
\label{noninvertiblefd}
\fd{x_1,...x_n}{x'_1,...x'_{n'}} 
\end{equation}
is a functional dependency and
\begin{equation}
\label{intransitivefd}
\set{x'_1,...x'_{n'}} \morph y
\end{equation}
is a leaf intransitive functional dependency in $\gmodel$.
Since $\gmodel$ is well-formulated  and since (\ref{intransitivefd}) is a leaf intransitive functional dependency  then either $\set{x'_1,...x'_{n'}}$ is a mono-source and thus by lemma \ref{fdrightmonosourceimpliesleftmonosource}
$\set{\xn}$ is a mono-source  and we are done  or else the functional dependency $\set{x'_1,...x'_{n'}} \morph y$   is in part represented by  an entity type $d$ and a primary mono-source $\tuple{q_1,...q_{n'}}$ sourced at $d$, such that $\incd{a}{x'_1,...x'_{n'}}{d}{q_1,...q_{n'}}$ but this cannot be the case because if it were then by lemma \lref{inclusiondependencyrestrictionlemma}
$$E_p \circ E_{q_j} = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n'}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j}$$   \commentary{\LARGE{NO!}}
and we would have that
$$E_p \circ E_{q_j} = E_y$$
in all defining instances so that
$$p \circ q_j \simeq y$$
Since $\gmodel$ is free of non-identifying referential attributes then $y$ is identifying and so $E_y$ is total in all instances $E$ and therefore 
 from (\ref{restriction}) it follows that in any instance $E$, $E_{x_i}$ is total and therefore that $E_y =E_{x_j}$, that is 
$y \simeq x_j$.
 We have shown that from the assumption (\ref{restriction}) it follows that $y \simeq x_j$. Thus we have shown that $\gmodel$ is leaf-restriction free.
\end{oldtt}
\fi
\end{proof}

\begin{lemma}
\llabel{restrictioncarrythroughlemma}
If $\gmodel$ is $\chit$-suitable ER model which is leaf-restriction free then
then $\chigmodel$ is leaf-restriction free.
\end{lemma}
\begin{proof}
Assume such an ER model $\gmodel$ and suppose there is an entyity type $I_\gmodel(a)$ in $\chigmodel$ and an edge $y': I_\gmodel(a) \morph \veee$ and non-empty paths $x'_1,...x'_n$   with domain $I_\gmodel(a)$ in $\chigmodel$,  such that for some $j$, $1 \leq j \leq n$, $x'_j \not\simeq \tuple{}$ and in every defining instance $E'$ of $\chigmodel$  
\begin{equation}
\label{restrictioninchimodel}
E'_{y'} = \bigwedge_{1 \leq i \leq n}{\overline{E'_{x'_i}}} \circ E'_{x'_j}
\end{equation}
We need show  $y' \simeq x'_j$.

There are two cases to consider. First suppose that the edge $y'$ is in the image of $I_\gmodel$, suppose that $y'=I_\gmodel(y)$ for some edge
$y:a \morph \veee$ in $\gmodel$. From the fact that $I_\gmodel$ is an isomorphism of models it follows that for each instance $E$ of  $\gmodel$
$$E_{y} = \bigwedge_{1 \leq i \leq n}{\overline{E_{x_i}}} \circ E_{x_j},$$
where $x_i=I^{-1}_\gmodel(x'_i)$, for each $i$, $1 \leq i \leq n$ and therefore, because $\gmodel$ is leaf-restriction free then we can conclude that
$y \simeq x_j$ in $\gmodel$ and therefore, in this first case, we have that $y' \simeq x'_j$ in $\gmodel'$.


Secondly suppose that $y'$ is of the form $\qq{r \circ q}$ for some relationship $r: a \morph b$ and primary key path $q :b \morph \veee$ in $\gmodel$.
Now it follows from \lref{restrictioninchimodel} that, in $\chigmodel$, $\qq{r \circ q} < x'_j$. Therefore \commentary{what else to add here} 
it follows that $r \circ q < x_j$ in $\gmodel$  where $x_j= I^{-1}_\gmodel(x'_j)$. From this it follows from the definition of $\chigmodel$ that
 $\qq{r \circ q}$ is not an attribute in $\gmodel$ which contradicts the supposition. 

This completes the proof.
\end{proof}

\begin{lemma}
\llabel{wellformulatedandfreeofdesignredundancyimplieschileafrestrictionfree}
If $\gmodel$ is a $\chit$-suitable ER model which is well-formulated, \newt{has the fd factoring property} and \newt{is free of design redundancy} \oldt{has no referential attributes} then $\chigmodel$ is leaf-restriction free.
\end{lemma}
\begin{proof}
Uses lemma  \lref{wellformulatedandfreeofdesignredundancyimpliesleafrestrictionfree} and lemma \lref{restrictioncarrythroughlemma}. 
\vspace{0.5cm}
tbd
\end{proof}

\begin{lemma}
\llabel{wfcarrythroughlemma}
If  $\gmodel$ is $\chit$-suitable and is well-formulated then  $\chigmodel$ is well-formulated. 
\end{lemma}
\begin{proof}
Use lemmas \lref{chiisacertaintypeofisomorphism} and \lref{certainisomorphismspreservewellformulatedness}.
\end{proof}

\begin{lemma}
\llabel{chitlemma}
If  $\gmodel$ is an an ER model that is well-formulated,  $\chit$-suitable, has the fd factoring property 
and is free of non-identifying referential attributes
then the transformed model $\chigmodel$ is a  relational ER model that is well-formulated, simple, leaf-restriction free
and has the fd factoring property.   
Further if $\gmodel$ is free of any referential attributes at all then  $\chigmodel$ is simple without caveats.
\end{lemma}
\begin{proof}
Assume that $\gmodel$ is an an ER model that is well-formulated,  $\chit$-suitable, has the fd factoring property and
is free of non-identifying referential attributes. 

$\chigmodel$ is a  relational ER model by lemma \lref{chimodelisrelational}.

$\chigmodel$ is well-formulated by lemma \lref{wfcarrythroughlemma} since $\gmodel$ is assumed to be well-formulated.

$\chigmodel$ has the fd factoring property by lemma \lref{fdfactoringcarrythroughlemma}  since $\gmodel$ is assumed to have the fd factoring property.

$\chigmodel$ is leaf-restriction free by lemma \lref{wellformulatedandfreeofdesignredundancyimpliesleafrestrictionfree}  since $\gmodel$ is assumed
to be  well-formulated, to have the fd factpring property and to be free of design redundancy.

$\chigmodel$ is simple by lemma \lref{simplecarrythroughlemma} because $\gmodel$ is simple because this follows directly from the definitions because, it is assumed, it is free of non-identifying referential attributes.

Further, if $\gmodel$ is free of any referential attributes at all then it follows directly from definitions that $\gmodel$ is simple without caveats
and hence  that $\chigmodel$ is simple without caveats by lemma \lref{wocaveatcarrythroughlemma}.
\end{proof}

\begin{theorem}
\llabel{goaltheorem}
If  $\gmodel$ is an an ER model that is well-formulated,  $\chit$-suitable and has the fd factoring property
then the transformed model $\chigmodel$ is a  relational ER model. Further
\begin{enumerate}[(i)]
\item  if $\gmodel$ is free of non-identifying referential attributes then  $\chigmodel$ is in third normal form, 
\item 
if $\gmodel$ is free of any referential attributes at all then  $\chigmodel$ is in BCNF.
\end{enumerate}
\end{theorem}
\begin{proof}
Follows from theorem \lref{maintheorem} and lemma \lref{chitlemma} because every simple model is reduced.
\end{proof}

\section{Future Work}

\subsection{Examples}
Examples are presented in a separate document (held in the same folder in Githib). Examples are given of ER models that fail to be well-formulated and how they can be changed so to become well-formulated.  Examples are given of models that do not have the fd factopring property. Some can be modified 
so that then have this property but for others this is not so. 
\subsection{Further Explanation of Current Work}
Explain redundancy for relational models in terms of SQL. 
Explain connection between restriction and SQL Exists operator.
Describe how Codd's definition of normal form for tables having columns which are Nullable is flawed and how this work gives an improved definition. 
Describe inclusion dependency normal form and how this works improves on the definition of ???. Explain problem with previous formulations
in that they cannot deal with, for example, parallel or recursive relationships. 

Explain how transitive functional depdendencies are represented in a well formulated model. 

\subsection{Removing the current restriction to Primary Keys}
Future work will also cover secondary keys, relationships implemented using secondary keys.

\subsection{Higher Normal Forms}
Give definitions of 4th and 5th normal forms and relate to pullbacks and certain other limits.  

\subsection {Abstract ER Models and Reverse Engineering}
We will in future also consider condition for an ER model being maximally abstract from a design specification perspective. We seek to define a transformation from relational models to an abstract models (and for this seconday keys and relationships implemented by secondary keys required). What we look for is a reverse engineering transform from a relational model back to an abstract model so that when we go forward using the $\chi$ transform we get to some equivalent relational model.

\subsection{Hierarchical Data Models}
Describe implementation by hierarchical models (aka distinguishing composition relationships) thus covering XML and IDL.
WE can introduce a second type of universals - the type 'absolute' which is (one version) of the terminal object 1 in the restriction
category. Edges sourced at 1 to the type $\veee$ represent constants. Edges $f: a \morph 1$ which are not total, i.e. for which
$\bar{f} \neq id_a$, correspond to (are one way of representing) boolean attributes.  

Relate goodness criteria with  normal forms proposed in literature for XML. I should be able to generate hierarchical
(think XML) models that are in suitable normal form.

\subsection{Inheritance, Disjunction, Coproducts}
Not really covered what I think of entity models until covered inheritance as coproducts.
Piessens and Steegmans and also Johnson et al have already covered much of this in an interesting way. 
Inheritance maps nicely to IDL and XML but not so nicely to the relational model.  Recursion comes in as well if we want to try deal with models that do not have the fd factoring property.

\subsection{Higher Dimension Data Models}
Is there anything to be said about network models? Certainly there is a connection to Dependency Categories.
Network models are higher dimensional models and we can generate such schemas but is there a practical application?  
 
