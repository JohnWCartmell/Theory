 \section{Introduction}

We  define a notion of entity-relationship (ER) model which in the tradition of Chen\cite{Chen1976} is sufficiently generic to encompass relational, hierarchical and purely logical  notions of data.
The system that we describe involves definition of types of particulars in terms of their relationships with other types, of which there are two kinds, those, such as represent numbers, character strings, booleans and so on, all of whose instances, we say, are universals and the remaining types, the definienda, those types all of whose instances are particulars. Binary many-one relationships which are functional in character are presented as the edges of a directed graph whose nodes comprise both the types of particulars and the types of universals. 

If $u$ is a type all of whose instances are universals then we will refer to each binary many-one functional relationship $f: x \morph u$ as an \term{attribute} of $x$. In relational data modelling such functional relationships are presented as columns of tables. Similarly types all of whose instances are universals  are said to be \textit{attribute types} in entity relational modelling  (though called \textit{attributes} in Johnstone et al.); in the initial work by Chen such types were called \textit{value sets}; they are said to be \textit{domains} in relational data modelling theory. Types of particulars are said to be types of entities or \textit{entity types} in modern entity relationship modelling\footnote{In  his paper  introducing the entity-relationship model Chen explains that his model adopts the view that the real world consists of entities and relationships. He also introduces the  terms \textit{entity set} and \textit{relationship set} for the types of respective entity and relationship particulars. Later authors kept the terms entity and relationship, and the Chen philosophy, but changed the way that the terms were used. In this paper we use the later, post-Chen, terminology.} or sometimes, confusingly, just \textit{entities}  and are modelled as \textit{relational tables} in relational data modelling. For the purposes of the theory presented in this paper there is no loss if we assume a single set $\Veee$ of universals.  We will represent data specifications as directed graphs with some additional information; the nodes of the graph being types, and having a distinguished node $\veee$ representing the type of universals; from a mathematical point of view it is impossible to progress the theory too far without forming an opinion that a data specification is a presentation of a category with some additional structure (as in Johnstone et al.) or, meta-mathematically, that it is an axiomatisation of a theory of some kind. This is so but it must be emphasised that the presentation (i.e. the sketch) is vitally important to the goodness of the data specification for it is the primitives in the presentation that determine the units of storage or communication; removing redundancy from the presentation (or sketch) reduces redundancy in the data and this is one half of relational data theory's  normal form notion of goodness of a data schema (the other half being that the theory be optimally tightened to best fit the facts).

Entity relationship modelling, and, for that matter, relational modelling too, are predicated on the assumption that the particulars described by data correspond uniquely to real world entities and that the data alone is sufficient to establish a 1-1 correspondence. There is thus an implicit assumption that the logical principle of identity of indiscernibles holds of the real world entities and, more specifically, that each type of real world entity has identifying relationships and attributes that distinguish it from  others of the type. In relational data modelling this set of identifying features is represented as a set of columns of the table and is called the primary key. In entity relationship modelling in the style of Barker an identifying feature may be either a relationship or an attribute.   

Regarding directed graphs and reflecting a category theory mindset we will use terminology as follows:
\begin{itemize}
\item
 If $f: a \morph b$ in an edge of a directed graph $G$ then we will say that $a$ is the \term{domain} of $f$ and $b$ is the \term{codomain} of $f$.
\item
If $a$ and $b$ are nodes of a directed graph $G$ then a \term{path} through $G$ with domain $a$ and 
codomain $b$ of length $n$, where $n \geq 0$, we define to be  an n-tuple of  $n$ edges: $p_i: x_i \morph x_{i+1} $ in $G$ where $x_0=a$ and $x_n=b$. We shall write this n-tuple as $p_1 \circ p_2... \circ p_n$. 
We will use the same notation if any of the $p_i$ are edges rather than paths as we will not need distinguish  an edge from a singleton path along that edge. 
\item
If $a$ is a node of a directed graph $G$ then by a \term{source} at $a$ in $G$ we mean a non-empty set of paths in $G$ each with domain $a$.
\end{itemize}

If $A$ is a set and if $J= \setsuchthat{f_i}{ 1\leq i \leq n}$ is a finite set of partial functions, $f_i: A \rightarrow B_i$   for some sets $B_{i, 1 \leq i \leq n}$,  then the set of functions 
$J$ is said to be \term{jointly injective} iff for all $x,y \in A$ it is the case that  if  for each 
$f \in J$, $f(x)=f(y)$ then $x=y$. 
This  is equivalent to saying that  the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ be injective. Note that this also implies that the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ is invertible in the sense that there is a unique partial function $\tuple{f_1,...f_n}^{-1} : s_1 \times ... \times s_n \rightarrow s$ satisfying
\begin{enumerate} [(i)]
\item for all $x \in s$, $\tuple{f_1,...f_n}^{-1}(\tuple{f_1(x),...f_2(x) } ) = x$ and 
\item  if $y \in s_1 \times ... \times s_n $ and
$y \notin img(\tuple{f_1,...f_n})$ then $\tuple{f_1,...f_n}^{-1}(y)$ is undefined. 
\end{enumerate}

If $f: a \morph b$ is a partial function then we shall define the partial function $\bar{f}: a \morph a$ to be the identity function on the set $a$
restricted to the subset of all $x \in a$ such that $f(x)$ is defined\footnote{
This notation is introduced an a more general catehory theory setting by Crockett and ???, [???]}. It follows that if $f: a \morph b$ and $g: a \morph c$ are partial functions
then $\bar{f} \circ \bar{g} = \bar{g} \circ \bar{f}$ and we also write this partial function as $\bar{f} \wedge \bar{g}$ since it represents the intersection
of the domains of definition of $f$ and $g$. Likewise if $f_i:a \morph b_i$ are partial functions for $1 \leq i \leq n$, for some $n$, then we write $\bigwedge\limits_{1 \leq i \leq n}{\bar{f_i}}$ for the intersection of the domains of definition of the $f_i$ i.e. for the composition
$\bar{f_1}\circ \bar{f_2} .../ \circ \bar{f_n}$.

We will have need of the following:
\begin{lemma}
\label{restrictionleftid}
If $f: a \morph b$ is a partial function then $\bar{f} \circ f = f$.
\end{lemma}

\begin{lemma}
\label{inequalityiffrestriction}
If $f: a \morph b$ and  $g: a \morph b$ are partial functions then $f \leq g$ iff $\bar{f}\circ g= f$.
\end{lemma}

\begin{lemma}
\label{tuplerestriction}
If $f_i: a \morph b_i$ are partial functions, for $1 \leq i \leq n$, for some $n$, then $\overline{\tuple{f_1,...f_n}}=\bigwedge\limits_{1 \leq i \leq n}{\bar{f_i}}$.
\end{lemma}

\begin{lemma}
\label{tupleprojection}
If $f_i: a \morph b_i$ are partial functions, for $1 \leq i \leq n$, for some $n$, and if 
$p_i : \prod\limits_{1 \leq i \leq n}{b_i} \morph b_i$ is the i'th projection function 
then  $\tuple{f_1,...f_n} \circ p_i = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq j \leq n}{ j \neq i}}{\bar{f_j}}\circ f_i$, and,
in particular, $\tuple{f_1,...f_n} \circ p_i\leq f_i$ .
\end{lemma}


\section{Definition of ER model}

\begin{definition}
An \term{ER-schema} $S$ is a directed graph having the following additional structure:
\begin{enumerate} [(i)]
\item{a distinguished node $\veee$ for which there are no outgoing edges and which represents the type of universals, }
\item{a distinguished acyclic subset $I$ of edges, called the identifying edges, such that
for every node $a$ other than $\veee$ there is a non-empty set  of identifying edges with domain $a$.
 We denote by $I_a$ the non-empty set of identifying edges leaving an entity type $a$.}
\end{enumerate}
\end{definition}

\begin{definition}
\label{ERschemamapping}
If $\gmodel$ and  $\gmodel'$ are ER schemas then an \term{ER schema mapping} 
$\varphi : \gmodel \morph \gmodel'$ consists of a mapping $\varphi_N$ (abbreviated $\varphi$)from nodes of
$\gmodel$ to nodes of $\gmodel'$ and a mapping $\varphi_N$ (also abbreviated $\varphi$) from 
paths of $\gmodel$ to paths of $\gmodel'$ such that
\begin{itemize}
\item $\varphi(\veee)=\veee$ and for any $a$ if $\varphi(a)=(\veee)$ then
$a = \veee$\commentary{check this},
\item  if $p:a \morph b$ is a path in $\gmodel$ then $\varphi(p):\varphi(a) \morph \varphi(b)$ in $\gmodel'$,
\item the empty path at any node $a$ in $\gmodel$ is mapped to the empty path
on $\varphi(a)$ in $\gmodel'$,
\item if $p: a \morph b$ and $p': b \morph c$ are paths in $\gmodel$
then $\varphi(a \circ b) = \varphi(a) \circ \varphi(b)$ in $\gmodel'$.
\end{itemize}
\end{definition}
 
\begin{definition}
\noindent A \term{database instance}  of an ER schema $S$ is
a set of entities $E_x$ for each node $x$ of $S$ and 
a partial function $E_r : E_x \rightarrow E_y$ for each edge of the graph $r:x \rightarrow y$ 
such that $E_\veee=\Veee$
and such that 
for each node $x$ other than \veee, for each $e \in I_x$ the function $E_e$ is total and
the set of functions $\setsuchthat{E_e}{e \in I_x}$, is jointly injective.
\end{definition}

\noindent For any database instance $E$ we can  extend  the definition of
$E_f$, for edges $f$,  so that to every path $p$, $p: a \rightarrow b$,  we have defined a function $E_p: E_a \rightarrow E_b$. From the initial definition of $E_f$ that applies to 
edges the definition proceeds recursively as follows: 
\begin{enumerate} [(i)]
\item{
For each node $a$, $E_{\tuple{}}: E_a \rightarrow E_a$ is defined to be the identity function.
}
\item{
if $p$ is a path $p: a \rightarrow b$ and $f$ is an edge $p: b \rightarrow c$ then $E_{p \circ f}$  
is defined to be the functional composition $E_p \circ E_f$. \commentary{Define using the n-ary case instead}
}
\end{enumerate}

We can extend this notation further and define $E$ on sources so that if 
$\tuple{p_1,...p_n}$ is a source at entity type $a$ then in an instance E
the function  $E_{\tuple{p_1,...p_n}}$ is defined to be the function mapping each element $e$ 
of $E_a$ to the n-tuple
$\tuple{E_{p_1}(e),...E_{p_n}(e)}$.

\begin{definition}
\noindent An \term{ER model} $\gmodel$ is an ER schema $\gmodel_S$ and a set of database instances of the schema $\gmodel_D$ called the set of
\term{defining instances} of the model. \\
\end{definition}

If $\gmodel$ is an ER-mdel then the nodes of $\gmodel_S$ other than $\veee$ we say are entity types and we denote by $\et$. The set $\attr{a}$ of attributes of an entity type $a$ is defined as the set of edges of $\gmodel_S$ that have 
domain $a$  and  codomain $\veee$.

\subsection{Primary Key Paths}
\label{primarykeypath}
\begin{definition}
If $a$ is an entity type in an entity model $\gmodel$ then a \term{primary key path}
of $a$ is any path $p:a \morph v$ consisting entirely of identifying edges. 
\end{definition}

Denote the set of all primary key paths leaving an entity type $a$ in a model $\gmodel$ by 
$\pk{a}$.

\subsection{Path equivalence}
\label{equivalencedefinition}

\noindent If $r$ and $s$ are paths of a model $\gmodel$ both having domain $a$ and codomain $b$ then we will say $r \leq s$ iff in all defining instances E, for all entities $e \in E_a$, if $E_r(e)$ is defined then $E_s(e)$ is defined and $E_r(e)=E_s(e)$. \\

\noindent If $r$ and $s$ are paths both having source $a$ and destination $b$ then we will say $r \simeq s$ iff $r \leq s$ and $s \leq r$. \\

\noindent With these definitions,  the (meta-relationship) $\leq$ is a partial order on the classes of equivalent paths of a model $\gmodel$. \\

\noindent For paths $r$ and $s$ we define $r < s$ to be equivalent to $r \leq s$ and not $r \simeq s$. \\

\subsection{Equivalence of sets of paths}
\begin{definition}
If $\gmodel$ is a model and if $P$ and $P'$ are sets of paths in $\gmodel$ then say that
$P \simeq P'$ in $\gmodel$ iff
\begin{enumerate}
\item for all $p \in P$ there exists $p' \in P'$ such that $p \simeq p'$ in $\gmodel$,
\item for all $p' \in P'$ there exists $p \in P$ such that $p \simeq p'$ in $\gmodel$.
\end{enumerate} 
\end{definition}

If $P$ is a set of paths of an ER model $\gmodel$ and $\varphi : \gmodel \morph \gmodel'$ is an ER model mapping then we denote by $\varphi(P)$ the set of paths
$\setsuchthat{\varphi(p)}{p \in P}$.

\begin{definition}
\label{ERmodelmapping}
If $\gmodel$ and  $\gmodel'$ are ER models then an \term{ER model mapping}
$\varphi : \gmodel \morph \gmodel'$ consists of an ER schema mapping $\varphi$ from $\gmodel$ and  $\gmodel'$ that satisfies
\begin{itemize}
\item for every entity type $a$ in $\gmodel$, $\varphi(\pk{a}) \simeq \pk{\varphi(a)}$
in $\gmodel'$,
\item  for each defining instance $E'$  of $\gmodel'$ there is a defining instance $E$ of $\gmodel$ such that
\begin{enumerate}
\item for each entity type $a$ of $\gmodel$, $E_a = E'_{\phi(a)}$,
\item for each edge $e:a \morph b$ of $\gmodel$, $E_e = E'_{\varphi(e)}$.
\end{enumerate} 
\end{itemize}
\end{definition}

mappingrespectsequivalence
\begin{lemma}
\label{mappingrespectsequivalence}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if $p$ and $q$ are paths of $\gmodel$ such that $p \simeq q$ in $\gmodel$ then $\varphi(p) \simeq \varphi(q)$ in $\gmodel'$.
\end{lemma}
\begin{proof}
To show that $\varphi(p) \simeq \varphi(q)$ in $\gmodel'$ we need show that for every model $E'$ of $\gmodel'$, $E'_p=E'_q$. But for each such $E'$ there exists a model $E$ of $\gmodel$ such that $E'_p=E_p$ and $E'_q=E_q$ and so the result follows since because since $p\simeq q$ in $\gmodel$, $E_p=E_q$.
\end{proof}
\subsection{Isomorphic Models}

\begin{definition}
A ER model mapping $\varphi: \gmodel \morph \gmodel'$ is said to be an isomorphism
and the models $\gmodel$ and $\gmodel'$ are said to be isomorphic iff there is a ER model mapping $\psi: \gmodel' \morph \gmodel$ such that
\begin{enumerate}[(i)]
\item for each entity type $a$ of $\gmodel$, $\psi(\varphi(a))=a$,
\item for each entity type $a'$ of $\gmodel'$, $\varphi(\psi(a'))=a'$,
\item for each path $p: a \morph b$ of $\gmodel$, $\psi(\varphi(p)) \simeq p$,
\item for each path $p':a' \morph b'$ of $\gmodel'$, $\varphi(\psi(p')) \simeq p'$.
\end{enumerate}
\end{definition}

In section \ref{definitionofrelational} we characterise those ER models which correspond to relational schemas and elsewhere\footnote{TBD} those that correspond to hierarchical schemas. 
We can paraphrase and say that an ER model is relational or hierarchical, in a certain way,  providing it has a sufficiency of referential attributes (foreign keys) for the implementation  of non-compositional relationships. It follows from the definitions that we give that an ER model which doesn't have sufficient 
referential attributes can be extended to one that does by repeated use of the construction indicated in the following definition.
\begin{definition}
If $\gmodel$ is an ER model and if $p:a \morph b$ is a path in $\gmodel$ then define the ER model $\gmodel + \qq{p}$ to be the model whose schema is the schema of $\gmodel$ extended by a single edge with domain $a$ and codomain $b$, denoted $\qq{p}$, and with defining instances corresponding to the defining instances of $\gmodel$ extended to the schema of $\gmodel + \qq{p}$ by defining for each such defining instance $E$, $E_{\qq{p}}=E_p$.
\end{definition} 


The following lemma is straightforward:
\begin{lemma}
If $\gmodel$ is an ER model and if $p:a \morph b$ is a path in $\gmodel$ then
there is an inclusion  $\mathcal{I}$ of the schema of $\gmodel$ in $\gmodel + \qq{p}$. This inclusion is an ER model mapping and is an isomorphism. 
\end{lemma}
\begin{proof}
The inverse mapping $\mathcal{R}$ simply replaces any instances of the edge $\qq{p}$ by the path $p$. The result follows easily and uses the observation that in $\gmodel + \qq{p}$, $p \simeq e$.
\end{proof}


\subsection{Jointly Injective Sets of Functions}
\begin{lemma}
\label{jointlyinjectivecomposition}
If $A$ is a set and if $I$  is a jointly injective set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective.
\end{lemma}
\begin{proof}

\end{proof}

\begin{lemma}
\label{jointlyinjectivefactorisation}
If $A$ is a set and if $I$  a set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then if the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective then the
set $I$ is jointly injective.
\end{lemma}
\begin{proof}
Suppose $x_1,x_2 \in A$ and that for all $f \in I$, $f(x_1)=f(x_2)$. We need show that $x_1=x_2$.
Because $(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective
it suffices to show that 
\begin{enumerate}[(i)]
\item
for all $f \in I \backslash \set{F}$, $f(x_1)=f(x_2)$, 
\item that for all $f \in \setsuchthat{F \circ G}{G \in J}$, $f(x_1)=f(x_2)$
\end{enumerate}
(i) follows directly from the initial assumption. 
(ii) follows because for such an $f$, 
\begin{align*}
f(x_1)&=G(F(x_1)) & & \\
      &=G(F(x_2)) & & \mbox{from the initial assumption since }F \in I \\
			&=f(x_2). & &
\end{align*}
\end{proof}

\subsection{Mono Sources}

The following definition generalises that of super key in the relational model:
\begin{definition}
A source $P$  at an entity type $a$ within a model $\gmodel$ is said to be a \term{mono-source} at entity type $a$ iff each path $p \in P$ has domain $a$ and  in all defining instances E, 
(i) the function $E_p$ is total, for each $p \in P$, and (ii) the set of functions
$\setsuchthat{E_p}{p\in P}$ is jointly injective.
\end{definition}



From the definition of ER model it follows that the set of outgoing edges of an entity type 
$a$ in a model $\gmodel$ is a mono-source. Note also that it follows from this definition that for each entity type $a$ the set containing just
the empty path $\tuple{}$ considered as a path $\tuple{}_a$, leaving $a$, is a mono-source.  
\begin{definition}
A mono source $P$ is said to be a \term{leaf mono-source} iff for path $p \in P$, $p$ has destination $\veee$.
\end{definition}




\subsubsection{Composing mono-sources}

In any directed graph a source $i$ at $a$ that includes a path $f:a \morph b$ can be composed with a source $j$ at $b$ by taking the union of paths in $i$ other than $f$, which we shall denote $i\backslash \set{f}$, and the set $\setsuchthat{f \circ g}{g \in j}$ as illustrated here :

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{1.5cm}ccp{1.5cm}ccp{1.25cm}c}
             & &         & \dotnode[dotsize=1pt]{b1} & &        &                              && \pnode{bracehigh}  \\ [0.3cm]
						 & &         & \dotnode[dotsize=1pt]{b2} & &        &                                \\ [0.3cm]
\Rnode{a}{a} & & \vdots  &                           & &        &                                \\ [0.02cm]
						 & &         &                           & &        & \dotnode[dotsize=1pt]{x1}      \\ [0.1cm]
             & &         & \Rnode{b}{b}              & & \vdots &                                \\ [0.1cm]
             & &         &                           & &        & \dotnode[dotsize=1pt]{xn}   && \pnode{bracelow}   \\ [0.5cm]
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){i}	
	&  &         & 
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){j} & & \\
\end{array}
$
\psbrace[rot=0, nodesepA=10pt, braceWidth=1pt, braceWidthInner=3pt, ,ref=lC](bracelow)(bracehigh)
{$(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$}
\simplepatha{}{b}{x1}
\simplepatha{}{b}{xn}
\simplepatha{}{a}{b1}
\simplepatha{}{a}{b2}
%\simplepatha{}{a}{bn}
\simplepathb{$f$}{a}{b}
\end{center}
.

In the next lemma we show that if $j$ is a mono-source then the above composition of $i$ with $j$ through $f$ is a mono-source iff $i$ is a mono-source.

\begin{lemma}
\label{identifyingsetdeduction}

In a model $\gmodel$, if $i$ is a source with domain $a$,
if $f \in i$, $f: a \morph b$, and if $j$ is a mono-source with domain $b$ then 
$i$ is a mono-source iff $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source.
\end{lemma}
\begin{proof}
First note that from the definition of database instance it follows that 
\begin{equation}
\label{eequivalentsets}
\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}
= \setsuchthat{E_e}{e \in i} \backslash \set{E_f} \cup \setsuchthat{E_f \circ E_g}{g \in j}
\end{equation}

We can show that if $i$ is a mono-source 
then $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source
by showing that for any instance $E$ of $\gmodel$ the family of functions 
$\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}$
is jointly injective. Because of (\ref{eequivalentsets}) this follows by applying lemma \ref{jointlyinjectivecomposition} with $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$.

\textit{Vice-versa}, we can show that if $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source then $i$ is a mono-source by applying lemma \ref{jointlyinjectivefactorisation} 
with, as above, $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$ \commentary{can improve this wording instead of repeating the mapping}.
\end{proof}

From lemma \ref{identifyingsetdeduction} it follows that any set of paths arrived at by repeated composition of mono-sources specified for a model $\gmodel$ in $\setsuchthat{I_a}{a \in \et}$ is itelf a mono-source in $\gmodel$. Denote by $\bar{I}$ the set  of all such mono-sources.

Denote by $\bar{I}_a$ the subset of $\bar{I}$ comprising all mono-sources in $\bar{I}$ with domain $a$.

\subsubsection{Primary Key Paths and Minimality Condition}
\label{minimalitycondition}
 From this definition it follows that $\pk{a} \in \bar{I}$. From this we get the following corollary.


\begin{corollary}
\label{primarykeycorallary}
If $\gmodel$ is an entity model then the set $\pk{a}$of all primary key paths 
with domain entity type $a$ is a mono-source.
\end{corollary}


\begin{definition}
If $P$ and $Q$ are sets of paths of model $\gmodel$ then say that the set of paths $P$ 
\term{is representative of} $Q$ 
iff $P \simeq Q$ and no proper subset of $P$ is equivalent to $Q$.
\end{definition}


\begin{definition}
A model $\gmodel$ satisfies \term{the minimality condition} iff for every entity type $a$,
\begin{enumerate}
\item the set $I_a$ is a minimum mono-source i.e. there is no proper subset which is a mono-source,
\item whenever a set of paths $P$ is representative of the set $\pk{a}$  of primary key paths of $\gmodel$ then no proper subset of $P$ is a mono-source.
\end{enumerate}
\end{definition}


\subsubsection{Primary Mono Sources}
\begin{definition}
If $Q \in \bar{I}_a$ and $Q'$ is representative of $Q$ then $Q'$ is said to be
a \term{primary mono source} at $a$. 
\end{definition}

\subsubsection{Mapping, Isomorphisms and Mono Sources}

monosourceequivalence
\begin{lemma}
\label{monosourceequivalence}
If 
\begin{equation}
\label{putativemonosource}
\set{p_1,...p_n}
\end{equation}
and 
\begin{equation}
\label{putativemonosourcedash}
\set{p'_1,...p'_n}
\end{equation}
 are sources at some object $a$ in an ER model $\gmodel$ and if for each $i$, $1 \leq i \leq n$, $p_i \simeq p'_i$ then in $\gmodel$  (\ref{putativemonosource}) is a mono-source iff (\ref{putativemonosourcedash}) is a mono-source.  Further (\ref{putativemonosource}) is a leaf mono-source iff (\ref{putativemonosourcedash}) is a leaf mono-source and \ref{putativemonosource}) is a primary mono-source iff (\ref{putativemonosourcedash}) is a primary mono-source.
\end{lemma}
\begin{proof}
That (\ref{putativemonosource}) is a mono-source iff (\ref{putativemonosourcedash}) is a mono-source follows from the definition of mono-source since if $p_i \simeq p'_i$ in $\gmodel$ then in each defining instance $E$ of $\gmodel$, $E_{p_i} = E_{p'_i}$.

That (\ref{putativemonosource}) is leaf  iff (\ref{putativemonosourcedash }) is a leaf 
follows because ...

That \ref{putativemonosource}) is primary  iff (\ref{putativemonosourcedash}) is  primary follows because ??????.
\end{proof}

mappingspreservemonosources
\begin{lemma}
\label{mappingspreservemonosources}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if $P$ is a mono-source in $\gmodel$ then  
$\setsuchthat{\phip}{p\in P}$ is a mono-source in $\gmodel'$. 
Further if $P$ a leaf mono-source in $\gmodel$ then $\setsuchthat{\phip}{p\in P}$ is a leaf mono source in $\gmodel'$ and if $P$ a primary mono-source in $\gmodel$ then $\setsuchthat{\phip}{p\in P}$ is a primary mono source in $\gmodel'$.
\end{lemma}
\begin{proof}
To show that $\setsuchthat{\phip}{p\in P}$ is a mono-source in $\gmodel'$ we need show that for every model $E'$ of $\gmodel'$, 
each function $E'_{\phip}$ is total, for each $p \in P$, and that the set
$\setsuchthat{E'_\phip}{p \in P}$ is jointly injective. 
 But for each such $E'$ there exists a model $E$ of $\gmodel$ such that $E'_{\phip}=E_{p}$  and so the result follows because since $P$ is a mono-source in $\gmodel$ and therefore for each $p \in P$, $E_p$ is total and the set $\setsuchthat{E_p}{p\in P}$ is jointly injective.
\end{proof}

isospreserveandreflectmonosources
\begin{lemma}
\label{isospreserveandreflectmonosources}
If $\varphi: \gmodel \morph \gmodel'$ is a isomorphism of ER models and
if $P$ is a source in $\gmodel$ then 
$P$ is a mon-source in $\gmodel$
iff 
$\setsuchthat{\phip}{p\in P}$ is a mono-source in $\gmodel'$. 
Further  $P$ a leaf mono-source in $\gmodel$ iff $\setsuchthat{\phip}{p\in P}$ is a leaf mono source in $\gmodel'$ and $P$ a primary mono-source in $\gmodel$ iff $\setsuchthat{\phip}{p\in P}$ is a primary mono source in $\gmodel'$
\end{lemma}
\begin{proof}
That $P$ is a mono-source implies $\setsuchthat{\phip}{p\in P}$ was proved
in lemma \ref{mappingspreservemonosources}. For the reverse implication use 
lemma \ref{mappingspreservemonosources} applied to the inverse mapping $\varphi^{-1}$
and then use lemma \ref{monosourceequivalence}.
\end{proof}


\subsubsection{Primarily Keyed Models}

One of the characteristics of a relational model is that each of the identifying features of a table is a column
and this translates into our unified framework as each identifying edge of each entity type being an attribute i.e. 
an edge with codomain $\veee$. This leads to this definition: 
\begin{definition}
Say that a model is \term{primarily keyed} iff all identifying edges 
have codomain $\veee$.
\end{definition}
To reach the goal of showing that to every ER model there is an isomorphic relational model we require the following\commentary{is this true?}:
\begin{lemma}
If $\gmodel$ is an ER model then it can be extended to a model $P(\gmodel)$
which is primarily keyed. If $\gmodel$ satisfies the minimality condition then the
extended model $P(\gmodel)$ satisfies the  condition that each set $I_a$ has no proper subsets which are mono-sources. 
\end{lemma}
\begin{proof}
For each entity type $a$ we extend $\gmodel$ by edges $\qq{p}$, where each edge \commentary{work on this}
$\qq{p}$ corresponds to a distinct primary key path $p$ from $a$ to $\veee$
and in the extended model $\gmodel'$ by corollary \ref{primarykeycorallary} 
we can define the identifying set $I'_a$ at $a$ by choosinga set $P_a$ which is representative of the set of all primary key paths from $a$ to $\veee$.
\end{proof}

\subsection{Referential Inclusion Dependencies}
\label{referentialinclusiondependency}

\begin{definition}
If $\gmodel$ is an entity model, 
if $a$ and $b$ are entity types of  $\gmodel$ and  if $\set{q_1,...q_n}$
is a mono-source,
if \fntuple is a tuple of outgoing paths from entity type $a$  
so that we have the following diagram of paths in $\gmodel$
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}ccp{2cm}c}
             & &         & \Rnode{b1}{b_1} &&               \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} &&               \\ [0.2cm]
\Rnode{a}{a} & &         &                 &&  \Rnode{b}{b} \\ [-0.2cm]						
             & &         &    \vdots       &&               \\ [0.2cm]
             & &         & \Rnode{bn}{b_n} &&               \\ 
\end{array}
$
\simplepatha{$f_1$}{a}{b1}
\simplepatha{$f_2$}{a}{b2}
\simplepathb{$f_n$}{a}{bn}
\simplepathb{$q_1$}{b}{b1}
\simplepathb{$q_2$}{b}{b2}
\simplepatha{$q_n$}{b}{bn}
\end{center}
then say that $a$ represented by $\fntuple$ 
has a \term{referential inclusion dependency} with $b$ represented by $\qntuple$, and for which we shall summarily write:
$$
\incd{a}{f_1,...f_n}{b}{q_1,...q_n},
$$
iff in all instances $E$ of $\gmodel$,
$img(E_{\fntuple}) \subseteq img(E_{\qntuple})$. 
\end{definition}

Note that it follows from this definition that for any entity type $a$ there is a trivial
referential inclusion dependency $
\incd{a}{\tuple{}_a}{b}{\tuple{}_a}$

mappingspreservereferentialincds
\begin{lemma}
\label{mappingspreservereferentialincds}
If $\varphi: \gmodel \morph \gmodel'$ is a mapping of ER models and
if 
\begin{equation}
\label{sourcerefincd}
\incd{a}{\fn}{b}{\qn}
\end{equation}
is a referential inclusion dependency in $\gmodel$ then  
\begin{equation}
\label{targetrefincd}
\incd{\phia}{\phifn}{\phib}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$. 

Further if (\ref()) is leaf then (\ref{}) is leaf and
if (\ref()) is primary then (\ref{}) is primary.
\end{lemma}
\begin{proof}
To show that (\ref{targetrefincd}) is a referential inclusion dependency
 in $\gmodel'$ we need show that $\set{\qm}$ is a mono-source, which follows from lemma \ref{mappingspreservemonosources}, and that for every model $E'$ of $\gmodel'$, 
$img(E'_{\fntuple}) \subseteq img(E'_{\qntuple})$. 
This follows because for each such $E'$ there exists a model $E$ of $\gmodel$ such that 
$E'_{\fntuple}=E_{\fntuple}$ and $E'_{\qntuple}=E_{\qntuple}$ and because 
(\ref{sourcerefincd}) is a referential inclusion dependency in $\gmodel$.
\end{proof}


\begin{definition}
Define a \term{primary referential inclusion dependency} to be a
referential inclusion dependency $\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$
such that $\set{q_1,...q_n}$ is a primary mono-source.
\end{definition}

\begin{definition} 
A referential inclusion dependency $\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$ is said to be a \term{leaf
referential inclusion dependency} iff $\set{q_1,...q_n}$ is a leaf mono source.
\end{definition}

incdequivalence
\begin{lemma}
\label{incdequivalence}
If $\gmodel$ is an entity model, 
if $a$ and $b$ are entity types of  $\gmodel$,  if $\set{q_1,...q_n}$
and $\set{q'_1,...q'_n}$ are sources at $b$ , for some $n \geq 1$,
and such that for each $i$, $1 \leq i \leq n$, $q_i \simeq q'_i$  
and if $\set{f_1,...f_n}$ and $\set{f'_1,...f'_n}$ are sources at $a$
such that for each $i$, $1 \leq i \leq n$, $f_i \simeq f'_i$
then. in $\gmodel$, 
$$
\incd{a}{f_1,...f_n}{b}{q_1,...q_n}
$$
is a referential inclusion depdendency iff
$$
\incd{a}{f'_1,...f'_n}{b}{q'_1,...q'_n}
$$
is a referential inclusion dependency.

\end{lemma}
\begin{proof}
Follows immediately from the definitions of path equivalence and of referential inclusion dependency.
\end{proof}


isospreserveandreflectreferentialincds
\begin{lemma}
\label{isospreserveandreflectreferentialincds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  
if $\xn$ and $\qn$ are paths in 
$\gmodel$
then 
\begin{equation}
\label{sourceincd}
\incd{a}{\xn}{b}{\qn}
\end{equation}
is a referential inclusion dependency in $\gmodel$ 
iff 
\begin{equation}
\label{targetincd}
\incd{a}{\phixn}{b}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$. 

Further, (\ref{targetincd}) is  primary  iff (\ref{sourceincd}) is a primary  and (\ref{targetincd}) is  leaf iff (\ref{sourceincd}) is a leaf.
\end{lemma}
\begin{proof}
That (\ref{sourceincd}) is an inclusion dependency in $\gmodel$ implies 
(\ref{targetincd}) is an inclusion dependency in $\gmodel'$ is established in lemma
\ref{mappingspreservereferentialincds}. To establish the reverse implication use lemma
\ref{mappingspreservereferentialincds} applied to the inverse mapping $\varphi^{-1}$
to show that
\begin{equation}
\incd{a}{\phiminusonephixn}{b}{\phiminusonephiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel$ and then use lemma
\ref{incdequivalence}. 

That (\ref{targetincd}) is  primary  iff (\ref{sourceincd}) is a primary 
follows because ????????

That (\ref{targetincd}) is  leaf iff (\ref{sourceincd}) is a leaf follows because ???????????????
\end{proof}

If $\qntuple$ is a mono-source at $a$ then define $E_{\qntuple}^{-1}$ to be the right inverse of
$E_{\qntuple}$ i.e. the unique partial function such that:
$E_{\qntuple} \circ E_{\qntuple}^{-1} = id_{E_a}$

\begin{definition}
We say that a path $p:a \morph b$ \term{represents} a referential inclusion dependency
$\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$  in an ER model $\gmodel$ iff
  in all instances $E$ of $\gmodel$, $E_{\fntuple} \circ E_{\qntuple}^{-1}=E_p$.
\end{definition}
We say that a referential inclusion dependency in model $\gmodel$ is represented in model $\gmodel$ provided that there exists a path which represents it. 

\iffalse
\begin{categoricalaside}
If an ER schema is represented as a category with finite products (\textit{a la} Johnstone \textit{et al}) then
a referential inclusion dependency is a diagram
\begin{center}
$
\begin{array}{cp{0.75cm}c}
   \Rnode{a}{a}     & & \Rnode{x}{x}  \\[1.2cm]     
	                  & & \Rnode{b}{b}  
\end{array}
$
\ncarr{a}{x} 
\alabel{f}[0.33]
\ncarr{b}{x}
\blabel{m}[0.3]
\idcomp
\end{center}
\noindent
in \cat{C} such that in all instance functors $F$, 
$F(f)$ factors through $F(m)$.

Such a referential inclusion dependency is explicitly represented iff
 $f$ factors through $m$ i.e. there is an $f_0: a \morph b$ in \cat{C} such that 
$f_0 \circ m =f$. Note that because $m$ is monic then such an $f_0$ is the unique such morphism and if in some instance $F$,
$e: F(a) \morph F(b)$ is a function such that $e \circ F(m) = F(f)$ then $F(f_0)=e$. 
\end{categoricalaside}
\fi


\begin{definition}
Say that a referential inclusion dependency $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$ is \textit{simple}
iff each $q_i$ is a singleton path, i.e. is simply an edge. 
\end{definition}

simplerepresentationlemma
\begin{lemma}
\label{simplerepresentationlemma}
If  $\gmodel$ is an ER model in which all simple primary referential inclusion dependencies
have representations then all primary referential inclusion dependencies have representations. 
\end{lemma}
\begin{proof}
Proof by induction TBD. Start by drawing a diagram of the inductive step.
\end{proof}



isospreserveandreflectrepresentationsofincds
\begin{lemma}
\label{isospreserveandreflectrepresentationsofincds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  
if $\xn$ and $\qn$ are paths in 
$\gmodel$
and there is a referential  inclusion dependency
\begin{equation}
\label{isosourceincd}
\incd{a}{\xn}{b}{\qn}
\end{equation}
 in $\gmodel$ 
so that also 
\begin{equation}
\label{isotargetincd}
\incd{a}{\phixn}{b}{\phiqn}
\end{equation}
is a referential inclusion dependency in $\gmodel'$
then (\ref{isosourceincd}) is represented in $\gmodel$ 
iff (\ref{isotargetincd}) is represented in $\gmodel'$.
\end{lemma}
\begin{proof}
TBD
\end{proof}


\subsection{Functional Dependencies}

\begin{definition} %functional dependency
In an entity model $\gmodel$  
if for some $n \geq 1$, $a$, $b_{i}, 1 \leq i \leq n$,  and $c$ are nodes and 
if  $x_{i, 1 \leq i \leq n}$, and $y$ are paths such
that for each $i$, $x_i : a \rightarrow b_i$, and such that $y: a \rightarrow c$ 
as shown here:
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}cc}
             & &         & \Rnode{b1}{b_1} \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} \\ [0.6cm]
						 & & \vdots  &                 \\ [0.2cm]
\Rnode{a}{a} & &         & \Rnode{bn}{b_n} \\ [1.0cm]
             & &         & \Rnode{c}{c}   \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\end{center}


\noindent 
then path $y$ is said to be \term{functionally dependent} on the set of paths $\{x_1,...x_n\}$ in model $\gmodel$, 
for which  we write  \sfd{x_1,...x_n}{y},
iff
 in each defining instance $E$ of $\gmodel$ there exists a  partial 
function $f_E: E_{b_1} \times E_{b_n} \rightarrow E_c$ 
\noindent such that 
domain of $f_E \subseteq img(E_{\tuple{x_1,... x_n }})$ 
and  
$E_{\xntuple} \circ f_E = E_y$ 
\begin{center}
$
\begin{array}{cp{2cm}ccp{0.5cm}cc}
						    & &         & \Rnode{Eb1}{E_{b_1}}& &                            &        \\ [0.6cm]
						    & &         & \Rnode{Eb2}{E_{b_2}}& &                            &        \\ [0.6cm]
						    & &\vdots  &                      & &                            &        \\ [0.2cm]												
\Rnode{Ea}{E_a} & &         & \Rnode{Ebn}{E_{b_n}}& & \Rnode{Jnctn}{}&  \\ [1.0cm]
						    & &         & \Rnode{Ec}{{E_c}}   & &                            &        \\
\end{array}
$
\simplepatha{$E_{x_1}$}{Ea}{Eb1}
\simplepatha{$E_{x_2}$}{Ea}{Eb2}
\simplepatha{$E_{x_n}$}{Ea}{Ebn}
\simplepathb{$E_y$}{Ea}{Ec}
\nchmarr[15][45]{Eb1}{Ebn}{Jnctn}{Ec}
\naput[npos=-0.1]{$f_E$}
\ncarc[arcangle=15]{Eb2}{Jnctn}
\end{center}
\end{definition}

\begin{remark}
In the above definition, if within an instance $E$ there does exist such a partial function $f_E$ then $f_E$ will be the unique such partial function. For if partial function $f'_E$ is another such then given a $\tuple{E_{x_1}(e),...E_{x_n}(e)} \in img(E_{\tuple{x_1,...x_n}})$
we have that $f_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})=E_y(e)=f'_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})$.
\end{remark}

\begin{definition}
A functional dependency \sfd{x_1,...x_n}{y} is said to be \term{trivial} iff $y\simeq x_i$, for some $i$, $1 \leq i \leq n$.
\end{definition}

mappingspreservefds
\begin{lemma}
\label{mappingspreservefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model mapping from $\gmodel$  to $\gmodel'$,  if $\xn$ and $y$ are paths in $\gmodel$
and there is a  functional dependency
\begin{equation}
\label{carrythrusourcefd}
\fd{\xn}{y}
\end{equation} 
in $\gmodel$ then there is a functional dependency
\begin{equation}
\label{carrythrutargetfd}
\fd{\phixn}{\phiy}
\end{equation}
in $\gmodel'$.
Further if (\ref{carrythrusourcefd}) is trivial then (\ref{carrythrutargetfd}) is trivial.
\end{lemma}
\begin{proof}
Assume a functional dependency (\ref{carrythrusourcefd})  in $\gmodel$. To show that (\ref{carrythrutargetfd}) is a functional dependency in $\gmodel'$
we need show that in every model $E'$ 
of $\gmodel'$ there is a partial function $f_{E'}$ such that
\begin{equation}
\label{fdcarrythrucond1}
\mbox{domain of }f_{E'} \subseteq img(E'_{\tuple{\phixn}})
\end{equation}
and
\begin{equation}
\label{fdcarrythrucond2}
E'_{\tuple{\phixn}} \circ f_{E'} = E'_{\phiy}
\end{equation}
Assume then a model $E'$ of $\gmodel'$. 
Since $\varphi$ is an ER model mapping then there exists a model $E$ of $\gmodel$ such that 
$E_{\tuple{\xn}} = E'_{\tuple{\phixn}}$ and $E_y = E'_{\phiy}$. From the assumption that (\ref{carrythrusourcefd})
is a functional dependency in $\gmodel$ it follows that there exists a  partial function $f_E$ such that
$\mbox{domain of }f_{E} \subseteq img(E_{\tuple{\xn}})$
and
$E_{\tuple{\xn}} \circ f_{E} = E_y$ 
i.e. such that 
$\mbox{domain of }f_{E} \subseteq img(E_{\tuple{\phixn}})$
and
$E_{\tuple{\phixn}} \circ f_{E} = E_{\phiy}$.  The partial function $f_E$ therefore 
meets the conditions (\ref{fdcarrythrucond1}) and (\ref{fdcarrythrucond2}) that
we require of $f_{E'}$ and so we can choose the required partial function
$f_{E'}$ to be the partial function $f_E$. 
The further point regarding triviality follows from lemma \ref{mappingrespectsequivalence}.
\end{proof}




\begin{definition}
A functional dependency \sfd{x_1,...x_n}{y} is said to be a \term{leaf functional dependency} iff
 the codomain of each $x_i$, $1 \leq i \leq n$, is $\veee$.
\end{definition}

\begin{definition}
In an entity model $\gmodel$, if
$a$ is an entity type and $\set{x_1,...x_n}$ and $\set{y_1,...y_m}$ are sets of paths with source $a$
then we say the set $\set{y_1,...y_m}$ \textit{is functionally dependent on the set} $\set{x_1,...x_n}$ and write
\fd{x_1,...x_n}{y_1,...y_m} 
iff  each $y_j$, $1 \leq j \leq m$, is functionally dependent on $\set{x_1,...x_n}$.
\end{definition}
\begin{definition} %transitive
In an entity model $\gmodel$, a functional dependency $\set{x_1,...x_n} \morph z$
is said to be \term{transitive} if there exists a set of paths $\{y_1,...y_{m}\}$ such that
$\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ and there is a non-trivial functional
dependency $\set{y_1,...y_{m}} \morph z$ but there is no functional dependency 
$\{y_1,...y_{m}\} \morph \{x_1,...x_n\}$.
\end{definition}
\begin{definition} %intransitive
In an entity model $\gmodel$, a functional dependency $\set{x_1,...x_n} \morph y$
is said to be \term{intransitive} if it is not transitive.
\end{definition} 

fdequivalence
\begin{lemma}
\label{fdequivalence}
If for some $n \geq 1$, $\xn$ and $\wanton{x'}$,  are paths in an ER model $\gmodel$
such that for each $i$, $1 \leq i \leq n$, $x_i \simeq x'_i$,
if $y$ and $y'$ are also paths in $\gmodel$ and are 
such that $y \simeq y'$ in $\gmodel$ then $\fd{\xn}{y}$ is a functional dependency in $\gmodel$ iff 
$\fd{\wanton{x'}}{y'}$ is a functional dependency in $\gmodel$.
\end{lemma}
\begin{proof}
Follows immediately from the definitions of path equivalence and of functional dependency.
\end{proof}
isospreserveandreflectfds
\begin{lemma}
\label{isospreserveandreflectfds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $y$ are paths in $\gmodel$
then there is a  functional dependency
\begin{equation}
\label{sourcefd}
\fd{\xn}{y}
\end{equation} 
in $\gmodel$ iff there is a functional dependency
\begin{equation}
\label{targetfd}
\fd{\phixn}{\phiy}
\end{equation}
in $\gmodel'$.
Further(\ref{sourcefd}) is  leaf  iff (\ref{targetfd}) is a leaf.

\end{lemma}
\begin{proof}
\vspace{0.5cm}
That (\ref{sourcefd}) is a functional dependency implies
(\ref{targetfd}) is a functional dependency has been shown in lemma \ref{mappingspreservefds}. That (\ref{targetfd}) is a functional dependency implies
(\ref{sourcefd}) is a functional dependency follows by using lemma 
 \ref{mappingspreservefds}
on the inverse mapping $\varphi^{-1}$ and by using lemma  \ref{fdequivalence}.

(\ref{sourcefd}) is  leaf  iff (\ref{targetfd}) is a leaf 
because for any node $a$ of $\gmodel$, $a= \veee$ in $\gmodel$ iff $\varphi(a)=\veee$ in $\gmodel'$.
\end{proof}

isospreserveandreflectmultiplefds:
\begin{corollary}
\label{isospreserveandreflectmultiplefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $\ym$ are paths 
in $\gmodel$
then there is a  functional dependency
\begin{equation}
\label{multiplesourcefd}
\fd{\xn}{\ym}
\end{equation} 
in $\gmodel$ iff there is a functional dependency
\begin{equation}
\label{multipletargetfd}
\fd{\phixn}{\phiym}
\end{equation}
in $\gmodel'$.
Further (\ref{multiplesourcefd}) is reversible iff (\ref{multipletargetfd}) is reversible.
\end{corollary}

isospreserveandreflecttransitivefds:
\begin{lemma}
\label{isospreserveandreflecttransitivefds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $z$ are paths in $\gmodel$
and there is a  functional dependency
\begin{equation}
\label{transitivesourcefd}
\fd{\xn}{z}
\end{equation} 
in $\gmodel$
so that
\begin{equation}
\label{transitivetargetfd}
\fd{\phixn}{\phiz}
\end{equation}
is a functional dependency in $\gmodel'$then:
\begin{enumerate}
\item (\ref{transitivesourcefd}) is  transitive iff (\ref{transitivetargetfd}) is transitive, 
\item (\ref{transitivesourcefd}) is  intransitive iff (\ref{transitivetargetfd}) is intransitive,

\end{enumerate}
\end{lemma}
\begin{proof}
\vspace{0.5cm}
(\ref{transitivesourcefd}) is transitive implies (\ref{transitivetargetfd}) 
is trasitive because if (\ref{transitivesourcefd}) is transitive is transitive then
there exists $\ym$ such that
\fd{\xn}{\ym} is an irreversible functional dependency
and such that \fd{\ym}{z} is a non-trivial functional dependency.
From lemma \ref{isospreserveandreflectmultiplefds} this implies that in $\gmodel'$ there is an 
\fd{\phixn}{\phiym} irreversible functional dependency \fd{\phixn}{\phiym}
and by lemma \ref{isospreserveandreflectfds} there is a non-trivial functional dependency \fd{\phiym}{\phiz}. Hence it follows
the function dependency (\ref{transitivetargetfd}) is transitive.

That (\ref{transitivesourcefd}) is  intransitive iff (\ref{transitivetargetfd}) follows on directly because an instransitive functional depdency is a functional depdency that is not transitive.

Finally, a path $p$ represents (\ref{sourcefd}) in $\gmodel$ iff $\varphi(p)$ represents (\ref{targetfd}) in $\gmodel'$
because

\end{proof}

\begin{lemma}
\label{transitiveinjectivelemma}
In an entity model $\gmodel$ if $\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ is a functional dependency then if in an instance $E$ the function $E_{\tuple{y_1,...y_{m}}}$ is injective then the function $E_{\tuple{x_1,...x_n}}$  is injective.
\end{lemma}
\begin{proof}
Follows from the definition of functional dependency that for each $j$, $1 \leq j \leq m$  there is a function ${f_j}$,  such that
$E_{y_j}=E_{\tuple{x_1,...x_n}}\circ f_j$. Therefore there is a function $f=\tuple{f_1,...f_m}$ such that
$E_{\tuple{y_1,...y_m}}= E_{\tuple{x_1,...x_n}}\circ f $. Therefore since  the function $E_{\tuple{y_1,...y_{m}}}$ is 
injective then the function $E_{\tuple{x_1,...x_n}}$  is injective.
\end{proof}

\begin{definition}
\noindent In an entity model $\gmodel$  
if for some $n \geq 1$, $a$, $b_{i, 1 \leq i \leq n}$,  and $c$ are nodes and 
if  $x_{i}, 1 \leq i \leq n$, and $y$ are paths such
that there is a intransitive functional dependency $\{x_1,...x_n\} \morph y$
 then the functional dependency $\{x_1,...x_n\} \morph y$ is said to be \term{represented} in the ER model $\gmodel$ iff  there exists an entity type $d$ and a primary mono-source
$\qntuple$  such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$, and a (possibly empty)
path $w:d\rightarrow c$ as here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{b1}{b_1} & &               \\ [0.7cm]
						 &  & \Rnode{b2}{b_2} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{bn}{b_n} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\simplepathb{$q_1$}{d}{b1}
\simplepathb{$q_2$}{d}{b2}
\simplepathb{$q_n$}{d}{bn}
\simplepatha{$w$}{d}{c}
\end{center}

and such that in all defining instances $E$, 
$\tuple{ E_{x_1},...E_{x_n}} \circ E^{-1}_{\tuple{q_1,...q_n}}\circ E_w = E_y$
\end{definition}

Note that  if $x$ is a path, $x:a \morph b$, and $y$ is a path, $y: a \morph c$, and if $w$ is a
relationship $w: b \morph c$ so that there is a functional dependency $\sfd{x}{y}$ in $\gmodel$
given in any instance $E$ by the function $E_w$. This functional dependency is represented in the model, according to the above definition, because the mono-source in the definition, i.e the $\set{q_1,...q_n}$,
can be taken to be the singleton consisting of the empty path $\tuple{}_b$. \\

isospreserveandreflectrepresentationsoffds
\begin{lemma}
\label{isospreserveandreflectrepresentationsoffds}
If $\gmodel$ and $\gmodel'$ are ER models and  if  $\varphi$ is an ER model isomorphism between $\gmodel$  and $\gmodel'$,  if $\xn$ and $z$ are paths in $\gmodel$
and there is an  intransitive functional dependency
\begin{equation}
\label{representationsourcefd}
\fd{\xn}{z}
\end{equation} 
in $\gmodel$
so that
\begin{equation}
\label{representationtargetfd}
\fd{\phixn}{\phiz}
\end{equation}
is an intransitive  functional dependency in $\gmodel'$then
(\ref{representationsourcefd}) is represented in $\gmodel$ iff
(\ref{representationtargetfd}) is represented in $\gmodel'$.
\end{lemma}
\begin{proof}
TBD
\end{proof}

\subsection{ER model Goodness Conditions}\
\begin{definition}
\noindent An ER model $\gmodel$ is \term{well-formulated} 
 iff 
\begin{enumerate} [(i)]
\item{
it satisfies the minimality condition (see section \ref{minimalitycondition}),
}
\item{ 
each primary referential inclusion dependency of $\gmodel$ is represented in $\gmodel$ by some path $p$ \footnote{Equivalently, by lemma
\ref{simplerepresentationlemma}, sufficient that all simple primary referential inclusion dependencies of $\gmodel$ be represented.},
}
\item{ 
each leaf primary referential inclusion dependency of $\gmodel$ is represented in $\gmodel$ by some relationship-like path $p$, 
}
\item{
for each leaf intransitive functional dependency $\set{x_1,...x_n} \morph y$ in model $\gmodel$
either in every defining instance $E$, $E_{\xntuple}$ is injective and total
or else the functional dependency is represented in the model.
}
\end{enumerate}
\end{definition}

\begin{definition}
An ER model $\gmodel$ is \term{restriction-free} iff for all entity types $a$ of $\gmodel$ and for all edges $y$ with domain $a$, if there 
exists paths $x_1,...x_n$   with domain
$a$ in $\gmodel$,  and for some $j$, $1 \leq j \leq n$, in every defining instance $E$,  
$$E_y = \bigwedge_{1 \leq i \leq n}{\overline{x_i}} \circ x_j$$
then $y \simeq x_j$.
\end{definition}

\begin{definition}
In an ER model $\gmodel$, a non-empty path $p: a \morph b$, where $a$ and $b$ are entity types, which consists
of a relationship $R$ followed by a  path $t :a' \morph b$ is said to be \term{relationship-like} iff
either  $t$ is the empty path (so that the path $p$ is exactly a relationship $R$) or $t$
is a non-empty path and has the property that for all primary key paths $q:b \morph \veee$ there exists 
a primary key path $q':a' \morph \veee$ such that $t \circ q \simeq q'$.
\end{definition}

\begin{lemma}
\label{intransitivelemma}
In a well-formed model $\gmodel$  if $\set{x_1,...x_n} \morph y$  is a non-trivial intransitive leaf
functional dependency sourced at some entity type $a$ then either $E_{\xntuple}$ is injective and total in every defining instance $E$ 
or else for some entity type $d$ there is a non-empty relationship-like path $p:a \rightarrow d$ such that $\{x_1,...x_n\} \morph p$
and a  path $w:d \morph c$  such that $y \simeq p \circ w$. If $c$ is $\veee$ then
the path $w$ is non-empty and if $y$ is an edge and $\gmodel$ is leaf\commentary{check leaf is right} restriction-free then $w$ is not equivalent to a primary key path.
\end{lemma}
\begin{proof}
Since $\gmodel$ is well formed  and there is an intransitive functional dependency $\set{x_1,...x_n} \morph y$ then either $E_{\xntuple}$ is injective and total in every defining instance $E$  and we are done or else the functional dependency
$\set{x_1,...x_n} \morph y$   is represented 
by  an entity type $d$ and 
a primary mono-source $\qntuple$ with respect to
$d$, such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$ and a 
path $w:d\rightarrow c$ as shown here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{v1}{\veee} & &               \\ [0.7cm]
						 &  & \Rnode{v2}{\veee} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{vm}{\veee} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$x_1$}{a}{v1}
\simplepatha{$x_2$}{a}{v2}
\simplepatha{$x_n$}{a}{vm}
\simplepathb{$y$}{a}{c}
\simplepathb{$q_1$}{d}{v1}
\simplepathb{$q_2$}{d}{v2}
\simplepathb{$q_n$}{d}{vm}
\simplepatha{$w$}{d}{c}
\end{center}
such that
\begin{equation}
\label{fundependency}
E_y = E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_w
\end{equation}

Because $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$,  and from
clause (iii) of the definition of well-formedness since $\gmodel$ is well formed, it follows that
there  is a relationship-like path $p:a \rightarrow d$ such
that 
%\foreachi, $p \circ q_i \simeq x_i$ and therefore
in all defining instances $E$,

\begin{equation}
\label{incdependency}
E_{\xntuple} \circ E^{-1}_{\qntuple} = E_p
\end{equation}
Now we have  that in all defining instances $E$ that 
\begin{align*}
E_y &= E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_w  && \text{ (\ref{fundependency}), above,}\\
    &= E_p \circ E_w                                   && \text{by (\ref{incdependency}),}\\
		&= E_{p \circ w}                                   && \text{from defn. of instance }E.\\
\end{align*} 
\vspace{-0.3cm}
From which, by definition, $y\simeq p \circ w$, as required. \\

Now suppose that $c$ is the type representing universals $\veee$. The path $w$ must be non-empty because its source $d$ being 
an entity type must be distinct from its destination $\veee$ which is not an entity type. 
We wish to show that $w$ is not equivalent in $\gmodel$ to
a primary key path. Assume the contrary that $w$ is a primary key path. From the following lemma it follows that $w \simeq q_i$, for some
$i$, $1 \leq i \leq n$.  
Therefore
\begin{align*}
E_y &= E_p \circ E_w                                        && \text{}\\
		&= E_p \circ E_{q_i}                                      && \text{}\\
		&= E_{\xntuple} \circ E_{\qntuple}^{-1} \circ E_{q_i}     && \text{}\\
		&= E_{\xntuple} \circ p_i                                 && \text{} \\
		&= \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq j \leq n}{ j \neq i}}{\overline{E_{x_j}}}\circ E_{x_i}  
		                                                        && \text{By lemma \ref{tupleprojection}}
\end{align*} 

Hence because $\gmodel$ is leaf \commentary{check leaf} restriction-free we deduce that $y \simeq x_i$ and this contradicts the assumption that the functional dependency
is non-trivial. Thus $w$ is not equivalent to a primary key path.
\end{proof}

\begin{lemma}
If for some $m \geq 1$, $\qmtuple$ is a primary mono-source at $b$ such that for each $j$, $1 \leq j \leq m$, $q_j : b \morph b_j$,
and if  $p$ is a primary key path such that $p: b \morph \veee$   
then there exists $j$, $1 \leq j \leq m$ and there exists $p'$, $p': b_j \morph \veee$ such that $p \simeq q_j \circ p'$.
\end{lemma}
\begin{proof}
Follows from the next lemma.
\end{proof}

\begin{lemma}
If $Q \in \bar{I_a}$ and if $p$ is a primary key path at $a$ then for some node $b$ there exists $q \in Q$, $q: a \morph b$, and there exists 
a path $q'$, $q': b \morph \veee$,  all of whose edges are identifying and such that $q \circ q' = p$. 
\end{lemma}
\begin{proof}
How to make this observation a proof?.
\end{proof}

\begin{definition}
\noindent An ER model $\gmodel$ has the \term{\fdfactoring} property iff to every functional dependency $\set{x_1,...x_n} \morph z$ where $x1, x_2, ... x_n$ and $z$ are \attributelike\ paths either $\set{x_1,...x_n}$ is
a mono-source or else there is an intransitive functional dependency $\set{y_1,...y_m} \morph z$ which it factors through i.e. such that $\set{x_1,...x_n} \morph \set{y_1,...y_m}$
\end{definition}

\begin{lemma}
\label{fdfactoringcarrythroughlemma}
If two models are isomorphic then one has the fd factoring property iff the other one does.
\commentary{Previously:If  $\gmodel$ is $\chit$-suitable and has the $\fdfactoring$ property then so to does $\chigmodel$. }
\end{lemma}
\begin{proof}
Use lemma \ref{isospreserveandreflectfds}.
\vspace{0.5cm}
tbd
\end{proof}


\begin{lemma}
\label{mainlemma}
In a well-formed model $\gmodel$ that has the \fdfactoring\ property if $\{x_1,...x_n\} \morph z$ is a non-trivial leaf functional dependency sourced
at some entity type $a$ then either $E_{\xntuple}$ is injective and total in every defining instance $E$ 
or else there is an entity type $d$ and there is a relationship-like path $p:a \rightarrow d$ such that $\{x_1,...x_n\} \morph p$
and a  path $w:d \morph c$  such that $y \simeq p \circ w$. If $c$ is $\veee$ then
the path $w$ is non-empty and and if $y$ is an edge and $\gmodel$ is restriction-free then $w$ is not equivalent to a primary key path(see section \ref{primarykeypath} for definition of 'primary key path').
\end{lemma}
\begin{proof}
Since the model $\gmodel$  has the \fdfactoring\ property, the functional dependency $\set{x_1,...x_n} \morph z$ can be factored through an intransitive functional
dependency $\set{y_1,...y_m} \morph z$. Therefore by lemma \ref{intransitivelemma} either there exists $d$, $p$ and $w$ as required
or else in each defining instance $E$, $E_{\ymtuple}$ is injective and total in which case, by lemma \ref{transitiveinjectivelemma}, $E_{\xntuple}$ is injective and total as required.
\end{proof}

\subsection{Ranking Relationships in an ER Model}
For every ER model $\gmodel$ and for each natural number $n$, $n \geq 0$, we define which relationships of
$\gmodel$ are of rank $n$. We do this  in such a way that each relationship of $\gmodel$ either has a rank $n$, for some $n \geq 0$, or if it is not of rank 
$n$ for any $n$, is said to be unranked or of null rank. Denote by $\gmodel_n$ the ER model which is the ER model 
$\gmodel$ less the relationships which are not of rank less than or equal to n. The definition proceeds by induction as follows:
\begin{definition}
The relationship $R: a \morph b$ in an entity model $\gmodel$ is said to be of rank $1$\commentary{was rank 0  -- check} iff whenever 
$\qntuple$ is a primary mono-source at $b$ in $\gmodel$, where $q_i:b \morph \veee$, for each $i$, $1 \leq i \leq n$  then there exists attributes $x_i:a \morph v$ in $\gmodel$ such that $\incd{a}{\xntuple}{b}{\qntuple}$ is an inclusion dependency and this inclusion dependency is represented by the relationship $R$. 
The relationship $R: a \morph b$ in an entity model $\gmodel$ is said to be of rank $n+1$ iff whenever 
$\qntuple$ is a primary mono-source at $b$ in $\gmodel$, there exists paths $p_i:a \morph v$ in $\gmodel_n$ such that $\incd{a}{\pntuple}{b}{\qntuple}$ is an inclusion dependency and this inclusion dependency  is represented by the relationship $R$. 
\end{definition}

\section{Relational Models}
\label{definitionofrelational}
Generally a relational schema is defined to consist of a finite set of relations each consisting of a
finite set of attributes along with a set of semantic constraints. The latter may include functional dependencies or keys and key attributes and inclusion dependencies.  We restrict our attention, for the time being, to those schemas in which for each relation there is a subset of its attributes that comprise a primary key and between these relations there are defined  a set of inclusion dependencies of the 
form $\incd{R}{X}{S}{K}$ where $S$ is a relation and $K$ is the primary key of $S$.
Any inclusion dependency of the form $\incd{R}{X}{S}{K}$ where $S$ is a relation and $K$ is a key for that relation is called a \term{keyed inclusion dependency} (see Levene and Vincent) or a \term{referential constraint} (SQL ISO standard).
If $K$ is the primary key we shall say that such an inclusion dependency is a \term{primary referential constraint}. If $R$ is a relation having primary key consisting
of $X_1,X_2,...X_n$ and attributes $Y_1,...Y_m$ in addition to the primary key 
 then we shall write the relation as $R(\underline{X_1},...,\underline{X_n},Y_1,...Y_m)$.

It is usually the case that attributes are annotated with specific domains of values but for our purpose we can assume that each attribute is $v$-valued where $v$ is our type of universals for domains play no role in the theory with which we concern ourselves here.
\subsection{Definition of Primary Relational ER Model}
The terms \term{primary referential inclusion dependency} and 
\term{simple referential inclusion dependency} were given in 
section \ref{referentialinclusiondependency}. These are used in the following definition:
\begin{definition}
\noindent 
A \term{primary relational ER model} is an  ER model that also satisfies:
\begin{enumerate}[(i)]
\item
it is primarily keyed i.e. all identifying edges are attributes, 
\item
all relationships are ranked i.e. there are no relationships of null rank,
\item 
for each primary referential inclusion dependency there is a unique relationship which represents it.
\end{enumerate} 
\end{definition}

Such a primary relational ER model $\gmodel$ gives rise to relational schema:
\begin{itemize}
\item relations (tables) of the relational schema correspond to entity types of $\gmodel$,
\item attributes (columns) of a relation $a$ correspond to attributes of $a$ in $\gmodel$, 
\item an attribute is part of the primary key iff the corresponding edge of $\gmodel$ is identifying,
\item a keyed referential constraint is defined to correspond to every simple primary referential inclusion dependency of $\gmodel$ i.e. to correspond to every relationship of $\gmodel$. 
\end{itemize}

The characteristic instances of such an ER model gives rise to a set of database instances of the corresponding relational schema.

Likewise every relational schema that consists of relations with primary keys and primary referential constraints and has a set of characteristic database instances gives rise to an isomorphic\commentary{check} primary relational ER model. 

For the time being we restrict attention to primary relational ER models which stand-in for us for a large class of relational schemas. 

\subsection{Attribute Redundancy}
\begin{definition}
In a relational ER model $\gmodel$ an attribute $x: a \morph v$ is said to be \term{redundant} if
there exists a path $p$ in model $\gmodel - x$ such that $p \simeq x$ and such that $\gmodel - x$ is 
a relational ER model.  
\end{definition}
\begin{definition}
Say that a relational ER model $\gmodel$ is \term{free of attribute redundancy} iff none of its attributes are redundant.
\end{definition}


\subsection{Normal Forms}

\noindent One measure of the goodness of a relational model is whether it satisfies the condition called Boyce Codd Normal Form (BCNF). In some modelling situations this condition cannot be 
met and in these situations a lesser goodness criteria that can be achieved is that of Third Normal Form (3NF). We shall show that the relational model $\chigmodel$ generated from a well-formulated 
ER model $\gmodel$ satisfies a strong form of 3NF as follows:

\begin{definition} % TNF
A relational ER model $\gmodel$ is in Strong Third Normal Form (S3NF)  iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  there is a non-trivial functional dependency \sfd{x_1,...x_n}{y}, 
in all instances $E$  of $\gmodel$, either the function $E_{<x_1,...x_n>}$ is injective and total
or else $y$ is identifying.
\end{definition}

We shall also show that with a single additional condition on $\gmodel$, which it may or not be possible to achieve in a given modelling situation,
the generated model $\chigmodel$ satisfies the BCNF condition.
Written in the terminology we are using here BCNF can be defined as follows:
\begin{definition} % BCNF
A relational ER model is in Boyce Codd Normal Form (BCNF) \commentary{See Zaniolo definition 2.} iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  there is a non-trivial functional dependency \sfd{x_1,...x_n}{y}, 
in all instances $E$  of $\gmodel$, the function $E_{<x_1,...x_n>}$ is injective and total.  
\end{definition}

\noindent The next lemma simplifies the requirement for showing BCNF to consideration of non-trivial
intransitive functional dependencies:
\begin{lemma}
\label{BCNFsublemma}
If a model $\gmodel$ has the \fdfactoring\ property then it is in BCNF iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which there is an non trivial  intransitive functional dependency \sfd{x_1,...x_n}{y},
in all instances $E$, $E_{<x_1,...x_n>}$ is injective and total. 
\end{lemma}
\begin{proof}Use lemma \ref{transitiveinjectivelemma}.
\end{proof}
\begin{lemma}
\label{S3NFsublemma}
If a model $\gmodel$ has the \fdfactoring\ property then it is in S3NF iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which there is an non trivial intransitive functional dependency \sfd{x_1,...x_n}{y},
in all instances $E$, $E_{<x_1,...x_n>}$ is injective and total or $y$ is a primary key. 
\end{lemma}
\subsection{Other Conditions for Relational ER models}
\begin{definition} 
An ER model is \term{reduced} iff for all attributes $x:a \morph \veee$
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$, as here,
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\ncarr{a}{v} 
\alabel{x}
\simplepatha{$r$}{a}{b}
%\ncarr{a}{b} 
%\blabel{r}
\simplepatha{$p$}{b}{v}
%\ncarr{b}{v} 
%\blabel{p}
\end{center}

then it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path \commentary{was an identifying attribute} $q:b \morph \veee$ such that $p \simeq q$, or
\item the path $r$ is a mono-source, or
\item the attribute $x$ is identifying.
\end{enumerate}
\end{definition}

In a relational ER model $\gmodel$ if there are no identifying attributes $x$ such that $x \simeq r \circ p$ where $r$ is relationship-like, $r:a \morph a'$, and $p$ is a not a primary key path, $p:a' \morph \veee$ then the model is said to be \term{without caveats}.

Thus we get:
\begin{definition} 
An ER model $\gmodel$ is \term{reduced without caveat} iff for all attributes $x:a \morph \veee$
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$ it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path \commentary{an identifying attribute} $q:b \morph \veee$ such that $p \simeq q$, or
\item the path $r$ is a mono-source.
\end{enumerate}
\end{definition}

\subsection{Main Theorem}
\noindent Now for the main theorem:
\begin{theorem}
\label{maintheorem}
\noindent If a relational ER model $\gmodel$ is well-formulated and restriction-free, has the \fdfactoring\ property and is reduced then it is in Strong Third Normal Form. 
If  $\gmodel$ is reduced without caveats then is in Boyce-Codd Normal form.
\end{theorem}
\begin{proof}
To prove S3NF it suffices, by lemma \ref{S3NFsublemma},  to show that if 
$\sfd{x_1,...x_n}{y}$ is a non-trivial intransitive functional dependency of model $\gmodel$
where $x_1,...x_n,y$ are attributes 
then  in all instances
$E$ of $\gmodel$, $E_{<x_1,...x_n>}$ is injective and total or that $y$
is identifying. \\
Assume then such a functional dependency.
From the assumption that the model $\gmodel$ is well-formulated and restriction-free
then by lemma \ref{mainlemma} 
either $E_{\tuple{x_1,...x_n }}$ is
injective and total in every instance $E$ of $\gmodel$ and we are done
or else there is a non-empty relationship-like path $r$ in $\gmodel$
and a path $w$ of $\gmodel$ that is not a primary key path such that
\begin{equation}
\label{simpleRepresentation}
 E_r \circ E_w = E_y
\end{equation}
and such that $\sfd{x_1,...x_n}{r}$.
If the model $\gmodel$ is assumed to be reduced without caveat then either $r$ is a mono-source since $w$ is not equivalent to some primary key of $d$.
Since $r$ is a mono-source then $x_1,...x_n$ is a mono source, as required, since $\sfd{x_1,...x_n}{r}$ and we have established BCNF.
With the weaker assumption that the model $\gmodel$ is reduced, there is the additional possibility that $y$ is identifying i.e. is a primary key attribute and we have proved S3NF.
\end{proof}
\subsection{Simple Relational Models}
It is unusual in practice for reduced relational models not to meet the stronger condition that we get if we drop condition (iii) 
from the definition of a model being reduced. We shall say such models are \term{simple} and so these are defined as follows:
\begin{definition} 
An \commentary{was relational} ER model is \term{simple} iff for all attributes $x:a \morph \veee$
such that there is a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that
$x \simeq r \circ p$ it follows that 
either 
\begin{enumerate} [(i)]
\item there exists a primary key path \commentary{an identifying attribute} $q:b \morph \veee$ such that $p \simeq q$, or
\item the attribute $x$ is identifying.
\end{enumerate}
\end{definition}

In the next sections we define a transformation that from an \commentary{what adjectives ought I to insert here?}ER model generates a simple relational ER model.

\section{Chi Transform - a Revised Chen Transformation}
In this section we define a relational  entity model $\chigmodel$ that corresponds
to suitable ER models $\gmodel$. The $\chit$ transformation that we so describe is a refinement
of a transformation which we denote $\firstcut$ that was first described by Chen and subsequently prescribed in a range of software design methodologies and accordingly implemented in associated CASE tools. The transformation $\firstcut$ is sometimes said to produce a first-cut relational design because generally the model produced requires normalisation
to achieve an appropriate database normal form such as 3NF or BCNF. 
In contrast we shall show that the transformation $\chit$ defined here produces relational models $\chigmodel$ that are in 3NF and, if appropriate, BCNF and are free of attribute redundancy.

From an ER model $\gmodel$ a first-cut relational design $\firstcut(\gmodel)$ is achieved by extending each
entity type $a$, by attributes,  one for each path in $\gmodel$ of the 
form $\tuple{r_0,r_1,...r_n}$ where each of $r_1,...r_n$ are identifying. 

The transformation $\firstcut$ can be improved to by taking note of equivalent attribute-like paths and
either dropping duplicates or, equally, thinking of the added attributes as corresponding to equivalence classes of 
equivalent attribute-like paths wrt the equivalence relation $\simeq$ defined earlier (section \ref{xxx}). This improved transformation we can denote as $\firstcutimproved$.

This consideration leads  to this definition:
\begin{definition}
A path $r=r_0/r_1/r)2.../r_n$, for some $n$, $n \geq 0$, in an ER model $\gmodel$ is 
said to be \term{attribute-like} iff $r: a \morph \veee$, for some entity type $a$,
and either $n=0$ or $\tuple{r_1,...r_n}$ is a primary key path i.e. each $r_i$ is identifying.
\end{definition}
\begin{noteforfuture}
In most general case this will become not $s_1$ uses $s_2$ ... uses $s_m$.
\end{noteforfuture}
If $\gmodel$ is an ER model then the model $\firstcutimproved(\gmodel)$ is defined to be the ER model whose schema extends the schema of $\gmodel$
by extending the set of attributes of each entity type $a$ by the set 
$\set{\qq{r_0/r_1/...r_n}  | \ r_0/r_1/...r_n: a \morph \veee \mbox{ is an attribute-like path}}$ and for which the defining instances are the defining  instances $E$ of $\gmodel$ extended to the schema of $\firstcutimproved(\gmodel)$ by defining for each attribute $\qq{r_0/r_1/...r_n}$, $E_{\qq{r_0/r_1/...r_n}} = E_{r_0} \circ E_{r_1}... \circ E_{r_n}$.

We define the model $\chigmodel$ to be a further improvement to the first-cut transformation obtained by excluding  from  the transformed model $\firstcutimproved(\gmodel)$ those attributes $\qq{r \circ q}$ for which there exists a unique  path $s$ such that  either  $r \circ q < s$ or $s$ is non attribute-like and $r \circ q \simeq s$. 

\begin{definition}
If for some relationship $r$ and primary key path $q$ of $\gmodel$ there exists a  path $s_1/...s_n$ such that either   $r \circ q < s_1/...s_n$ or $s_1/...s_n$ is non attribute-like and $r \circ q \simeq s_1/...s_n$ or $r \circ q < s_1/...s_n$ then say that relationship $r$ \term{directly depends} on relationship $s_i$,
for each $i$. Define one relationship to depend on another if it depends on it it directly or indirectly i.e. define dependency between relationships to be the transitive closure of direct dependency.
\end{definition}

For $\chigmodel$ to be a relational model, the implied dependency between relationships of $\gmodel$ will need be non-circular
and in addition one further property is required:

\begin{definition}
An ER model $\gmodel$ is said to have \term{property X} iff for all relationships $r: a \morph b$ in $\gmodel$ there exists at least
one primary key path $q:a \morph \veee$ such that there does not exist a non attribute-like path $s:a \morph \veee$ such that
$r \circ q < s$.
\end{definition}

If these conditions are met (attribute-like paths have at most one equivalent non attribute-like path, implied dependencies are non-circular and property X holds) then we say that $\gmodel$ is $\chit$-suitable and in these instances we can show that 
the model $\chigmodel$ is a simple relational model. 

We shall show that with these definitions if $\gmodel$ is well-formulated, simple, $\chit$-suitable and has the fd factoring property
then the transformed model $\chigmodel$ is a well-formulated, simple, restriction-free relational ER model with the fd factoring property which is therefore in S3NF.  Further we will show that if $\gmodel$ is without caveats then $\chigmodel$ is also without caveats and is therefore in BCNF. 

\begin{lemma}
If $\gmodel$ is $\chit$-suitable then $\chigmodel$ is a relational model.
\end{lemma}
\begin{proof}
The relationships $r: a \morph b$ of $\chigmodel$ are exactly those of $\gmodel$. If such a relationship does not directly depend on any path $s$ of $\gmodel$ then define its rank to be $1$.
If instead a relationship $r$ directly depends onone or more paths of $\gmodel$ then define its rank to be 1 greater than the maximum rank of the relationships it depends on. 
This defintion is sound because dependency is non-circular.
The relationship $r$ represents the inclusion dependency $\incd{a}{r \circ q_1,...r \circ q_n}{b}{q_1,...q_n}$ in $\gmodel$ therefore it represents
the inclusion dependency $\incd{a}{p_1,...p_n}{b}{q_1,...q_n}$ where 
$$
p_i =
\begin{cases} 
    s_i         & \mbox{if $s_i$ is a path which either dominates path $r \circ q_i$ in $\gmodel$} \\
    s_i         & \mbox{if $s_i$ is a non-attribute-like path and is equivalent to  $r \circ q_i$ in $\gmodel$ }  \\
    r \circ q_i & \mbox{if there is no such $s_i$.}
\end{cases} 
$$
It follows then that in $\chigmodel$ the relationship $r$ is represented by inclusion dependency $\incd{a}{p'_1,...p'_n}{b}{q_1,...q_n}$ where
$$
p'_i =
\begin{cases}
   s_i     & \mbox{if $s_i$ is a path which either dominates path $r \circ q_i$ in $\gmodel$} \\
   s_i     & \mbox{if $s_i$ is a on-attribute-like path and is equivalent to  $r \circ q_i$ in $\gmodel$ }  \\
   \qq{r \circ q_i}  & \mbox{if there is no such $s_i$.}
\end{cases} 
$$
Therefore each relationship $r: a \morph b$ $\chigmodel$ is represented by an referential inclusion dependency $\incd{a}{p'_1,...p'_n}{b}{q_1,...q_n}$
where the paths $p'_i$ are of lower rank than $r$. This completes the proof that $\chigmodel$ is relational.
\end{proof}


From the definition of $\chit$, it follows that for any $\chit$-suitable ER model $\gmodel$ there is an injection from the schema of $\gmodel$ to the schema of $\chigmodel$; for each path $p$ in $\gmodel$, therefore, there corresponds a path 
in $\chigmodel$; denote this path by  $I_\gmodel(p)$. Also from the definition, it follows that
if $p:b \morph \veee$ is a path in $\chigmodel$ then there exists a path $\retract(p):b \morph \veee$ in $\gmodel$ such that $I_\gmodel(\retract(p)) \simeq p$ in $\chigmodel$. Finally note that if $\retract(p)$ is a primary key path in $\gmodel$ then there is an attribute $k$ which is a primary key path
in $\chigmodel$ such that $I_\gmodel(p) \simeq k$. 

From this follows the following observation:

\begin{observation}
\label{pathinjectionobservation}
For any $\chit$-suitable ER model $\gmodel$ if $p:b \morph \veee$ is a path in $\chigmodel$ and  path $\retract(p):b \morph \veee$ is a primary key path in $\gmodel$  such that $I_\gmodel(\retract(p)) \simeq p$ then there is an primary key attribute $k$ in $\chigmodel$ such that $I_\gmodel(p) \simeq k$. 
\end{observation}

\begin{lemma}
\label{relationshiplikecarrythroughlemma}
If $\gmodel$ is $\chit$-suitable  and $r:a \morph b$ is a path in $\gmodel$ then $r$ is relationship-like in $\gmodel$ iff $r$ is relationship-like in $\chigmodel$ .\commentary{Check this}
\end{lemma}
\begin{proof}
TBD
\vspace{0.5cm}
tbd
\end{proof}


\begin{lemma}
\label{simplecarrythroughlemma}
If $\gmodel$ is $\chit$-suitable and simple then $\chigmodel$ is simple.
\end{lemma}
\begin{proof}
Suppose that in the model $\chigmodel$ there is an attribute $x:a \morph \veee$, a relationship-like path $r:a \morph b$ and a path $p:b \morph \veee$ such that$x \simeq r \circ p$ we need show that either 
\begin{enumerate} [(i)]
\item there exists an identifying attribute $q:b \morph \veee$ in $\chigmodel$ such that $p \simeq q$, or
\item the attribute $x$ is identifying in $\chigmodel$.
\end{enumerate}
Assume such $x$, $r$ and $p$ in $\chigmodel$. Then we have 


\begin{center}
\begin{tabular}{c c c c c}
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\simplepatha{$\retract(x)$}{a}{v}
\simplepatha{$r$}{a}{b}
\simplepatha{$\retract(p)$}{b}{v} in $\gmodel$
&&
$ \overset{I}{\mapsto}$
&&
$
\begin{array}{cp{0.5cm}c p{0.5cm} c}
\Rnode{a}{a} &  &              & & \Rnode{v}{\veee}  \\ [1cm]
             &  & \Rnode{b}{b} & &               
\end{array}
$
\ncarr{a}{v} 
\alabel{x}
\simplepatha{$r$}{a}{b}
\simplepatha{$p$}{b}{v} in $\chigmodel$
\end{tabular}
\end{center}


Either $x$ is an existing attribute of $\gmodel$ or it is an attribute $\qq{r' \circ q}$ for some relationship $r'$ and primary key path $q$ of $\gmodel$. \\

In the first case it follows that there is a relationship-like path $r$ in $\gmodel$ 
(lemma \ref{relationshiplikecarrythroughlemma}) and a path $\retract(p)$ in $\gmodel$ \commentary{check this} such
that $x \simeq r \circ \retract(p)$ in $\gmodel$ \commentary{Because I is an injection   ... or is it?}. \\

From this because $\gmodel$ is simple it follows that either  $\retract(p)$ is a primary key path in $\gmodel$ and by observation \ref{pathinjectionobservation} that $p$ is a primary key path in $\chigmodel$ \\

\noindent or that $x$ is identifying in $\gmodel$ and therefore that $x$ is identifying\commentary{problem here maybe} in $\chigmodel$, as required.\\

Otherwise, if $x$ is an attribute $\qq{\retract(r) \circ q}$ for some relationship $r$ and primary key path $q$ of $\gmodel$. If $\retract(p)$ is equivalent to a primary key path in $\gmodel$
then we are done for then by observation \ref{pathinjectionobservation} it is equivalent to a primary key path in $\chigmodel$. \\


\noindent If $\retract(p)$ is not equivalent to a primary key path in $\gmodel$ then $\retract(r) \circ \retract(p)$ 
is not attribute-like \commentary{check this} and therefore, contradicting our earlier assumption,  $\qq{\retract(r) \circ q}$ is not an attribute of $\chigmodel$
as $\retract(r) \circ q$ is equivalent to a non attribute-like path.
\end{proof}

\begin{lemma}
\label{wocaveatcarrythroughlemma}
If $\gmodel$ is $\chit$-suitable and simple without caveats then $\chigmodel$ is simple without caveats.
\end{lemma}
\begin{proof}
TBD
\vspace{0.5cm}
tbd
\end{proof}


\begin{lemma}
\label{inclusiondependencyrestrictionlemma}
If $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$ is a referential inclusion dependencyin an ER model $\gmodel$ 
represented by a path $p:a \morph b$ then for each $i$, $1 \leq j \leq n$, $p \circ q_j \leq x_j$
and in each defining instance $E$,
$$E_p \circ E_{q_j} = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j}$$
\end{lemma}
\begin{proof}
For each defining instance $E$
\begin{align*}
E_p \circ E_{q_j} &=  E_{\xntuple} \circ E ^{-1}_{\qntuple} \circ E_{q_j}  && \mbox{since $p$ represents $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$} \\
                  &= E_{\xntuple} \circ p_i                              && \mbox{not obvious -- need justify this} \\                                                                 \\
									&= \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j} && \mbox{by lemma \ref{tupleprojection}.}
\end{align*}
\end{proof}

\begin{lemma}
\label{logicalisrestrictionfreelemma}
If $\gmodel$ is an ER model which is well-formulated and has no referential attributes\commentary{without logical redundancy?} 
then it is leaf-restriction free.
\end{lemma}
\begin{proof}
Suppose $\gmodel$ has a leaf-restriction. So there exists an
entity type $a$ and an attribute $y$ with domain $a$ and there 
exists paths $x_1,...x_n$   with domain
$a$ in $\gmodel$,  and for some $j$, $1 \leq j \leq n$, in every defining instance $E$,  
$$E_y = \bigwedge_{1 \leq i \leq n}{\overline{x_i}} \circ x_j$$then $y \simeq x_j$. In particular
$\set{x_1,...x_n} \morph y$ is a leaf intransitive functional dependency\commentary{Fill this out a bit since might be flab}. 

Since $\gmodel$ is well formed  and there is a leaf intransitive functional dependency $\set{x_1,...x_n} \morph y$ then either $E_{\xntuple}$ is injective and total in every defining instance $E$  in which case $y \simeq x_j$  and we are done \commentary{why?} or else the functional dependency $\set{x_1,...x_n} \morph y$   is in part represented by  an entity type $d$ and a primary mono-source $\qntuple$ with respect to$d$, such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$ but this cannot be the case because if it were then by lemma \ref{inclusiondependencyrestrictionlemma}
$$E_p \circ E_{q_j} = \bigwedge\limits_{\genfrac{}{}{0pt}{}{1 \leq i \leq n}{ i \neq j}}{\overline{E_{x_i}}}\circ E_{x_j}$$
and we woud have that
$$E_p \circ E_{q_j} = E_y$$
in all defining instances so that
$$p \circ q_j \simeq y$$
contradicting that $\gmodel$ is free of unnecessary edges\commentary{what does this mean?}. 
\end{proof}

\begin{lemma}
\label{restrictioncarrythroughlemma}
If $\gmodel$ is $\chit$-suitable ER model which is well-formulated and has no referential attributes 
then $\chigmodel$ is leaf-restriction free.
\end{lemma}
\begin{proof}
Uses lemma  \ref{logicalisrestrictionfreelemma}.
\vspace{0.5cm}
tbd
\end{proof}







\begin{lemma}
\label{wfcarrythroughlemma}
If  $\gmodel$ is $\chit$-suitable and is well-formulated then  $\chigmodel$ is well-formulated. 
\end{lemma}
\begin{proof}
Use lemma \ref{isospreserveandreflectfds}.
\vspace{0.5cm}
tbd
\end{proof}




\begin{lemma}
\label{injectivecarrythroughlemma}
If $E_{\tuple{x_1,...x_n }}$ is\commentary{Not required is it?}
injective and total in every defining instance $E$ of $\gmodel$ then $\chit(E)_{\tuple{\inject{x}_1,...\inject{x}_n }}$ is
injective and total in every defining instance $\chit(E)$ of $\chigmodel$.
\commentary{When emphasis is shifted to isomorpic models then this lemma should be obvious as to become not worth stating.}
\end{lemma}


\begin{theorem}
\label{chitheorem}
If $\gmodel$ is well-formulated, simple, $\chit$-suitable and has the fd factoring property
then the transformed model $\chigmodel$ is a well-formulated, simple, restriction-free relational ER model with the fd factoring property.   
If $\gmodel$ is without caveats then $\chigmodel$ is also without caveat.
\end{theorem}
\begin{proof}
Follows from lemmas \ref{simplecarrythroughlemma}, \ref{wocaveatcarrythroughlemma}, \ref{wfcarrythroughlemma} and
\ref{fdfactoringcarrythroughlemma}.
\end{proof}

\begin{corollary}
\label{goalcorollary}
If $\gmodel$ is well-formulated, simple, $\chit$-suitable and has the fd factoring property
then the transformed model $\chigmodel$ is a  relational ER model in third normal form.  
If $\gmodel$ is simple without caveats then $\chigmodel$ is in BCNF.
\end{corollary}
\begin{proof}
Follows from theorems \ref{maintheorem} and \ref{chitheorem} because every simple model is reduced.
\end{proof}
