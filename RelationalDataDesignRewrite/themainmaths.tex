 \section{Introduction}

We  define a notion of entity-relationship (ER) model which in the tradition of Chen [] is sufficiently generic to encompass relational, hierarchical and purely logical  notions of data.
The system that we describe involves definition of types of particulars in terms of their relationships with other types, of which there are two kinds, those, such as represent numbers, character strings, booleans and so on, all of whose instances, we say, are universals and the remaining types, the definienda, those types all of whose instances are particulars. Binary many-one relationships which are functional in character are presented as the edges of a directed graph whose nodes comprise all types - both the types of particulars and the types of universals. 

If $u$ is a type all of whose instances are universals then we will refer to each binary many-one functional relationship $f: x \morph u$ as an \term{attribute} of $x$. In relational data modelling such functional relationships are presented as columns of tables. Similarly types all of whose instances are universals  are said to be \textit{attribute types} in entity relational modelling  (though called \textit{attributes} in Johnstone et al.); in the initial work by  Chen such types were called \textit{value sets}; they are said to be \textit{domains} in relational data modelling theory. Types of particulars are said to be types of entities or \textit{entity types} in modern entity relational modelling\footnote{In  his paper  introducing the entity-relationship model Chen explains that his model adopts the view that the real world consists of entities and relationships. He also introduces the  terms \textit{entity set} and \textit{relationship set} for the types of respective entity and relationship particulars. Later authors kept the terms entity and relationship, and the Chen philosophy, but changed the way that the terms were used. In this paper we use the later, post-Chen, terminology.} or sometimes, confusingly, just \textit{entities}  and are modelled as \textit{relational tables} in relational data modelling. For the purposes of the theory presented in this paper there is no loss if we assume a single set $\Veee$ of universals.  We will represent data specifications as directed graphs with some additional information; the nodes of the graph being types, and having a distinguished node $\veee$ representing the type of universals; from a mathematical point of view it is impossible to progress the theory too far without forming an opinion that a data specification is a presentation of a category with some additional structure (as in Johnstone et al.) or, meta-mathematically, that it is an axiomatisation of a theory of some kind. This is so but it must be emphasised that the presentation (i.e. the sketch) is vitally important to the goodness of the data specification for it is the primitives in the presentation that determine the units of storage or communication; removing redundancy from the presentation (or sketch) reduces redundancy in the data and this is one half of relational data theory's  normal form notion of goodness of a data schema (the other half being that the theory be optimally tightened to best fit the facts).

Entity relationship modelling, and, for that matter, relational modelling too, are predicated on the assumption that the particulars described by data correspond uniquely to real world entities and that the data alone is sufficient to establish a 1-1 correspondence. There is an implicit assumption that the logical principle of identity of indiscernibles holds of the real world entities and it is assumed more specifically that each type of real world entity has identifying relationships and attributes that distinguish it from  others of the type. In relational data modelling this set of identifying features is represented as a set of columns of the table and is called the primary key. In entity relationship modelling in the style of Barker each identifying feature may be either a relationship or an attribute.   

Regarding directed graphs we will use terminology as follows. If $f: a \morph b$ in an edge of a directed graph $G$ then we will say that $a$ is the \term{domain} of $f$ and $b$ is the \term{codomain} of $f$.

If $a$ and $b$ are nodes of a directed graph $G$ then a \term{path} through $G$ with domain $a$ and 
codomain $b$ of length $n$, where $n \geq 0$, we define to be  an n-tuple of  $n$ edges: $p_i: x_i \morph x_{i+1} $ in $G$ where $x_0=a$ and $x_n=b$. We shall write this n-tuple as $p_1/p_2.../p_n$; if 
$p$ is a path with domain $a$ and codomain $b$ and if $f$ is an edge with domain $b$ and codomain
$c$ the path which is $p$ followed by $f$ aand has domain $a$ and codomain $c$ we will write as $p/f$.
If $a$ is a node of a directed graph $G$ then by a \term{source} at $a$ in $G$ we mean a non-empty set of paths in $G$ each with domain $a$.

Finally, if $A$ is a set and if $J= \setsuchthat{f_i}{ 1\leq i \leq n}$ is a finite set of partial functions, $f_i: A \rightarrow B_i$   for some sets $B_{i, 1 \leq i \leq n}$,  then the set of functions 
$J$ is said to be \term{jointly injective} iff for all $x,y \in A$ it is the case that  if  for each 
$f \in J$, $f(x)=f(y)$ then $x=y$. 
This  is equivalent to saying that  the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ be injective. Note that this also implies that the partial function $\tuple{f_1,...f_n}: s \rightarrow s_1 \times ... \times s_n $ is invertible in the sense that there is a unique partial function $\tuple{f_1,...f_n}^{-1} : s_1 \times ... \times s_n \rightarrow s$ satisfying
\begin{enumerate} [(i)]
\item for all $x \in s$, $\tuple{f_1,...f_n}^{-1}(\tuple{f_1(x),...f_2(x) } ) = x$ and 
\item  if $y \in s_1 \times ... \times s_n $ and
$y \notin img(\tuple{f_1,...f_n})$ then $\tuple{f_1,...f_n}^{-1}(y)$ is undefined. 
\end{enumerate}
 
\section{Definition of ER model}

\begin{definition}
An \term{ER-schema} $S$ is a directed graph having the following additional structure:
\begin{enumerate} [(i)]
\item{a distinguished node $\veee$ for which there are no outgoing edges and which represents the type of universals, }
\item{a distinguished acyclic subset $I$ of edges, called the identifying edges, such that
for every node $a$ other than $\veee$ there is a non-empty set  of identifying edges with domain $a$.
 We denote by $I_a$ the non-empty set of identifying edges leaving an entity type $a$.}
\end{enumerate}
\end{definition}
 
\begin{definition}
\noindent A \term{database instance}  of an ER schema $S$ is
a set of entities $E_x$ for each node $x$ of $S$ and 
a partial function $E_r : E_x \rightarrow E_y$ for each edge of the graph $r:x \rightarrow y$ 
such that $E_\veee=\Veee$
and such that 
for each node $x$ other than \veee, for each $e \in I_x$ the function $E_e$ is total and
the set of functions $\setsuchthat{E_e}{e \in I_x}$, is jointly injective.
\end{definition}

\noindent For any database instance $E$ we can  extend  the definition of
$E_f$, for edges $f$,  so that to every path $p$, $p: a \rightarrow b$,  we have defined a function $E_p: E_a \rightarrow E_b$. From the initial definition of $E_f$ that applies to 
edges the definition proceeds recursively as follows: 
\begin{enumerate} [(i)]
\item{  For each node $a$, $E_{\tuple{}}: E_a \rightarrow E_a$ is defined to be the identity function.
}
\item{   if $p$ is a path $p: a \rightarrow b$ and $f$ is an edge $p: b \rightarrow c$ then $E_{p/f}$  
is defined to be the functional composition $E_p \circ E_f$. 
}
\end{enumerate}

We can extend this notation further and define $E$ on n-tuples of paths so that if 
$\tuple{p_1,...p_n}$ is an n-tuple of paths from entity type $a$ then in an instance E
the function  $E_{\tuple{p_1,...p_n}}$ is defined to be the function mapping each element $e$ 
of $E_a$ to the n-tuple
$\tuple{E_{p_1}(e),...E_{p_n}(e)}$.

\begin{definition}
\noindent An \term{ER model} $\genericmodel$ is an ER schema $\genericmodel_S$ and a set of database instances of the schema $\genericmodel_D$ called the set of
\term{defining instances} of the model. \\
\end{definition}

If $\genericmodel$ is an ER-mdel then the nodes of $\genericmodel_S$ other than $\veee$ we say are entity types and we denote by $\et$.The set $\attr{a}$ of attributes of an entity type $a$ is defined as the set of edges of $\genericmodel_S$ that have 
domain $a$  and  codomain $\veee$.

\subsection{Path equivalence}

\noindent If $r$ and $s$ are paths of a model $\genericmodel$ both having domain $a$ and codomain $b$ then we will say $r \leq s$ iff in all defining instances E, for all entities $e \in E_a$, if $E_r(e)$ is defined then $E_s(e)$ is defined and $E_r(e)=E_s(e)$. \\

\noindent If $r$ and $s$ are paths both having source $a$ and destination $b$ then we will say $r \simeq s$ iff $r \leq s$ and $s \leq r$. \\

\noindent With these definitions,  the (meta-relationship) $\leq$ is a partial order on the classes of equivalent paths. \\

\noindent For paths $r$ and $s$ we define $r < s$ to be equivalent to $r \leq s$ and not $r \simeq s$. \\

\subsection{Jointly Injective Sets of Functions}
\begin{lemma}
\label{jointlyinjectivecomposition}
If $A$ is a set and if $I$  is a jointly injective set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective.
\end{lemma}
\begin{proof}

\end{proof}

\begin{lemma}
\label{jointlyinjectivefactorisation}
If $A$ is a set and if $I$  a set of functions with domain $A$, if $F \in I$, $F: A \morph B$ is a function,
and if $J$ is a jointly injective set of functions with domain $B$ then if the set of functions
$(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective then the
set $I$ is jointly injective.
\end{lemma}
\begin{proof}
Suppose $x_1,x_2 \in A$ and that for all $f \in I$, $f(x_1)=f(x_2)$. We need show that $x_1=x_2$.
Because $(I \backslash \set{F}) \cup \setsuchthat{F \circ G}{G \in J}$ is jointly injective
it suffices to show that 
\begin{enumerate}[(i)]
\item
for all $f \in I \backslash \set{F}$, $f(x_1)=f(x_2)$, 
\item that for all $f \in \setsuchthat{F \circ G}{G \in J}$, $f(x_1)=f(x_2)$
\end{enumerate}
(i) follows directly from the initial assumption. 
(ii) follows because for such an $f$, 
\begin{align*}
f(x_1)&=G(F(x_1) & & \\
      &=G(F(x_2) & & \mbox{from the initial assumption since }F \in I \\
			&=f(x_2). & &
\end{align*}
\end{proof}
\subsection{Identifying Sets}

The following definition generalises that of super key in the relational model:
\begin{definition}
A set of paths $P$  within a model $\genericmodel$ is said to be a \term{mono-source} at entity type $a$
iff each path $p \in P$ has domain $a$ and  in all defining instances E, 
(i) the function $E_p$ is total, for each $p \in P$, and (ii) the set of functions
$\setsuchthat{E_p}{p\in P}$ is jointly injective.
\end{definition}

From the definition of ER model it follows that the set of outgoing edges of an entity type 
$a$ in a model $\genericmodel$ is a mono-source. 
\subsubsection{Primary Key Paths}
\begin{definition}
If $a$ is an entity type in an entity model $\genericmodel$ then a \term{primary key path}
of $a$ is any path $p:a \morph v$ consisting entirely of identifying edges. 
\end{definition}

Denote the set of all primary key paths leaving an entity type $a$ in a model $\genericmodel$ by 
$\pk{a}$.

\subsubsection{Equivalent Models}

First we need to define equivalence for sets of paths then we can define what we mean by 
one model being an extension of another.
\begin{definition}
If $\genericmodel$ is a model and if $P$ and $P'$ are sets of paths in $\genericmodel$ then say that
$P \simeq P'$ in $\genericmodel$ iff
\begin{enumerate}
\item for all $p \in P$ there exists $p' \in P'$ such that $p \simeq p'$ in $\genericmodel$,
\item for all $p' \in P'$ there exists $p \in P$ such that $p \simeq p'$ in $\genericmodel$,
\end{enumerate} 
\end{definition}

\begin{definition}
If $\genericmodel$ is a model then say that a model $\genericmodel'$ is an extension of 
$\genericmodel$ iff 
\begin{enumerate}
\item the underlying graph of $\genericmodel'$ is an extension the graph of $\genericmodel$
by edges alone, 
\item each defining instance $E'$ of $\genericmodel'$ when restricted to the graph of $\genericmodel$
is identical to a defining instance of $\genericmodel$,
\item for each defining instance $E$ of $\genericmodel$ there is a defining instance $E'$ of $\genericmodel'$ which when restricted to the graph of $\genericmodel$
is identical to $E$,
\item for all edges $e$ of $\genericmodel'$ that are not in $\genericmodel$ there is a path 
$p$ in $\genericmodel$ such that for all the defining instances $E'$ of $\genericmodel'$,
$E'_e=E'_p$, equivalently, $E'_e=E_p$,
\item for each entity type $a$  then $\pk[\genericmodel]{a} \simeq \pk[\genericmodel']{a}$ in $\genericmodel'$. 
\end{enumerate}
\end{definition}

\begin{definition}
Say that two models are \term{co-extensional}  iff there is a third model that they are both extensions of.
\end{definition}
We consider co-extensional models to be equivalent models. More generally we define the equivalence 
relation between models as the transitive symmetric closure of the extension relation.  

\subsubsection{Composing mono-sources}

In any directed graph a source $i$ at $a$ that includes a path $f:a \morph b$ can be composed with a source $j$ at $b$ by taking the union of paths in $i$ other than $f$, which we shall denote $i\backslash \set{f}$, and the set $\setsuchthat{f \circ g}{g \in j}$ as illustrated here :

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{1.5cm}ccp{1.5cm}ccp{1.25cm}c}
             & &         & \dotnode[dotsize=1pt]{b1} & &        &                              && \pnode{bracehigh}  \\ [0.3cm]
						 & &         & \dotnode[dotsize=1pt]{b2} & &        &                                \\ [0.3cm]
\Rnode{a}{a} & & \vdots  &                           & &        &                                \\ [0.02cm]
						 & &         &                           & &        & \dotnode[dotsize=1pt]{x1}      \\ [0.1cm]
             & &         & \Rnode{b}{b}              & & \vdots &                                \\ [0.1cm]
             & &         &                           & &        & \dotnode[dotsize=1pt]{xn}   && \pnode{bracelow}   \\ [0.5cm]
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){i}	
	&  &         & 
\psbrace[rot=90, nodesepA=-2pt, nodesepB=10pt, braceWidth=1pt, braceWidthInner=3pt](0,0.5)(2.7cm,0.5){j} & & \\
\end{array}
$
\psbrace[rot=0, nodesepA=10pt, braceWidth=1pt, braceWidthInner=3pt, ,ref=lC](bracelow)(bracehigh)
{$(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$}
\simplepatha{}{b}{x1}
\simplepatha{}{b}{xn}
\simplepatha{}{a}{b1}
\simplepatha{}{a}{b2}
%\simplepatha{}{a}{bn}
\simplepathb{$f$}{a}{b}
\end{center}
.

In the next lemma we show that if $j$ is a mono-source then the above composition of $i$ with $j$ though $f$ is a mono-source iff $i$ is a mono-source.

\begin{lemma}
\label{identifyingsetdeduction}

In a model $\genericmodel$, if $i$ is a source with domain $a$,
if $f \in i$, $f: a \morph b$, and if $j$ is a mono-source with domain $b$ then 
$i$ is a mono-source iff $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source.
\end{lemma}
\begin{proof}
First note that from the definition of database instance it follows that 
\begin{equation}
\label{eequivalentsets}
\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}
= \setsuchthat{E_e}{e \in i} \backslash \set{E_f} \cup \setsuchthat{E_f \circ E_g}{g \in j}
\end{equation}

We can show that if $i$ is a mono-source 
then $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source
by showing that for any instance $E$ of $\genericmodel$ the family of functions 
$\setsuchthat{E_e}{e \in (i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}}$
is jointly injective. Because of (\ref{eequivalentsets}) this follows by applying lemma \ref{jointlyinjectivecomposition} with $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$.

\textit{Vice-versa}, we can show that if $(i \backslash \set{f}) \cup \setsuchthat{f \circ g}{g \in j}$ is a mono-source then $i$ is a mono-source by applying lemma \ref{jointlyinjectivefactorisation} 
with, as above, $I$ being $\setsuchthat{E_e}{e \in i}$,
$F$ being $E_f$,  and $G$ being $\setsuchthat{E_g}{g \in j}$ \commentary{can improve this wording instead of repeating the mapping}.
\end{proof}

From lemma \ref{identifyingsetdeduction} it follows that any set of paths arrived at by repeated composition of mono-sources specified for a model $\genericmodel$ in $\setsuchthat{I_a}{a \in \et}$ is itelf a mono-source in $\genericmodel$. Denote by $\bar{I}$ the set  of all such mono-sources.
Denote by $\bar{I}_a$ the subset of $\bar{I}$ comprising all mono-sources in $\bar{I}$ with domain $a$.

\subsubsection{Primary Key Paths and Minimality Condition}
\label{minimalitycondition}
 From this definition it follows that $\pk{a} \in \bar{I}$. From this we get the following corollary.


\begin{corollary}
\label{primarykeycorallary}
If $\genericmodel$ is an entity model then the set $\pk{a}$of all primary key paths 
leaving an entity type $a$ is a mono-source.
\end{corollary}


\begin{definition}
If $P$ and $Q$ are sets of paths of model $\genericmodel$ then say that the set of paths $P$ 
\term{is representative of} $Q$ 
iff $P \simeq Q$ and no proper subset of $P$ is equivalent to $Q$.
\end{definition}

\begin{definition}
A model $\genericmodel$ satisfies \term{the minimality condition} iff for every entity type $a$,
\begin{enumerate}
\item the set $I_a$ is a minimum mono-source i.e. there is no proper subset which is a mono-source,
\item whenever a set of paths $P$ is representative of the set $\pk{a}$  of primary key paths of $\genericmodel$ then no proper subset of $P$ is a mono-source.
\end{enumerate}
\end{definition}

\subsubsection{Primarily Keyed Models}

One of the characteristics of a relational model is that each of the identifying features of a table is a column
and this translates into our unified framework as each identifying edge of each entity type being an attribute i.e. 
an edge with codomain $\veee$. This leads to this definition: 
\begin{definition}
Say that a model is \term{primarily keyed} iff all identifying edges 
have codomain $\veee$.
\end{definition}
To reach the goal of showing that to every ER model there is an equivalent relational model we require the following:
\begin{lemma}
If $\genericmodel$ is an ER model then it can be extended to a model $\genericmodel'$
which is primarily keyed. If $\genericmodel$ satisfies the minimality condition then the
extended model $\genericmodel'$ satisfies the  condition that each $I_a$ has no proper subsets which
are mono-sources. 
\end{lemma}
\begin{proof}
For each entity type $a$ we extend $\genericmodel$ by edges $E_a$, where each edge \commentary{work on this proof. Cannot use this notation.}
$E_a$ corresponds to a distinct primary key path $p$ from $a$ to $\veee$
and in the extended model $\genericmodel'$ by corollary \ref{primarykeycorallary} 
we can define the identifying set $I'_a$ at $a$ to be the set
$E_a$. 
\end{proof}

\subsection{Referential Inclusion Dependencies}
\begin{definition}
If $Q \in \bar{I}_a$ and $Q'$ is representative of $Q$ then $Q'$ is said to be
a \term{primary mono source} at $a$. 
\end{definition}

\begin{definition}
If $\genericmodel$ is an entity model, 
if $a$ and $b$ are entity types of  $\genericmodel$ and  if $\set{q_1,...q_n}$
is a primary mono-source ,
if \fntuple is a tuple of outgoing paths from entity type $a$  
so that we have the following diagram of paths in $\genericmodel$
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}ccp{2cm}c}
             & &         & \Rnode{b1}{b_1} &&               \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} &&               \\ [0.2cm]
\Rnode{a}{a} & &         &                 &&  \Rnode{b}{b} \\ [-0.2cm]						
             & &         &    \vdots       &&               \\ [0.2cm]
             & &         & \Rnode{bn}{b_n} &&               \\ 
\end{array}
$
\simplepatha{$f_1$}{a}{b1}
\simplepatha{$f_2$}{a}{b2}
\simplepathb{$f_n$}{a}{bn}
\simplepathb{$q_1$}{b}{b1}
\simplepathb{$q_2$}{b}{b2}
\simplepatha{$q_n$}{b}{bn}
\end{center}
then say that $a$ represented by $\fntuple$ 
has a \term{referential inclusion dependency} with $b$ represented by $\qntuple$, and for which we shall summarily write:
$$
\incd{a}{f_1,...f_n}{b}{q_1,...q_n},
$$
iff in all instances $E$ of $\genericmodel$,
$img(E_{\fntuple}) \subseteq img(E_{\qntuple})$. 
\end{definition}

If $\qntuple$ is a primary mono-source at $a$ then define $E_{\qntuple}^{-1}$ to be the right inverse of
$E_{\qntuple}$ i.e. the unique partial function such that:
$E_{\qntuple} \circ E_{\qntuple}^{-1} = id_{E_a}$

\begin{definition}
We say that a path $p:a \morph b$ represents a referential inclusion dependency
$\incd{a}{f_1,...f_n}{b}{q_1,...q_n}$  in an ER model $\genericmodel$ iff
  in all instances $E$ of $\genericmodel$, $E_{\fntuple} \circ E_{\qntuple}^{-1}=E_p$.
\end{definition}
We say that a referential inclusion dependency in model $\genericmodel$ is represented in model $\genericmodel$ provided that
there exists a path which represents it. 

\iffalse
\begin{categoricalaside}
If an ER schema is represented as a category with finite products (\textit{a la} Johnstone \textit{et al}) then
a referential inclusion dependency is a diagram
\begin{center}
$
\begin{array}{cp{0.75cm}c}
   \Rnode{a}{a}     & & \Rnode{x}{x}  \\[1.2cm]     
	                  & & \Rnode{b}{b}  
\end{array}
$
\ncarr{a}{x} 
\alabel{f}[0.33]
\ncarr{b}{x}
\blabel{m}[0.3]
\idcomp
\end{center}
\noindent
in \cat{C} such that in all instance functors $F$, 
$F(f)$ factors through $F(m)$.

Such a referential inclusion dependency is explicitly represented iff
 $f$ factors through $m$ i.e. there is an $f_0: a \morph b$ in \cat{C} such that 
$f_0 \circ m =f$. Note that because $m$ is monic then such an $f_0$ is the unique such morphism and if in some instance $F$,
$e: F(a) \morph F(b)$ is a function such that $e \circ F(m) = F(f)$ then $F(f_0)=e$. 
\end{categoricalaside}
\fi

\begin{definition}
Say that an inclusion dependency $\incd{a}{x_1,...x_n}{b}{q_1,...q_n}$ is \textit{simple}
iff each $q_i$ is a singleton path, i.e. is simply an edge. 
\end{definition}

\begin{lemma}
\label{simplerepresentationlemma}
If  $\genericmodel$ is an ER model in which all simple referential inclusion dependencies
have representations then all referential inclusion dependencies have representations. 
\end{lemma}
\begin{proof}
Proof by induction TBD. \commentary{Start by drawing a diagram of the inductive step.} 
\end{proof}

\subsection{Functional Dependencies}

\begin{definition} %functional dependency
In an entity model $\genericmodel$  
if for some $n \geq 1$, $a$, $b_{i}, 1 \leq i \leq n$,  and $c$ are nodes and 
if  $x_{i, 1 \leq i \leq n}$, and $y$ are paths such
that for each $i$, $x_i : a \rightarrow b_i$, and such that $y: a \rightarrow c$ 
as shown here:
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}cc}
             & &         & \Rnode{b1}{b_1} \\ [0.5cm]
						 & &         & \Rnode{b2}{b_2} \\ [0.6cm]
						 & & \vdots  &                 \\ [0.2cm]
\Rnode{a}{a} & &         & \Rnode{bn}{b_n} \\ [1.0cm]
             & &         & \Rnode{c}{c}   \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\end{center}



\noindent 
then path $y$ is said to be \term{functionally dependent} on the set of paths $\{x_1,...x_n\}$ in model $\genericmodel$, 
for which  we write  \sfd{x_1,...x_n}{y},
iff
 in each defining instance $E$ of $\genericmodel$ there exists a  partial 
function $f_E: E_{b_1} \times E_{b_n} \rightarrow E_c$ 
\noindent such that 
domain of $f_E \subseteq img(E_{\tuple{x_1,... x_n }})$ 
and  
$E_{\xntuple} \circ f_E = E_y$ 
\begin{center}
$
\begin{array}{cp{2cm}ccp{0.5cm}cc}
						    & &         & \Rnode{Eb1}{E_{b_1}}& &                            &        \\ [0.6cm]
						    & &         & \Rnode{Eb2}{E_{b_2}}& &                            &        \\ [0.6cm]
						    & &\vdots  &                      & &                            &        \\ [0.2cm]												
\Rnode{Ea}{E_a} & &         & \Rnode{Ebn}{E_{b_n}}& & \Rnode{Jnctn}{}&  \\ [1.0cm]
						    & &         & \Rnode{Ec}{{E_c}}   & &                            &        \\
\end{array}
$
\simplepatha{$E_{x_1}$}{Ea}{Eb1}
\simplepatha{$E_{x_2}$}{Ea}{Eb2}
\simplepatha{$E_{x_n}$}{Ea}{Ebn}
\simplepathb{$E_y$}{Ea}{Ec}
\nchmarr[15][45]{Eb1}{Ebn}{Jnctn}{Ec}
\naput[npos=-0.1]{$f_E$}
\ncarc[arcangle=15]{Eb2}{Jnctn}
\end{center}
\end{definition}

\begin{remark}
In the above definition, if within an instance $E$ there does exist such a partial function $f_E$ then $f_E$ will be the unique such partial function. For if partial function $f'_E$ is another such then given a $\tuple{E_{x_1}(e),...E_{x_n}(e)} \in img(E_{\tuple{x_1,...x_n}})$
we have that $f_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})=E_y(e)=f'_E(\tuple{E_{x_1}(e),...E_{x_n}(e)})$.
\end{remark}

\begin{definition}
A functional dependency \sfd{x_1,...x_n}{y} is said to be \term{trivial} if $y\simeq x_i$, for some $i$, $1 \leq i \leq n$.
\end{definition}

\begin{definition}
In an entity model $\genericmodel$, if
$a$ is an entity type and $\set{x_1,...x_n}$ and $\set{y_1,...y_m}$ are sets of paths with source $a$
then we say the set $\set{y_1,...y_m}$ \textit{is functionally dependent on the set} $\set{x_1,...x_n}$ and write
\fd{x_1,...x_n}{y_1,...y_m} 
iff  each $y_j$, $1 \leq j \leq m$, is functionally dependent on $\set{x_1,...x_n}$.
\end{definition}
\begin{definition} %transitive
In an entity model $\genericmodel$, a functional dependency $\set{x_1,...x_n} \morph z$
is said to be \term{transitive} if there exists a set of paths $\{y_1,...y_{m}\}$ such that
$\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ and $\set{y_1,...y_{m}} \morph z$ but not
$\{y_1,...y_{m}\} \morph \{x_1,...x_n\}$.
\end{definition}
\begin{definition} %intransitive
In an entity model $\genericmodel$, a functional dependency $\set{x_1,...x_n} \morph y$
is said to be \term{intransitive} if it is not transitive.
\end{definition} \commentary{Pause for thought see markups}.
\begin{lemma}
\label{transitiveinjectivelemma}
If $\set{x_1,...x_n} \morph \set{y_1,...y_{m}}$ then if in an instance $E$ the function $E_{\tuple{y_1,...y_{m}}}$ is 
injective then the function $E_{\tuple{x_1,...x_n}}$  is injective. \commentary{change to jointly-injective sets?}
\end{lemma}
\begin{proof}
Follows from the definition of functional dependency that for each $j$, $1 \leq j \leq m$  there is a function ${f_j}$,  such that
$E_{y_j}=E_{\tuple{x_1,...x_n}}\circ f_j$. Therefore there is a function $f=\tuple{f_1,...f_m}$ such that
$E_{\tuple{y_1,...y_m}}= E_{\tuple{x_1,...x_n}}\circ f $. Therefore since  the function $E_{\tuple{y_1,...y_{m}}}$ is 
injective then the function $E_{\tuple{x_1,...x_n}}$  is injective.
\end{proof}


\begin{definition}
\noindent In an entity model $\genericmodel$  
if for some $n \geq 1$, $a$, $b_{i, 1 \leq i \leq n}$,  and $c$ are nodes and 
if  $x_{i}, 1 \leq i \leq n$, and $y$ are paths such
that there is a \commentary{Removed elementary intransitive}functional dependency $\{x_1,...x_n\} \morph y$
 then the functional dependency $\{x_1,...x_n\} \morph y$ is said to be \term{represented} in the ER model $\genericmodel$ iff  there exists an entity type $d$ and a primary mono-source
$\qntuple$  such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_n}$, and a simple
path $z:d\rightarrow c$ as here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{b1}{b_1} & &               \\ [0.7cm]
						 &  & \Rnode{b2}{b_2} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{bn}{b_n} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\simplepathb{$q_1$}{d}{b1}
\simplepathb{$q_2$}{d}{b2}
\simplepathb{$q_n$}{d}{bn}
\simplepatha{$z$}{d}{c}
\end{center}

and such that in all defining instances $E$, 
$\tuple{ E_{x_1},...E_{x_n}} \circ E^{-1}_{\tuple{q_1,...q_n}}\circ E_z = E_y$
\end{definition}
 
\begin{definition}
\noindent An ER model $\genericmodel$ is \term{well-formulated} 
 iff 
\begin{enumerate} [(i)]
\item{
it satisfies the minimality condition (see section \ref{minimalitycondition}),
}
\item{ 
all referential inclusion dependencies\footnote{Equivalently, by lemma
\ref{simplerepresentationlemma}, sufficient that all simple referential inclusion dependencies be represented.} are  represented,
}
\item{
for each intransitive functional dependency $\{x_1,...x_n\} \morph y$ in model $\genericmodel$
either in every defining instance $E$, $E_{\xntuple}$ is injective and total
or else the functional dependency is represented in the model.
}
\item{every transitive functional dependency can be factored through an intransitive functional dependency}
\commentary{This is new from 18 september 2019. Need spell this out.}
\end{enumerate}
\end{definition}


\begin{lemma}
\label{mainlemma}
In a well-formed model $\genericmodel$ if $\{x_1,...x_n\} \morph z$  is a non-trivial
functional dependency then either $E_{\xntuple}$ is injective and total in every defining instance $E$ 
or else there is a non-empty path $p:a \rightarrow d$
and a  path $w:d \morph c$  such that $y \simeq p \circ w$. If $c$ is $\veee$ then
the path $w$ is not equivalent to an identifying path.
\end{lemma}
\begin{proof}
\commentary{this proof currently assuming an intransitive functional dependency.
Now have added to defn. of well-formulated that any functional dependency can be factored 
through such} 
Since the model $\genericmodel$ is well-formulated then the functional dependency $\set{x_1,...x_n} \morph z$ can be factored through an intransitive functional
dependency $\set{y_1,...y_m} \morph z$. 

Since $\genericmodel$ is well formed  and there is an intransitive functional dependency $\set{y_1,...y_m} \morph z$ then either $E_{\ymtuple}$ is injective and total in every defining instance $E$ and therefore by lemma \ref{transitiveinjectivelemma} $E_{\xntuple}$ is injective and total in every defining instance $E$ and we are done or else the the functional dependency
$\set{y_1,...y_m} \morph z$   is represented 
by  an entity type $d$ and 
a primary mono-source $\qntuple$ with respect to
$d$, such that $\incd{a}{x_1,...x_n}{d}{q_1,...q_m}$ and a 
path $w:d\rightarrow c$, for some $l \geq 0$ as here:

\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}c p{2cm} c}
             &  & \Rnode{b1}{b_1} & &               \\ [0.7cm]
						 &  & \Rnode{b2}{b_2} & &               \\ [0.4cm]
						 &  &     \vdots      & &               \\ [0.2cm]
\Rnode{a}{a} &  &                 & & \Rnode{d}{d}  \\ [-0.2cm]
             &  & \Rnode{bm}{b_m} & &               \\ [0.9cm]
             &  & \Rnode{c}{c}    & &               \\
\end{array}
$
\simplepatha{$y_1$}{a}{b1}
\simplepatha{$y_2$}{a}{b2}
\simplepatha{$y_m$}{a}{bm}
\simplepathb{$z$}{a}{c}
\simplepathb{$q_1$}{d}{b1}
\simplepathb{$q_2$}{d}{b2}
\simplepathb{$q_m$}{d}{bm}
\simplepatha{$w$}{d}{c}
\end{center}
such that
\begin{equation}
\label{fundependency}
E_y = E_{\ymtuple} \circ E_{\qmtuple}^{-1} \circ E_w
\end{equation}

Because $\incd{a}{y_1,...y_m}{d}{q_1,...q_m}$,  and from
clause (ii) of the definition of well-formedness since $\genericmodel$ is well formed, it follows that
there  is a simple path $p:a \rightarrow d$ such
that 
%\foreachi, $p \circ q_i \simeq x_i$ and therefore
in all defining instances $E$,

\begin{equation}
\label{incdependency}
E_{\ymtuple} \circ E^{-1}_{\qmtuple} = E_p
\end{equation}
Now we have  that in all defining instances $E$ that 
\begin{align*}
E_y &= E_{\ymtuple} \circ E_{\qmtuple}^{-1} \circ E_w  && \text{ (\ref{fundependency}), above,}\\
    &= E_p \circ E_w                                   && \text{by (\ref{incdependency}),}\\
		&= E_{p \circ w}                                   && \text{from defn. of instance }E.\\
\end{align*} 
\vspace{-0.3cm}
From which, by definition, $y\simeq p \circ w$, as required. \\

\commentary{Now show that if $c=\veee$ then w is not all identifying.}
\end{proof}


\section{Definition Physical Entity Models}\commentary{relational?}
	


\subsection{Definition of Physical ER Model}
\begin{definition}
\noindent 
A \term{physical ER model} is a well formulated ER model that also satisfies:
\begin{enumerate}[(i)]
\item
all identifying edges are attributes, \commentary{the set of sets of identifying edges $I$ is closed under composition i.e. $I = \bar{I}$.}

\item
for each relationship $r$ there is  an inclusion dependency that it represents.\commentary{Dont think this is enough}.
\end{enumerate} 
\end{definition}


\section{First Cut Chen Transformation -- $\chiZero$}

\begin{align}
&\et[\chiZeroM]        && = \et        && \\
&\rel[\chiZeroM]{x}{y} && = \rel{x}{y}  &&\\
&\attr[\chiZeroM]{x}   && = \attr{x}  \cup  \setsuchthat{\tuple{r,k}}{\text{for some }
			                  y \in \et, \ r \in \rel{x}{y} \text{ and } k \in \pk{y}} 
\end{align}

Alternatively, we can define $\attr[\chiZeroM]{x}$ as the union of $\attr{x}$ and foreign keys $\fk{x}$
where we define the latter by:
\begin{equation}
\fk{x} = \setsuchthat{\tuple{r,q_1,...q_n,a}}
                               {r \in \rel{x}{y},
                                  \text{ for some } y \in \et,
																	\text{ and } \tuple{q_1,...q_n,a} \in \pk{y},
																	\text{ for some } n \geq 0
			                   }
\end{equation}

\section{Chi Transform - a Revised Chen Transformation}

First:
\begin{definition}
If $n,m \geq 1$ then say that a simple path $\tuple{r_1,...r_n}$ \textit{is subsumed by} a simple path 
$\tuple{s_0,s_1,...s_m}$ iff $m \geq 1$ and either:
\begin{enumerate} [(i)]

\item $n > 1$ and $\tuple{r_1,...r_n} \simeq  \tuple{s_0,s_1,...s_m}$ and 
\commentary{In most general case this will become not $s_1$ uses $s_2$ ... uses $s_m$.}
for some $j$, $1 \leq j \leq m$, $s_j$ is not an identifying edge. \\
\commentary{Get slightly different subsumes relationship if we say instead
that $\tuple{s_1,...s_m}$ not equivalent to a primary key path. But in context defn. used
achieve the same thing.} 
 \hspace{1cm} or:
\item $n=1$ and $r_1 \simeq \tuple{s_0,s_1,...s_m}$ and $r_1$ is not identifying.
\item $\tuple{r_1,...r_n} <  \tuple{s_0,s_1,...s_m}$ and $r_0 \neq s_0$.
\end{enumerate}
\end{definition}


This then needs revision\footnote{Check this!} as follows:
\begin{multline}
\fkp{x} = \setsuchthat{\tuple{r,q_1,...q_n,a}}
                      {r \in \rel{x}{y},
                                  \text{ for some } y \in \et,
																	\text{ and } \tuple{q_1,...q_n,a} \in \pk{y},
																	\text{ for some } n \geq 0,                   \right. \\        
											\left.		\text{ and } \tuple{r, q_1,...q_n,a}
																	\text{ is not subsumed by any path }
																	      \tuple{s_1,...s_m} \in \path{x}{v}
											}			                   
\end{multline}

Finally we can define:

\begin{equation}
\fkpp{x} = \fkp{x}/\simeq
\end{equation}
and 

\begin{equation}
\attr[\chiM]{x}  = \attr{x}  \cup  \fkpp{x}
\end{equation}


\begin{lemma}
\label{fdcarrythroughlemma}
Functional depedencies in $\genericmodel$ carries through to functional depdencies in $\genericphysical$ \commentary{Expand}
\end{lemma}
\begin{proof}

\end{proof}

\section{Boyce-Codd Normal Form}
\noindent One measure of the goodness of a physical model is whether it satisfies the well-formedness condition know as Boyce Codd Normal Form.
Written in the terminology we are using here it can be defined as follows:
\begin{definition} % BCNF
A physical ER model is in Boyce Codd Normal Form (BCNF) \commentary{See Zaniolo definition 2.} iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  there is a non-trivial functional dependency \sfd{x_1,...x_n}{y}, 
in all instances $E$  of $\genericmodel$, the function $E_{<x_1,...x_n>}$ is injective and total.  
\end{definition}

\begin{definition} % TNF
A physical ER model is in Third Normal Form (TNF)  iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which  there is a non-trivial functional dependency \sfd{x_1,...x_n}{y}, 
in all instances $E$  of $\genericmodel$, either the function $E_{<x_1,...x_n>}$ is injective and total
or else $y$ is all identifying.\commentary{new - justify this}.  
\end{definition}

\noindent The next lemma simplifies the requirement for showing BCNF to consideration of non-trivial
intransitive functional dependencies:
\begin{lemma}
\label{BCNFsublemma}
A model $\genericmodel$ is in BCNF iff
for all entity types $a$, for all attributes $x_1,...x_n$ and $y$ of $a$, for $n \geq 1$, 
for which there is an non trivial intransitive functional dependency \sfd{x_1,...x_n}{y},
in all instances $E$, $E_{<x_1,...x_n>}$ is injective and total. 
\end{lemma}
\begin{proof}Use lemma \ref{transitiveinjectivelemma}.
\end{proof}

\noindent Now for the main theorem:\\
\begin{theorem}
\noindent If an ER model $\genericmodel$ is well-formulated  then the 
transformed model $\logtophys(\genericmodel)$  is in Third Normal Form. If in $\genericmodel$
there are no identifying edges $r$ such that $r \simeq p$ for some path $p$ of length greater than $1$
then $\logtophys(\genericmodel)$ is in Boyce-Codd Normal form.
\end{theorem}
\begin{proof}
By lemma \ref{BCNFsublemma} it suffices to show that if 
$\sfd{\phys{x}_1,...\phys{x}_n}{\phys{y}}$ is a non-trivial intransitive functional dependency of model $\genericphysical$
where $\phys{x}_1,...\phys{x}_n,\phys{y}$ are attributes of the entity type $a$ of model $\genericphysical$ 
then  in all instances
$E$ of $\genericphysical$, $E_{<\phys{x}_1,...\phys{x}_n>}$ is injective and total. \\


\noindent Assume, then, such a functional dependency $\sfd{\phys{x}_1,...\phys{x}_n}{\phys{y}}$ in  $\genericphysical$. 
By lemma \ref{fdcarrythroughlemma} it follows that in the model $\genericmodel$, for each $i$, $1 \leq i \leq n$, 
for some $m_i$, $m_i \geq 1$, we have a 
path of length $m_i$ which we denote $x_i = \tuple{x_{i,1},...x_{i,m_i} }$  and for some $m$, $m \geq 1$ we have a path 
of length $m$ which we denote 
$y=\tuple{y_1,..y_m }$ as shown here: 
\setlength{\arraycolsep}{.2cm}
\begin{center}
$
\begin{array}{cp{2cm}cc}
             & &         & \Rnode{b1}{v} \\ [0.5cm]
						 & &         & \Rnode{b2}{v} \\ [0.6cm]
						 & & \vdots  &                 \\ [0.2cm]
\Rnode{a}{a} & &         & \Rnode{bn}{v} \\ [1.0cm]
             & &         & \Rnode{c}{v}   \\
\end{array}
$
\simplepatha{$x_1$}{a}{b1}
\simplepatha{$x_2$}{a}{b2}
\simplepatha{$x_n$}{a}{bn}
\simplepathb{$y$}{a}{c}
\end{center}
and that \sfd{x_1,...x_n}{y} in $\genericmodel$.

From the assumption that the model $\genericmodel$ is well-formulated 
by lemma \ref{mainlemma} there is a path $\tuple{p_1,...p_k}$
and a path $\tuple{z_1,...z_l}$ not a primary key path such that

\begin{equation}
\label{simpleRepresentation}
 E_{\tuple{p_1,...p_k }} \circ E_{\tuple{z_1,...z_l }} = E_{\tuple{y_1,..y_m }} 
\end{equation}

Either $k=0$ and $\qntuple = \tuple{x_1,...x_n }$ in which case $E_{\tuple{x_1,...x_n }}$ is
injective and total in every instance $E$ of $\genericmodel$ and thus $\logtophys(E)_{\tuple{\phys{x}_1,...\phys{x}_n }}$ is
injective and total in every instance $\logtophys(E)$ of $\genericphysical$ and the proof is complete.
We will show that this leads to a contradiction and so complete the proof. 

If $k \ge 1$ then if $m >1$ then
 from  (\ref{simpleRepresentation}),
from clause (i) of the definition of subsumes and from the fact demonstrated above that $z$ is not equivalent to a 
primary key attribute
it follows that $p_1,...p_k,z_1,...z_l$ subsume $\tuple{y_1,..y_m }$\commentary{CHECK THIS}, 
which implies that $\tuple{y_1,..y_m }$ is excluded from $\fkp{a}$ and thus that 
 $\phys{y}=\left[\tuple{y_1,..y_m }\right]$ is not an attribute of $\genericphysical$ contrary to our 
initial assumption. 

We must conclude that $m=1$.
In this case we have $y_1$, an attribute of $a$ in $\genericmodel$, and from (\ref{simpleRepresentation})  we have in all instances $E$ of $\genericmodel$:
\begin{equation}
E_{y_1}=E_{\tuple{p_1,...p_k }} \circ E_{\tuple{z_1,...z_l }}
\end{equation}
\noindent which is to say that in all instances $E$ of $\genericmodel$:
\begin{equation}
E_{y_1}=E_{\tuple{p_1,...p_k ,z_1,...z_l }}
\end{equation}
\noindent
We have shown, therefore, that $y_1$ is an outgoing edge of $a$ in $\genericmodel$ 
which is equivalent to a simple path of $\genericmodel$ of length $\geq 2$.
Therefore from the defintion of subsumes ,  $y_1$ is identifying as required to establishing TNF
or if we have assumed no such $y_1$ the assumption is contradicted and we establish BCNF.
This completes the proof.
\end{proof}

